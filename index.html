<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora de Turnos 6x2</title>
    <!-- Tailwind CSS CDN para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Estilos esenciales -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        #root { min-height: 100vh; }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        /* Estilo para los inputs de horas extra */
        .extra-input {
            width: 50px;
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid #d1d5db; /* Borde gris */
            text-align: center;
        }
        .extra-input:focus {
            outline: 2px solid #4f46e5; /* Foco Indigo */
            border-color: #4f46e5;
        }
    </style>
</head>
<body>
    <div id="root" class="min-h-screen flex items-center justify-center p-4">
        <!-- Contenido de React se inyecta aqu√≠ -->
    </div>

    <!-- Dependencias (React, Babel, Firebase, jsPDF) CON 'defer' -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin defer></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin defer></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-app.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-auth.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.1/firebase-firestore.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js" defer></script>

    <script type="text/babel" defer>
        // Acceso a las librer√≠as cargadas por CDN
        const { useState, useEffect, useCallback, useMemo } = React;
        const { jsPDF } = window.jspdf;

        // --- CONFIGURACI√ìN DE FIREBASE (¬°DEBES PEGAR TU CLAVE API!) ---
        const firebaseConfig = {
            apiKey: "TU_NUEVA_CLAVE_API_VALIDA_VA_AQUI", // <-- ¬°¬°REEMPLAZA ESTO!!
            authDomain: "calculadora-6x2.firebaseapp.com",
            projectId: "calculadora-6x2",
            storageBucket: "calculadora-6x2.firebasestorage.app",
            messagingSenderId: "238926197886",
            appId: "1:238926197886:web:d05857b007dcb305e9d42f"
        };
        const appId = 'calculadora-6x2';
        
        // Inicializaci√≥n y servicios
        let app, db, auth;

        // --- UTILITIES Y L√ìGICA DE NEGOCIO ---

        const getYesterdayDate = () => {
            const date = new Date();
            date.setDate(date.getDate() - 1);
            return date.toISOString().split('T')[0];
        };

        const getTurnEquivalencies = (dayOfWeek, turnType) => {
            // (L√≥gica de equivalencias de turno base, sin cambios)
            let realHours = 8;
            let equivalentHours = 8; 
            let turnBaseName = turnType;
            
            if (dayOfWeek >= 1 && dayOfWeek <= 5) { // L-V
                switch (turnType) {
                    case 'Ma√±ana':
                    case 'Tarde': equivalentHours = 8; break;
                    case 'Noche': equivalentHours = 12; break; // 8+4
                }
            } else if (dayOfWeek === 6) { // S√°bado
                switch (turnType) {
                    case 'Ma√±ana': realHours = 8; equivalentHours = 9; break; // 8+1
                    case 'Tarde': realHours = 9; equivalentHours = 12; break; // 8+4
                    case 'Noche': realHours = 8; equivalentHours = 16; break; // 8+8
                }
            } else if (dayOfWeek === 0) { // Domingo
                turnBaseName = 'Domingo ' + turnType;
                switch (turnType) {
                    case 'Ma√±ana':
                    case 'Tarde': realHours = 8; equivalentHours = 24; break; // 16+8
                    case 'Noche': realHours = 8; equivalentHours = 28; break; // 20+8
                }
            }
            return { realHours, equivalentHours, turnBaseName };
        };

        // --- COMPONENTES PRINCIPALES ---

        const LoadingSpinner = () => (
            <div className="flex flex-col items-center justify-center h-full">
                <svg className="animate-spin h-8 w-8 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4"></circle>
                    <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <p className="mt-3 text-sm text-gray-600">Conectando...</p>
            </div>
        );

        const AuthScreen = ({ signInWithGoogle }) => (
            <div className="p-8 max-w-sm w-full bg-white shadow-xl rounded-xl text-center">
                <h1 className="text-3xl font-bold text-indigo-700 mb-4">Bienvenido</h1>
                <p className="text-gray-600 mb-8">Inicia sesi√≥n para guardar tu configuraci√≥n y historial.</p>
                <button
                    onClick={signInWithGoogle}
                    className="w-full py-3 px-4 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold transition duration-150 flex items-center justify-center"
                >
                    <svg className="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 24 24"><path d="M22.54 12.06c0-.82-.07-1.62-.2-2.4h-1.32v2.4h-1.32v2.4h1.32v2.4c0 .82.07 1.62.2 2.4h1.32v-2.4h1.32v-2.4h-1.32v-2.4zm-2.4-5.32c.13.82.2 1.62.2 2.4h-1.32v-2.4h1.32v2.4h1.32v-2.4h-1.32V4.34h-1.32v2.4zm-3.26 12.7c-.13-.82-.2-1.62-.2-2.4h-1.32v2.4h1.32v2.4h1.32v-2.4h-1.32v-2.4zm-1.84 0c-.13.82-.2 1.62-.2 2.4h-1.32v-2.4h1.32v2.4h1.32v-2.4h-1.32v-2.4zm-1.84 0c-.13.82-.2 1.62-.2 2.4h-1.32v-2.4h1.32v2.4h1.32v-2.4h-1.32v-2.4zm-1.84 0c-.13.82-.2 1.62-.2 2.4h-1.32v-2.4h1.32v2.4h1.32v-2.4h-1.32v-2.4zm-1.84 0c-.13.82-.2 1.62-.2 2.4h-1.32v-2.4h1.32v2.4h1.32v-2.4h-1.32v-2.4zm-1.84 0c-.13.82-.2 1.62-.2 2.4h-1.32v-2.4h1.32v2.4h1.32v-2.4h-1.32v-2.4z"/></svg>
                    Continuar con Google
                </button>
            </div>
        );


        const App = () => {
            const [user, setUser] = useState(null);
            const [userId, setUserId] = useState(null);
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [config, setConfig] = useState({
                month: new Date().getMonth() + 1,
                year: new Date().getFullYear(),
                valorHora: 3758,
                lastFrancoDate: getYesterdayDate(),
                initialTurn: 'Ma√±ana',
                discountRate: 0.18,
            });
            
            // --- NUEVO ESTADO PARA HORAS EXTRA ---
            // Este objeto almacenar√° las horas extra por fecha. Ej: { "18/11/2025": 4, "20/11/2025": 2 }
            const [extraHours, setExtraHours] = useState({});
            
            const [calculationResult, setCalculationResult] = useState(null); // Almacena el c√°lculo *base*
            const [isLoading, setIsLoading] = useState(false);
            const [status, setStatus] = useState(null);
            
            // 1. Inicializaci√≥n y Autenticaci√≥n (Sin cambios)
            useEffect(() => {
                if (typeof firebase === 'undefined' || typeof firebase.initializeApp !== 'function') {
                    console.error("Firebase library failed to load.");
                    setStatus({ type: 'error', message: "Error cr√≠tico: La librer√≠a de Firebase no se carg√≥." });
                    setIsAuthReady(true);
                    return;
                }

                try {
                    if (!app) {
                        app = firebase.initializeApp(firebaseConfig);
                        db = firebase.firestore();
                        auth = firebase.auth();
                    }
                } catch (e) {
                    console.error("Firebase Initialization Error:", e);
                    setStatus({ type: 'error', message: "Error al inicializar Firebase. Revisa tu API Key." });
                    setIsAuthReady(true);
                    return;
                }

                const unsubscribe = auth.onAuthStateChanged((user) => { 
                    if (user) {
                        setUser(user);
                        setUserId(user.uid);
                    } else {
                        setUser(null);
                        setUserId(null);
                    }
                    setIsAuthReady(true);
                });

                return () => unsubscribe();
            }, []);
            
            // Funci√≥n de Login (Sin cambios, usa Popup)
            const signInWithGoogle = useCallback(async () => {
                if (!auth) return;
                setIsLoading(true);
                setStatus({ type: 'info', message: "Abriendo ventana de Google..." });

                try {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    const result = await auth.signInWithPopup(provider);
                    setStatus({ type: 'success', message: `¬°Bienvenido, ${result.user.displayName}!` });
                } catch (error) {
                    console.error("Google Sign-In Error:", error);
                    if (error.code === 'auth/popup-closed-by-user') {
                        setStatus({ type: 'info', message: "Inicio de sesi√≥n cancelado." });
                    } else if (error.code === 'auth/popup-blocked-by-browser') {
                        setStatus({ type: 'error', message: "El navegador bloque√≥ la ventana emergente." });
                    } else {
                        setStatus({ type: 'error', message: `Fallo en el inicio de sesi√≥n: ${error.code}` });
                    }
                    setIsLoading(false);
                }
            }, []);

            // 2. Carga de Configuraci√≥n del Usuario (Sin cambios)
            useEffect(() => {
                if (!isAuthReady || !userId || !db) return;
                
                setStatus({ type: 'info', message: "Sincronizando configuraci√≥n personal..." });
                const userDocRef = db.collection('artifacts').doc(appId)
                    .collection('users').doc(userId)
                    .collection('config').doc('salary');
                
                const unsubscribe = userDocRef.onSnapshot((docSnap) => {
                    if (docSnap.exists) {
                        const data = docSnap.data();
                        setConfig(prev => ({ ...prev, ...data,
                            valorHora: Number(data.valorHora) || prev.valorHora,
                            discountRate: Number(data.discountRate) || prev.discountRate,
                        }));
                        setStatus({ type: 'success', message: "Configuraci√≥n personal cargada." });
                    } else {
                        setStatus({ type: 'info', message: "Configuraci√≥n no encontrada. Creando..." });
                        saveConfig(config); // Guarda la config inicial si no existe
                    }
                }, (error) => {
                    console.error("Error fetching config:", error);
                    setStatus({ type: 'error', message: "Error al cargar configuraci√≥n. Revisa tus Reglas de Seguridad." });
                });

                return () => unsubscribe();
            }, [isAuthReady, userId]);

            // --- NUEVO: Carga de Horas Extra del Mes ---
            useEffect(() => {
                if (!isAuthReady || !userId || !db) return;

                // Genera un ID de documento para el mes actual, ej: "2025-11"
                const monthDocId = `${config.year}-${String(config.month).padStart(2, '0')}`;
                
                const extrasDocRef = db.collection('artifacts').doc(appId)
                                      .collection('users').doc(userId)
                                      .collection('data').doc(monthDocId); // Nueva colecci√≥n 'data'

                const unsubscribe = extrasDocRef.onSnapshot((docSnap) => {
                    if (docSnap.exists()) {
                        setExtraHours(docSnap.data().extras || {});
                    } else {
                        setExtraHours({}); // No hay extras guardadas para este mes
                    }
                }, (error) => {
                    console.error("Error fetching extras:", error);
                    setStatus({ type: 'error', message: "Error al cargar horas extra. Revisa tus Reglas de Seguridad." });
                });

                return () => unsubscribe();
            }, [isAuthReady, userId, config.year, config.month]); // Se re-ejecuta si cambia el mes/a√±o


            // 3. Guardar Configuraci√≥n (Sin cambios)
            const saveConfig = useCallback((newConfig) => {
                if (!isAuthReady || !userId || !db) return;
                
                const userDocRef = db.collection('artifacts').doc(appId)
                    .collection('users').doc(userId)
                    .collection('config').doc('salary');

                userDocRef.set({ ...newConfig, 
                    valorHora: Number(newConfig.valorHora), 
                    discountRate: Number(newConfig.discountRate) 
                }, { merge: true })
                    .catch(error => {
                        console.error("Error saving config:", error);
                        setStatus({ type: 'error', message: "Error al guardar configuraci√≥n." });
                    });
            }, [isAuthReady, userId]);

            // 4. Manejador de Cambios de Formulario (Sin cambios)
            const handleChange = (e) => {
                const { name, value, type } = e.target;
                const newValue = (type === 'number' || name === 'valorHora' || name === 'discountRate') ? parseFloat(value) : value;

                setConfig(prev => {
                    const updatedConfig = { ...prev, [name]: newValue };
                    saveConfig(updatedConfig); 
                    return updatedConfig;
                });
            };

            // --- NUEVO: Manejador para guardar Horas Extra ---
            const handleExtraChange = (dateString, hours) => {
                const newHours = parseFloat(hours) || 0;
                
                // 1. Actualiza el estado local inmediatamente para UI r√°pida
                const newExtras = { ...extraHours, [dateString]: newHours };
                setExtraHours(newExtras);

                // 2. Guarda en Firestore (Debounced/Throttled en un app real, pero aqu√≠ directo)
                if (!isAuthReady || !userId || !db) return;
                
                const monthDocId = `${config.year}-${String(config.month).padStart(2, '0')}`;
                const extrasDocRef = db.collection('artifacts').doc(appId)
                                      .collection('users').doc(userId)
                                      .collection('data').doc(monthDocId);
                
                // Usamos set con merge:true para guardar solo el mapa de 'extras'
                extrasDocRef.set({ extras: newExtras }, { merge: true })
                    .catch(error => {
                        console.error("Error saving extras:", error);
                        setStatus({ type: 'error', message: "Error al guardar horas extra." });
                    });
            };

            // 5. C√°lculo *Base* del Horario (Se dispara con el bot√≥n)
            const calculateSchedule = useCallback(() => {
                // (Esta funci√≥n ahora solo calcula el *base*, sin extras)
                if (!isAuthReady) {
                    setStatus({ type: 'error', message: "Autenticaci√≥n no lista." });
                    return;
                }
                const { month, year, lastFrancoDate, initialTurn } = config;
                
                setIsLoading(true);
                setStatus({ type: 'info', message: "Calculando horario base..." });

                let currentDate = new Date(year, month - 1, 1, 0, 0, 0);
                const lastFrancoDay2 = new Date(lastFrancoDate + 'T00:00:00');
                const dayAfterFranco = new Date(lastFrancoDay2.getTime());
                dayAfterFranco.setDate(dayAfterFranco.getDate() + 1);
                
                const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                let dailyResults = [];
                let francosDates = [];
                
                const masterCycle = [
                    'Ma√±ana', 'Ma√±ana', 'Ma√±ana', 'Ma√±ana', 'Ma√±ana', 'Ma√±ana', 'Franco', 'Franco', 
                    'Noche', 'Noche', 'Noche', 'Noche', 'Noche', 'Noche', 'Franco', 'Franco', 
                    'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Franco', 'Franco'
                ];
                
                let baseOffset = 0;
                if (initialTurn === 'Noche') baseOffset = 8;
                else if (initialTurn === 'Tarde') baseOffset = 16;
                
                const diffTime = currentDate.getTime() - dayAfterFranco.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                let startOffset = (baseOffset + diffDays) % 24; 
                if (startOffset < 0) startOffset += 24; 

                let dayCounter = 0;
                while (currentDate.getMonth() === month - 1 && dayCounter < 31) {
                    const dayOfWeek = currentDate.getDay(); 
                    const dateString = currentDate.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    const cycleStatus = masterCycle[startOffset]; 
                    
                    let turnBaseName = cycleStatus;
                    let realHours = 0;
                    let equivalentHours = 0;
                    
                    if (cycleStatus === 'Franco') {
                        francosDates.push(dateString);
                    } else {
                        const equivalences = getTurnEquivalencies(dayOfWeek, cycleStatus);
                        realHours = equivalences.realHours;
                        equivalentHours = equivalences.equivalentHours;
                        turnBaseName = equivalences.turnBaseName;
                    }
                    
                    dailyResults.push({
                        date: dateString,
                        day: dayNames[dayOfWeek],
                        turn: turnBaseName,
                        realHours: realHours,
                        equivHoursBase: equivalentHours, // Horas base
                    });
                    
                    startOffset = (startOffset + 1) % 24;
                    currentDate.setDate(currentDate.getDate() + 1);
                    dayCounter++;
                }

                setCalculationResult({ dailyResults, francosDates }); // Guarda el c√°lculo *base*
                setIsLoading(false);
                setStatus({ type: 'success', message: `Horario base de ${dailyResults.length} d√≠as generado.` });
                
            }, [config, isAuthReady]);
            
            // --- NUEVO: C√°lculo Final (Derivado) con Horas Extra ---
            // Este useMemo recalcula el total CADA VEZ que el c√°lculo base O las horas extra cambian.
            const finalCalculationResult = useMemo(() => {
                if (!calculationResult) return null;

                // Regla de Horas Extra (de image_2c0980.png): 4hs reales = 6hs equivalentes -> 50% extra
                const extraHourMultiplier = 1.5; // 1 hora real extra vale 1.5 horas equivalentes
                
                let totalEquivalentHours = 0;
                const hourlyRate = parseFloat(config.valorHora) || 0;

                const finalDailyResults = calculationResult.dailyResults.map(day => {
                    const dayExtraReal = extraHours[day.date] || 0;
                    
                    // Solo calcula extras si no es franco
                    const dayExtraEquivalent = (day.turn !== 'Franco' && dayExtraReal > 0)
                        ? (dayExtraReal * extraHourMultiplier)
                        : 0;

                    const finalEquivHours = day.equivHoursBase + dayExtraEquivalent;
                    const finalDailyBruto = finalEquivHours * hourlyRate;

                    totalEquivalentHours += finalEquivHours;

                    return {
                        ...day,
                        extraReal: dayExtraReal, // Para el input
                        extraEquiv: dayExtraEquivalent, // Para mostrar
                        equivHoursFinal: finalEquivHours, // Total del d√≠a
                        dailyBruto: finalDailyBruto, // Total del d√≠a
                    };
                });

                // Recalcular resumen financiero
                const totalBruto = totalEquivalentHours * hourlyRate;
                const totalDescuento = totalBruto * config.discountRate;
                const totalNeto = totalBruto - totalDescuento;

                return {
                    ...calculationResult,
                    dailyResults: finalDailyResults,
                    totalEquivalentHours,
                    totalBruto,
                    totalDescuento,
                    totalNeto,
                    discountRate: config.discountRate * 100,
                };

            }, [calculationResult, extraHours, config.valorHora, config.discountRate]); // Dependencias
            
            
            const formatCurrency = (amount) => {
                return amount.toLocaleString('es-AR', { style: 'currency', currency: 'ARS' });
            };

            // --- PDF ACTUALIZADO ---
            const generatePdf = () => {
                // El PDF ahora usa el 'finalCalculationResult'
                if (!finalCalculationResult) {
                    setStatus({ type: 'error', message: "Primero debes generar el c√°lculo." });
                    return;
                }

                const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
                const { totalBruto, totalDescuento, totalNeto, discountRate, dailyResults } = finalCalculationResult;
                const monthName = new Date(config.year, config.month - 1).toLocaleDateString('es-AR', { month: 'long', year: 'numeric' });

                // T√≠tulo y Resumen (Sin cambios)
                doc.setFontSize(18); doc.text(`REPORTE SALARIAL MENSUAL`, 105, 15, null, null, 'center');
                doc.setFontSize(12); doc.text(`C√°lculo para ${monthName}`, 105, 22, null, null, 'center');
                doc.setFillColor(240, 240, 240); doc.rect(15, 30, 180, 40, 'F'); 
                doc.setFontSize(10); doc.text('RESUMEN', 17, 35);
                doc.setFontSize(12); doc.text('BRUTO TOTAL:', 20, 42); doc.text(formatCurrency(totalBruto), 190, 42, null, null, 'right');
                doc.text(`DESCUENTO (${discountRate.toFixed(0)}%):`, 20, 50);
                doc.setTextColor(217, 48, 37); doc.text(`- ${formatCurrency(totalDescuento)}`, 190, 50, null, null, 'right');
                doc.setTextColor(0, 0, 0); 
                doc.setFontSize(14); doc.setFont('helvetica', 'bold');
                doc.setFillColor(217, 234, 211); doc.rect(15, 58, 180, 10, 'F');
                doc.text('NETO (EN MANO):', 20, 65); doc.text(formatCurrency(totalNeto), 190, 65, null, null, 'right');
                doc.setFont('helvetica', 'normal'); doc.setFontSize(10); doc.text(`Usuario: ${user.email}`, 15, 75);

                // Detalle Diario (Tabla) - ¬°ACTUALIZADO!
                doc.setFontSize(12); doc.text('Detalle Diario (Horas y Equivalencias)', 15, 85);
                
                const tableColumns = ["Fecha", "D√≠a", "Turno Base", "H. Base", "H. Extra", "H. Eq. Total", "Monto Bruto"];
                const tableRows = dailyResults.map(r => [
                    r.date,
                    r.day,
                    r.turn,
                    r.equivHoursBase || '-',
                    r.extraReal || '-', // Nueva columna de Extras
                    r.equivHoursFinal || '-',
                    r.dailyBruto ? formatCurrency(r.dailyBruto) : '-',
                ]);

                doc.autoTable({
                    startY: 90, head: [tableColumns], body: tableRows, theme: 'grid',
                    styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
                    headStyles: { fillColor: [207, 226, 243] }, 
                    columnStyles: {
                        0: { cellWidth: 18 }, 
                        3: { cellWidth: 15, halign: 'center' }, 
                        4: { cellWidth: 15, halign: 'center' }, // Columna Extra
                        5: { cellWidth: 15, halign: 'center' }, 
                        6: { halign: 'right' }, 
                    },
                    bodyStyles: (data) => (data.row.raw[2].includes('Franco') ? { fillColor: [255, 242, 204] } : {})
                });

                doc.setFontSize(8); doc.text("Generado por la Calculadora de Rotaci√≥n 6x2.", 105, doc.internal.pageSize.height - 10, null, null, 'center');
                doc.save(`Reporte_Salarial_${monthName}.pdf`);
                setStatus({ type: 'success', message: "PDF generado con √©xito y descargado." });
            };

            const StatusMessage = ({ type, message }) => {
                if (!message) return null;
                const baseClass = "p-3 rounded-lg mt-4 font-semibold text-sm";
                let colorClass = "";
                switch (type) {
                    case 'success': colorClass = "bg-green-100 text-green-700"; break;
                    case 'error': colorClass = "bg-red-100 text-red-700"; break;
                    case 'info': colorClass = "bg-blue-100 text-blue-700"; break;
                    default: colorClass = "bg-gray-100 text-gray-700"; break;
                }
                return <div className={`${baseClass} ${colorClass}`}>{message}</div>;
            };

            // 5. Renderizado Principal
            if (!isAuthReady) {
                return <div className="p-4 w-full h-full"><LoadingSpinner /></div>;
            }
            
            if (!user) {
                 return <AuthScreen signInWithGoogle={signInWithGoogle} />;
            }

            // --- VISTA PRINCIPAL DE LA APP (LOGUEADO) ---
            // Usamos 'finalCalculationResult' para mostrar los totales
            const resultToShow = finalCalculationResult || calculationResult;

            return (
                <div className="p-4 md:p-6 max-w-4xl w-full bg-white shadow-xl rounded-xl">
                    <div className="flex justify-between items-center border-b pb-2 mb-4">
                        <h1 className="text-2xl font-bold text-indigo-700">
                            Calculadora 6x2 (v2)
                        </h1>
                        <button onClick={() => auth.signOut()} className="text-sm text-red-600 hover:text-red-800 font-semibold transition duration-150">
                            Cerrar Sesi√≥n
                        </button>
                    </div>

                    <div className="text-sm mb-4 p-2 bg-indigo-50 rounded-lg">
                        <p className="font-medium text-indigo-600">
                            Usuario: {user.email}
                        </p>
                        <p className="text-xs text-indigo-500">Tu configuraci√≥n y horas extra se guardan autom√°ticamente en la nube.</p>
                    </div>
                    
                    {/* --- Panel de Configuraci√≥n --- */}
                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-700">Mes a Calcular</label>
                            <select name="month" value={config.month} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                {Array.from({ length: 12 }, (_, i) => i + 1).map(m => (
                                    <option key={m} value={m}>{new Date(config.year, m - 1).toLocaleDateString('es-AR', { month: 'long' })}</option>
                                ))}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium text-gray-700">A√±o</label>
                            <input type="number" name="year" value={config.year} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" />
                        </div>
                        <div className="col-span-2 md:col-span-1">
                            <label className="block text-sm font-medium text-gray-700">Valor Hora Bruta ($)</label>
                            <input type="number" name="valorHora" value={config.valorHora} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" />
                        </div>
                        <div className="col-span-2 md:col-span-1">
                            <label className="block text-sm font-medium text-gray-700">Afiliaci√≥n (Desc.)</label>
                            <select name="discountRate" value={config.discountRate} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                <option value={0.18}>No Afiliado (18%)</option>
                                <option value={0.21}>Afiliado (21%)</option>
                            </select>
                        </div>
                        <div className="col-span-2">
                            <label className="block text-sm font-medium text-gray-700">Fecha del √öltimo Franco (D√≠a 2)</label>
                            <input type="date" name="lastFrancoDate" value={config.lastFrancoDate} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" />
                        </div>
                        <div className="col-span-2">
                            <label className="block text-sm font-medium text-gray-700">Turno Post-Franco</label>
                            <select name="initialTurn" value={config.initialTurn} onChange={handleChange} className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border">
                                <option value="Ma√±ana">Ma√±ana</option>
                                <option value="Noche">Noche</option>
                                <option value="Tarde">Tarde</option>
                            </select>
                        </div>
                    </div>

                    <button 
                        onClick={calculateSchedule} 
                        disabled={isLoading}
                        className={`w-full py-2 mt-2 rounded-lg text-white font-bold transition duration-150 ${isLoading ? 'bg-indigo-400' : 'bg-indigo-600 hover:bg-indigo-700'}`}
                    >
                        {isLoading ? 'Calculando...' : 'Generar/Actualizar Horario Base'}
                    </button>
                    
                    <StatusMessage type={status?.type} message={status?.message} />

                    {/* --- Secci√≥n de Resultados (Usa 'finalCalculationResult') --- */}
                    {resultToShow && (
                        <div className="mt-6 border-t pt-4">
                            <h2 className="text-xl font-bold text-indigo-700 mb-4">Resumen de Ganancias (Neto Recalculado)</h2>
                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm font-medium">
                                <div className="p-3 bg-gray-50 rounded-lg">
                                    <p className="text-gray-500">H. Eq. Totales</p>
                                    <p className="text-lg text-gray-900 font-extrabold">{resultToShow.totalEquivalentHours.toFixed(2)}</p>
                                </div>
                                <div className="p-3 bg-red-50 rounded-lg">
                                    <p className="text-gray-500">Descuento ({resultToShow.discountRate.toFixed(0)}%)</p>
                                    <p className="text-lg text-red-600 font-extrabold">{formatCurrency(resultToShow.totalDescuento)}</p>
                                </div>
                                <div className="col-span-1 p-3 bg-indigo-50 rounded-lg">
                                    <p className="text-gray-500">Bruto Total</p>
                                    <p className="text-xl text-indigo-600 font-extrabold">{formatCurrency(resultToShow.totalBruto)}</p>
                                </div>
                                <div className="col-span-1 p-3 bg-green-100 rounded-lg shadow-md">
                                    <p className="text-green-700 font-semibold">NETO (EN MANO)</p>
                                    <p className="text-2xl text-green-800 font-extrabold">{formatCurrency(resultToShow.totalNeto)}</p>
                                </div>
                            </div>

                            <div className="mt-4 p-3 bg-yellow-50 rounded-lg text-sm">
                                <strong className="text-yellow-800">üóìÔ∏è Francos del Mes:</strong>
                                <p className="mt-1 text-yellow-700">{resultToShow.francosDates.join(', ') || 'No hay francos.'}</p>
                            </div>

                            <button 
                                onClick={generatePdf}
                                className="w-full py-2 mt-4 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold transition duration-150 flex items-center justify-center"
                            >
                                <svg className="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                Descargar Reporte PDF (con Extras)
                            </button>
                            
                            {/* --- TABLA DE DETALLE DIARIO (AHORA VISIBLE) --- */}
                            <div className="mt-4 border-t pt-4">
                                 <h3 className="text-lg font-bold text-gray-800 mb-2">Detalle Diario y Carga de Horas Extra</h3>
                                <div className="overflow-x-auto" style={{ maxHeight: '400px', overflowY: 'auto' }}>
                                    <table className="min-w-full divide-y divide-gray-200 text-xs">
                                        <thead className="bg-gray-100 sticky top-0">
                                            <tr>
                                                <th className="px-3 py-2 text-left text-gray-500">Fecha</th>
                                                <th className="px-3 py-2 text-left text-gray-500">Turno</th>
                                                <th className="px-3 py-2 text-right text-gray-500">H. Eq. Base</th>
                                                <th className="px-3 py-2 text-center text-gray-500">H. Extra (Reales)</th>
                                                <th className="px-3 py-2 text-right text-gray-500">H. Eq. Total</th>
                                                <th className="px-3 py-2 text-right text-gray-500">Monto Bruto</th>
                                            </tr>
                                        </thead>
                                        <tbody className="bg-white divide-y divide-gray-200">
                                            {resultToShow.dailyResults.map((day) => (
                                                <tr key={day.date} className={day.turn.includes('Franco') ? 'bg-yellow-50' : 'hover:bg-gray-50'}>
                                                    <td className="px-3 py-2 whitespace-nowrap">{day.date} ({day.day.substring(0, 3)})</td>
                                                    <td className="px-3 py-2 whitespace-nowrap font-medium text-indigo-600">{day.turn}</td>
                                                    <td className="px-3 py-2 whitespace-nowrap text-right">{day.equivHoursBase.toFixed(2)}</td>
                                                    <td className="px-3 py-2 whitespace-nowrap text-center">
                                                        {day.turn !== 'Franco' ? (
                                                            <input 
                                                                type="number" 
                                                                className="extra-input"
                                                                min="0"
                                                                step="0.5"
                                                                placeholder="0"
                                                                // Usamos 'key' para resetear el valor no controlado si el mes cambia
                                                                key={day.date} 
                                                                defaultValue={extraHours[day.date] || ''}
                                                                // Guardamos al desenfocar (onBlur) para no saturar Firestore
                                                                onBlur={(e) => handleExtraChange(day.date, e.target.value)} 
                                                            />
                                                        ) : '---'}
                                                    </td>
                                                    <td className="px-3 py-2 whitespace-nowrap text-right font-bold">{day.equivHoursFinal.toFixed(2)}</td>
                                                    <td className="px-3 py-2 whitespace-nowrap text-right font-bold text-green-700">{formatCurrency(day.dailyBruto)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // Renderizar la aplicaci√≥n
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
