<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Salarial 6x2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuraciones de fuente */
        @import url('https://fonts.fonts.google.com/specimen/Inter');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .input-style {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            width: 100%;
            transition: border-color 0.15s;
        }
        .input-style:focus {
            border-color: #4f46e5;
            outline: none;
            ring: 2px;
            ring-color: #6366f1;
        }
        /* Estilo para la tabla pegajosa */
        .sticky-header th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f9fafb; /* Fondo para que se vea bien */
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

</head>
<body class="min-h-screen flex items-start justify-center p-4">

    <div id="app-container" class="w-full max-w-5xl bg-white rounded-xl card p-6 md:p-8 mt-4">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-2 mb-4">
            <h1 class="text-2xl font-bold text-indigo-700">
                Calculadora Salarial 6x2
            </h1>
            <div id="auth-controls" class="flex space-x-2 mt-2 md:mt-0 items-center">
                <div id="user-info" class="text-sm text-gray-600">Cargando...</div>
                <button id="google-login-btn" class="flex items-center px-3 py-1 bg-blue-600 text-white text-sm font-semibold rounded-lg shadow hover:bg-blue-700 transition duration-150">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M44.5 20H24v8.5h11.8c-.7 4.3-3.6 7.9-7.9 10.1v7H44c.4-3.4 2.8-6.4 5.9-8.5v-2c-3-2.1-5.4-5.1-5.9-8.5z" fill="#4285F4"/><path d="M24 44.5h20.5v-7h-7c-2.3 2.1-5 3.7-7.7 4.7v2.3c3 0 5.8-.8 8.1-2.2v-2z" fill="#34A853"/><path d="M24 3.5V11H4v7h20v8.5h-11.8c.7 4.3 3.6 7.9 7.9 10.1v7c-8.9-3.2-14.9-12-14.9-22.6C9.1 12 14.1 6.5 24 3.5z" fill="#FBBC05"/><path d="M24 3.5V11h20v-7H24z" fill="#EA4335"/></svg>
                    Google
                </button>
                <button id="logout-btn" class="hidden px-3 py-1 bg-gray-500 text-white text-sm font-semibold rounded-lg shadow hover:bg-gray-600 transition duration-150">
                    Salir
                </button>
            </div>
        </div>
       
        <div id="status-message" class="hidden p-3 rounded-lg mt-4 font-semibold text-sm"></div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
            <div>
                <label class="block text-sm font-medium text-gray-700">Tu Nombre</label>
                <input id="input-name" type="text" name="name" class="input-style" onchange="handleConfigChange()" value="Usuario Temporal">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Mes</label>
                <select id="input-month" name="month" class="input-style" onchange="handleConfigChange()">
                    </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Año</label>
                <input id="input-year" type="number" name="year" class="input-style" onchange="handleConfigChange()">
            </div>
            <div class="col-span-2 md:col-span-1">
                <label class="block text-sm font-medium text-gray-700">Valor Hora Bruta ($)</label>
                <input id="input-valorHora" type="number" name="valorHora" class="input-style" onchange="handleConfigChange()" step="0.01">
            </div>
            <div class="col-span-2 md:col-span-1">
                <label class="block text-sm font-medium text-gray-700">Desc. Afiliación</label>
                <select id="input-discountRate" name="discountRate" class="input-style" onchange="handleConfigChange()">
                    <option value="0.18">No Afiliado (18%)</option>
                    <option value="0.21">Afiliado (21%)</option>
                </select>
            </div>
            <div class="col-span-2 md:col-span-1">
                <label class="block text-sm font-medium text-gray-700">Viático por Día Extra ($)</label>
                <input id="input-viaticoValue" type="number" name="viaticoValue" class="input-style" onchange="handleConfigChange()" step="100">
            </div>
            <div class="col-span-2 md:col-span-1">
                <label class="block text-sm font-medium text-gray-700">Monto Título ($)</label>
                <input id="input-titleValue" type="number" name="titleValue" class="input-style" onchange="handleConfigChange()" step="100">
            </div>
            <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700">Fecha del Último Franco (Día 2)</label>
                <input id="input-lastFrancoDate" type="date" name="lastFrancoDate" class="input-style" onchange="handleConfigChange()">
            </div>
            <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700">Turno Post-Franco</label>
                <select id="input-initialTurn" name="initialTurn" class="input-style" onchange="handleConfigChange()">
                    <option value="Mañana">Mañana</option>
                    <option value="Noche">Noche</option>
                    <option value="Tarde">Tarde</option>
                </select>
            </div>
        </div>

        <button id="calculate-schedule-button" class="w-full py-3 mt-2 rounded-lg text-white font-bold transition duration-150 bg-indigo-700 hover:bg-indigo-800">
            Generar/Actualizar Horario y Calcular Salario
        </button>

        <div id="results-section" class="hidden mt-6 border-t pt-6">
            
            <h2 class="text-xl font-bold text-indigo-700 mb-4">Dashboard Personal del Mes</h2>
            <div id="personal-dashboard" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm font-medium mb-6 p-2 bg-white border rounded-xl">
                </div>

            <h2 class="text-xl font-bold text-indigo-700 mb-4 mt-6">Resumen de Ganancias del Mes</h2>
            <div id="monthly-totals-container">
                </div>
            
            <div id="francos-info" class="p-3 bg-yellow-50 rounded-lg text-sm mb-4">
                </div>

            <button id="generate-pdf-button" class="w-full py-2 mb-6 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold transition duration-150 flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Descargar Reporte PDF
            </button>
           
            <h3 class="text-lg font-bold text-gray-800 mb-3 border-t pt-4">Dashboard Mensual & Comparaciones</h3>
            <div id="monthly-dashboard-container" class="p-4 bg-gray-50 rounded-lg mb-6">
                <p class="text-sm text-gray-700 font-semibold mb-2">Meses Calculados:</p>
                <div id="history-buttons" class="flex flex-wrap gap-2 mb-4">
                    <p id="history-loading" class="text-xs text-gray-500">Cargando historial...</p>
                </div>
                <p class="text-sm text-gray-700 font-semibold mb-2 mt-4">Ranking de Ganancias (Neto):</p>
                <div id="comparison-table" class="bg-white p-3 rounded border text-xs">
                    <p id="comparison-placeholder" class="text-xs text-gray-500">Se requiere cargar el historial para generar el ranking.</p>
                </div>
            </div>
           
            <h3 class="text-lg font-bold text-gray-800 mb-3 border-t pt-4">Detalle Diario, Feriados y Horas Extra</h3>
            <p class="text-xs text-red-600 mb-3">
                ⚠️ Marca la casilla "Es Feriado" para aplicar la equivalencia de **32 Horas** (si trabajas) o **8 Horas** (si es Franco).
            </p>
            <div id="daily-detail-table-container" class="overflow-x-auto rounded-lg border" style="max-height: 400px; overflow-y: auto;">
                <table id="daily-detail-table" class="min-w-full divide-y divide-gray-200 text-xs">
                    <thead class="bg-gray-100 sticky-header">
                        <tr>
                            <th class="px-3 py-2 text-left text-gray-500">Fecha</th>
                            <th class="px-3 py-2 text-left text-gray-500">Turno</th>
                            <th class="px-3 py-2 text-center text-gray-500">Es Feriado</th>
                            <th class="px-3 py-2 text-right text-gray-500">H. Eq. Base</th>
                            <th class="px-3 py-2 text-center text-gray-500">H. Extra (Reales)</th>
                            <th class="px-3 py-2 text-right text-gray-500">H. Eq. Total</th>
                            <th class="px-3 py-2 text-right text-gray-500">Monto Bruto</th>
                        </tr>
                    </thead>
                    <tbody id="daily-detail-tbody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <script type="module">
        // =====================================================================
        // CONFIGURACIÓN DE FIREBASE (INTEGRADO DIRECTAMENTE)
        // =====================================================================
       
        // ** CONFIGURACIÓN PROPORCIONADA POR EL USUARIO **
        const HARDCODED_FIREBASE_CONFIG = {
            apiKey: "AIzaSyC_gewonkD_XnzQmwmUnQuhfzOf5zdm9lw",
            authDomain: "calculadora-6x2.firebaseapp.com",
            projectId: "calculadora-6x2",
            storageBucket: "calculadora-6x2.firebasestorage.app",
            messagingSenderId: "238926197886",
            appId: "1:238926197886:web:d05857b007dcb305e9d42f"
        };
       
        // =====================================================================
        // CONFIGURACIÓN, CONSTANTES Y ESTADO GLOBAL
        // =====================================================================

        // Constantes de negocio
        const EXTRA_HOUR_MULTIPLIER = 1.5;
        const HOLIDAY_WORKED_EQUIV_HOURS = 32;
        const HOLIDAY_FREE_EQUIV_HOURS = 8;
       
        // Variables de entorno de Canvas (se usan para identificación del entorno)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
       
        // Instancias de Firebase y Estado de Autenticación
        let app;
        let auth;
        let db;
        let userId = null;
        let userName = 'Usuario Temporal';
        let isAuthReady = false;
        let isFirebaseActive = true;
       
        // Estado Global de la Aplicación (Simulando React state)
        let appState = {
            config: {
                month: new Date().getDate() === 1 ? new Date().getMonth() : new Date().getMonth() + 1,
                year: new Date().getFullYear(),
                valorHora: 3758,
                lastFrancoDate: getYesterdayDate(),
                initialTurn: 'Mañana',
                discountRate: 0.18,
                // NUEVOS CAMPOS DE CONFIGURACIÓN
                name: 'Usuario Temporal',
                viaticoValue: 6200,
                titleValue: 0,
            },
            extraHours: {},
            manualHolidays: {},
            calculationResult: null,
            isLoading: false,
            status: null,
            history: [], // NUEVO: Historial de cálculos de meses
        };

        // Elementos del DOM
        const statusEl = document.getElementById('status-message');
        const personalDashboardEl = document.getElementById('personal-dashboard'); // NUEVO ID
        const monthlyTotalsContainerEl = document.getElementById('monthly-totals-container'); // NUEVO ID
        const francosInfoEl = document.getElementById('francos-info');
        const tbodyEl = document.getElementById('daily-detail-tbody');
        const resultsSectionEl = document.getElementById('results-section');
        const calculateButtonEl = document.getElementById('calculate-schedule-button');
        const generatePdfButtonEl = document.getElementById('generate-pdf-button');
        const userInfoEl = document.getElementById('user-info');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const historyButtonsEl = document.getElementById('history-buttons'); // NUEVO
        const comparisonTableEl = document.getElementById('comparison-table'); // NUEVO
        const historyLoadingEl = document.getElementById('history-loading'); // NUEVO

        // =====================================================================
        // UTILIDADES Y AYUDANTES DE UI
        // =====================================================================

        function getYesterdayDate() {
            const date = new Date();
            date.setDate(date.getDate() - 1);
            return formatDateForInput(date);
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDateForDisplay(date) {
            return date.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatCurrency(amount) {
            const number = parseFloat(amount) || 0;
            return number.toLocaleString('es-AR', { style: 'currency', currency: 'ARS' });
        }
       
        function formatNumber(amount, decimals = 2) {
             const number = parseFloat(amount) || 0;
             return number.toLocaleString('es-AR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }

        function getTurnEquivalencies(dayOfWeek, turnType) {
            let realHours = 8;
            let equivalentHours = 8;
            let turnBaseName = turnType;
           
            if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Lunes a Viernes
                switch (turnType) {
                    case 'Mañana':
                    case 'Tarde': equivalentHours = 8; break;
                    case 'Noche': equivalentHours = 12; break; // Recargo Nocturno
                }
            } else if (dayOfWeek === 6) { // Sábado
                switch (turnType) {
                    case 'Mañana': realHours = 8; equivalentHours = 9; break;
                    case 'Tarde': realHours = 9; equivalentHours = 12; break;
                    case 'Noche': realHours = 8; equivalentHours = 16; break;
                }
            } else if (dayOfWeek === 0) { // Domingo
                turnBaseName = 'Domingo ' + turnType;
                switch (turnType) {
                    case 'Mañana':
                    case 'Tarde': realHours = 8; equivalentHours = 24; break; // Recargo Dominical (Triple)
                    case 'Noche': realHours = 8; equivalentHours = 28; break; // Recargo Dominical + Nocturno
                }
            }
            return { realHours, equivalentHours, turnBaseName };
        }

        function updateStatus(type, message) {
            appState.status = { type, message };
            if (!message) {
                statusEl.classList.add('hidden');
                return;
            }
           
            statusEl.classList.remove('hidden');
            let colorClass = "";
            switch (type) {
                case 'success': colorClass = "bg-green-100 text-green-700"; break;
                case 'error': colorClass = "bg-red-100 text-red-700"; break;
                case 'info': colorClass = "bg-blue-100 text-blue-700"; break;
                default: colorClass = "bg-gray-100 text-gray-700"; break;
            }
            statusEl.className = `p-3 rounded-lg mt-4 font-semibold text-sm ${colorClass}`;
            statusEl.textContent = message;
        }

        function setLoading(loading) {
            appState.isLoading = loading;
            const text = loading ? 'Calculando...' : 'Generar/Actualizar Horario y Calcular Salario';
            calculateButtonEl.textContent = text;
            calculateButtonEl.disabled = loading;

            if (loading) {
                calculateButtonEl.classList.add('bg-indigo-400');
                calculateButtonEl.classList.remove('bg-indigo-700', 'hover:bg-indigo-800');
            } else {
                calculateButtonEl.classList.remove('bg-indigo-400');
                calculateButtonEl.classList.add('bg-indigo-700', 'hover:bg-indigo-800');
            }
        }
       
        function updateAuthUI() {
            if (!isAuthReady) {
                userInfoEl.textContent = 'Cargando Autenticación...';
                googleLoginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                return;
            }
           
            const user = auth?.currentUser; // Usar optional chaining si auth puede ser null
           
            if (userId && user && !user.isAnonymous) {
                // Usuario autenticado (Google)
                userName = user.displayName || user.email || 'Usuario';
                userInfoEl.textContent = `Hola, ${userName} (${userId.substring(0, 4)}...)`;
                googleLoginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                // Usuario anónimo (Canvas token) o no autenticado
                userInfoEl.textContent = `Sesión: ${appState.config.name} (${userId ? userId.substring(0, 4) + '...' : 'Local'})`;
                googleLoginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }
        }
       
        function updateUIFromState() {
            // 1. Actualizar Inputs
            const config = appState.config;
            document.getElementById('input-year').value = config.year;
            document.getElementById('input-valorHora').value = config.valorHora;
            document.getElementById('input-lastFrancoDate').value = config.lastFrancoDate;
            document.getElementById('input-initialTurn').value = config.initialTurn;
            document.getElementById('input-discountRate').value = config.discountRate;
            // NUEVOS CAMPOS
            document.getElementById('input-name').value = config.name;
            document.getElementById('input-viaticoValue').value = config.viaticoValue;
            document.getElementById('input-titleValue').value = config.titleValue;
           
            // 2. Llenar opciones de meses
            const monthSelect = document.getElementById('input-month');
           
            if (monthSelect.options.length === 0 || monthSelect.options.length !== 12) {
                 monthSelect.innerHTML = '';
                Array.from({ length: 12 }, (_, i) => i + 1).forEach(m => {
                    const option = document.createElement('option');
                    option.value = m;
                    // El mes es m-1 porque Date usa 0-11
                    option.textContent = new Date(config.year, m - 1).toLocaleDateString('es-AR', { month: 'long' });
                    monthSelect.appendChild(option);
                });
            }
            monthSelect.value = config.month;

            // 3. Mostrar Resultados y Dashboard
            renderCalculationResults();

            // 4. Actualizar Status y Loading
            updateStatus(appState.status?.type, appState.status?.message);
            setLoading(appState.isLoading);
           
            // 5. Actualizar UI de Autenticación
            updateAuthUI();
        }
        
        // =====================================================================
        // INTEGRACIÓN FIREBASE (Autenticación y Persistencia)
        // =====================================================================

        // Importaciones de Firebase (Módulos)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"; // Añadido 'collection'

        // Rutas de Firestore
        function getConfigDocRef() {
            if (!db || !userId) return null;
            // Colección privada: /artifacts/{appId}/users/{userId}/config/salary
            return doc(db, 'artifacts', appId, 'users', userId, 'config', 'salary');
        }
       
        function getDataDocRef(monthDocId) {
            if (!db || !userId) return null;
            // Colección privada: /artifacts/{appId}/users/{userId}/data/{monthDocId} (Extras y Feriados manuales)
            return doc(db, 'artifacts', appId, 'users', userId, 'data', monthDocId);
        }
        
        function getHistoryDocRef(monthDocId) {
            if (!db || !userId) return null;
            // NUEVA Colección para historial de resultados: /artifacts/{appId}/users/{userId}/history/{monthDocId}
            return doc(db, 'artifacts', appId, 'users', userId, 'history', monthDocId);
        }

        // 1. Inicialización y Autenticación
        const initFirebase = async () => {
            updateStatus('info', 'Conectando a Firebase para autenticación y persistencia de datos...');

            try {
                // Inicializar Firebase con la configuración proporcionada
                app = initializeApp(HARDCODED_FIREBASE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);
               
                // setLogLevel('Debug'); // Descomentar para depuración

                // Autenticar con el token de entorno (si existe)
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }

                // Listener del estado de autenticación (Auth State Listener)
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userName = user.displayName || user.email || (user.isAnonymous ? 'Temporal' : 'Usuario');
                        isAuthReady = true;
                        updateStatus('success', `Sesión iniciada. Bienvenido, ${userName}!`);
                        setupDataListeners();
                    } else {
                        // Si el usuario cierra sesión, o no hay token de entorno, iniciamos sesión anónima
                        signInAnonymously(auth).then(anonUser => {
                            userId = anonUser.user.uid;
                            userName = 'Temporal (Anónimo)';
                            isAuthReady = true;
                            updateStatus('info', 'Sesión iniciada anónimamente.');
                            setupDataListeners();
                        }).catch(e => {
                            // Fallback si la autenticación anónima falla
                            console.error("Fallo de autenticación anónima:", e);
                            userId = crypto.randomUUID();
                            userName = 'Local (Error)';
                            isAuthReady = true;
                            isFirebaseActive = false;
                            updateStatus('error', 'Error de sesión. Usando ID local sin persistencia.');
                            calculateSchedule(false);
                        });
                    }
                    updateUIFromState();
                });

            } catch (error) {
                console.error("Error crítico al inicializar Firebase o al autenticar:", error);
                updateStatus('error', `Error Crítico: ${error.code || error.message}. La aplicación no tendrá persistencia.`);
                isFirebaseActive = false;
                userId = crypto.randomUUID();
                isAuthReady = true;
                userName = 'Local (Error)';
                calculateSchedule(false);
                updateUIFromState();
            }
        };

        // --- FUNCIONES DE AUTENTICACIÓN CON GOOGLE ---
       
        googleLoginBtn.addEventListener('click', signInWithGoogle);
        logoutBtn.addEventListener('click', signOutUser);

        async function signInWithGoogle() {
            if (!auth) {
                 updateStatus('error', 'Firebase Auth no está inicializado.');
                 return;
            }
            updateStatus('info', 'Iniciando sesión con Google...');
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
                // onAuthStateChanged se encargará de actualizar el estado y los datos
            } catch (error) {
                console.error("Error al iniciar sesión con Google:", error);
                if (error.code === 'auth/popup-closed-by-user') {
                    updateStatus('info', 'Ventana de Google cerrada. Intenta de nuevo.');
                } else if (error.code === 'auth/unauthorized-domain') {
                    updateStatus('error', 'Error de dominio no autorizado (auth/unauthorized-domain). Verifica tu configuración en la consola de Firebase.');
                } else {
                    updateStatus('error', `Error de Google Auth: ${error.code || error.message}`);
                }
            }
        }
       
        async function signOutUser() {
            if (!auth) return;
            try {
                await signOut(auth);
                // onAuthStateChanged se encargará de re-autenticar anónimamente
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                updateStatus('error', `Error al cerrar sesión: ${error.message}`);
            }
        }


        // 2. Funciones de Carga y Guardado
        function saveConfig() {
            if (!isFirebaseActive || !isAuthReady || !userId || !db) return;
           
            const configRef = getConfigDocRef();
            if (!configRef) return;

            const dataToSave = { ...appState.config };
            // Asegurar que los datos numéricos se guardan como números
            dataToSave.valorHora = Number(dataToSave.valorHora);
            dataToSave.discountRate = Number(dataToSave.discountRate);
            dataToSave.month = Number(dataToSave.month);
            dataToSave.year = Number(dataToSave.year);
            // NUEVOS CAMPOS NUMÉRICOS
            dataToSave.viaticoValue = Number(dataToSave.viaticoValue);
            dataToSave.titleValue = Number(dataToSave.titleValue);

            setDoc(configRef, dataToSave, { merge: true })
                .catch(error => {
                    console.error("Error saving config:", error);
                    updateStatus('error', "Error al guardar configuración.");
                });
        }
       
        function saveData() {
            if (!isFirebaseActive || !isAuthReady || !userId || !db) return;
           
            const config = appState.config;
            const monthDocId = `${config.year}-${String(config.month).padStart(2, '0')}`;
            const dataRef = getDataDocRef(monthDocId);
            if (!dataRef) return;
           
            setDoc(dataRef, {
                extras: appState.extraHours,
                holidayFlags: appState.manualHolidays
            }, { merge: true })
            .catch(error => {
                console.error("Error saving month data:", error);
                updateStatus('error', "Error al guardar datos de horas/feriados.");
            });
        }
        
        function saveHistory(result) {
            if (!isFirebaseActive || !isAuthReady || !userId || !db || !result) return;

            const config = appState.config;
            const monthDocId = `${config.year}-${String(config.month).padStart(2, '0')}`;
            const historyRef = getHistoryDocRef(monthDocId);
            if (!historyRef) return;

            const dataToSave = {
                month: config.month,
                year: config.year,
                totalNeto: result.totalNeto,
                totalBruto: result.totalBruto,
                totalEquivalentHours: result.totalEquivalentHours,
                timestamp: new Date().toISOString(),
                // Guardar los resultados de las quincenas
                quincena1: result.quincena1.neto,
                quincena2: result.quincena2.neto,
            };

            setDoc(historyRef, dataToSave, { merge: true })
                .catch(error => {
                    console.error("Error saving history data:", error);
                    updateStatus('error', "Error al guardar el historial.");
                });
        }
       
        // 3. Listeners de Datos (onSnapshot)
        let unsubscribeConfig = null;
        let unsubscribeData = null;
        let unsubscribeHistory = null; // NUEVO

        function setupDataListeners() {
            if (!isFirebaseActive || !isAuthReady || !userId || !db) {
                // Si no hay Firebase activo o autenticación lista, solo usa los datos locales.
                calculateSchedule(false);
                return;
            }
           
            // 3.1 Listener de Configuración
            if (unsubscribeConfig) unsubscribeConfig();
            const configRef = getConfigDocRef();
            if (configRef) {
                unsubscribeConfig = onSnapshot(configRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        appState.config = {
                            ...appState.config, ...data,
                            // Asegurarse de que los valores numéricos se mantengan
                            valorHora: Number(data.valorHora) || appState.config.valorHora,
                            discountRate: Number(data.discountRate) || appState.config.discountRate,
                            month: Number(data.month) || appState.config.month,
                            year: Number(data.year) || appState.config.year,
                            viaticoValue: Number(data.viaticoValue) || 0, // Nuevo
                            titleValue: Number(data.titleValue) || 0, // Nuevo
                        };
                        updateUIFromState();
                    } else {
                        saveConfig(); // Guardar por primera vez si no existe el documento
                    }
                }, (error) => {
                    console.error("Error fetching config:", error);
                    updateStatus('error', "Error al cargar configuración.");
                });
            }

            // 3.2 Listener de Datos (Horas Extra y Feriados Manuales)
            if (unsubscribeData) unsubscribeData();
            const config = appState.config;
            const monthDocId = `${config.year}-${String(config.month).padStart(2, '0')}`;
            const dataRef = getDataDocRef(monthDocId);
            if (dataRef) {
                unsubscribeData = onSnapshot(dataRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        appState.extraHours = data.extras || {};
                        appState.manualHolidays = data.holidayFlags || {};
                    } else {
                        appState.extraHours = {};
                        appState.manualHolidays = {};
                        // Al no existir, reiniciamos el estado local para ese mes/año
                    }
                    updateUIFromState();
                    // Volver a calcular para reflejar los datos recién cargados o vaciados
                    if (appState.calculationResult) calculateSchedule(false);
                }, (error) => {
                    console.error("Error fetching month data:", error);
                    updateStatus('error', "Error al cargar datos de mes.");
                });
            }
            
            // 3.3 Listener de Historial (NUEVO)
            if (unsubscribeHistory) unsubscribeHistory();
            const historyCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'history');
            if (historyCollectionRef) {
                unsubscribeHistory = onSnapshot(historyCollectionRef, (snapshot) => {
                    appState.history = [];
                    snapshot.forEach(doc => {
                        appState.history.push(doc.data());
                    });
                    renderHistoryDashboard();
                }, (error) => {
                    console.error("Error fetching history:", error);
                });
            }
        }

        // =====================================================================
        // MANEJADORES DE EVENTOS DE INTERACCIÓN (INPUTS DE LA TABLA)
        // =====================================================================

        function handleConfigChange() {
            const newConfig = {
                month: parseInt(document.getElementById('input-month').value),
                year: parseInt(document.getElementById('input-year').value),
                valorHora: parseFloat(document.getElementById('input-valorHora').value) || appState.config.valorHora,
                lastFrancoDate: document.getElementById('input-lastFrancoDate').value,
                initialTurn: document.getElementById('input-initialTurn').value,
                discountRate: parseFloat(document.getElementById('input-discountRate').value) || appState.config.discountRate,
                // NUEVOS CAMPOS
                name: document.getElementById('input-name').value,
                viaticoValue: parseFloat(document.getElementById('input-viaticoValue').value) || 0,
                titleValue: parseFloat(document.getElementById('input-titleValue').value) || 0,
            };
           
            const oldDocId = `${appState.config.year}-${String(appState.config.month).padStart(2, '0')}`;
            const newDocId = `${newConfig.year}-${String(newConfig.month).padStart(2, '0')}`;

            appState.config = newConfig;
            saveConfig(); // Guardar la nueva configuración

            if (isFirebaseActive && oldDocId !== newDocId) {
                // Si el mes/año cambió y estamos activos en Firebase, cambiamos el listener de datos para el nuevo mes.
                setupDataListeners();
            } else {
                updateUIFromState();
                calculateSchedule(false);
            }
        }

        window.handleConfigChange = handleConfigChange;
       
        window.handleExtraChange = function(dateKey, inputElement) {
            const hours = parseFloat(inputElement.value) || 0;
            // Usamos el formato de display (DD/MM/YYYY) como clave en Firestore
            appState.extraHours[dateKey] = hours;
            saveData();
            calculateSchedule(false);
        }

        window.handleHolidayChange = function(dateKey, checkboxElement) {
            if (checkboxElement.checked) {
                appState.manualHolidays[dateKey] = true;
            } else {
                delete appState.manualHolidays[dateKey];
            }
            saveData();
            calculateSchedule(false);
        }

        // =====================================================================
        // LÓGICA DE CÁLCULO
        // =====================================================================
       
        calculateButtonEl.addEventListener('click', () => calculateSchedule(true));

        function calculateSchedule(initialCalculation = true) {
            if (initialCalculation) setLoading(true);

            const { month, year, lastFrancoDate, initialTurn, valorHora, discountRate, viaticoValue, titleValue } = appState.config;
           
            if (!lastFrancoDate || !valorHora || isNaN(valorHora) || valorHora <= 0) {
                 if (initialCalculation) setLoading(false);
                 updateStatus('error', 'Por favor, ingrese un Valor de Hora Bruta y una Fecha de Último Franco válidos.');
                 appState.calculationResult = null;
                 resultsSectionEl.classList.add('hidden');
                 updateUIFromState();
                 return;
            }

            let currentDate = new Date(year, month - 1, 1, 0, 0, 0);
           
            const lastFrancoDay2 = new Date(lastFrancoDate + 'T00:00:00');
            const dayAfterFranco = new Date(lastFrancoDay2.getTime());
            dayAfterFranco.setDate(dayAfterFranco.getDate() + 1);

            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            let dailyResults = [];
            let francosDates = [];
           
            // Ciclo 6x2 (24 días de rotación)
            const masterCycle = [
                'Mañana', 'Mañana', 'Mañana', 'Mañana', 'Mañana', 'Mañana', 'Franco', 'Franco',
                'Noche', 'Noche', 'Noche', 'Noche', 'Noche', 'Noche', 'Franco', 'Franco',
                'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Franco', 'Franco'
            ];
           
            let baseOffset = 0;
            if (initialTurn === 'Noche') baseOffset = 8;
            else if (initialTurn === 'Tarde') baseOffset = 16;
           
            // Calcular el desplazamiento inicial basado en la diferencia de días
            const diffTime = currentDate.getTime() - dayAfterFranco.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
           
            let startOffset = (baseOffset + diffDays) % 24;
            if (startOffset < 0) startOffset += 24; // Asegurar offset positivo

            let dayCounter = 0;
            const daysInMonth = new Date(year, month, 0).getDate();

            while (dayCounter < daysInMonth) {
                const dayOfWeek = currentDate.getDay();
                const dateKeyForSave = formatDateForDisplay(currentDate);
                const dateKeyForInput = formatDateForInput(currentDate);
               
                // Usar el estado de Feriado Manual cargado de Firebase (o local)
                const isHolidayManual = appState.manualHolidays[dateKeyForSave] === true;
               
                const cycleStatus = masterCycle[startOffset];
               
                let turnBaseName = cycleStatus;
                let realHours = 0;
                let equivalentHours = 0;
               
                if (cycleStatus === 'Franco') {
                    if (isHolidayManual) {
                        turnBaseName = `FERIADO - Franco`;
                        equivalentHours = HOLIDAY_FREE_EQUIV_HOURS;
                        francosDates.push(dateKeyForSave + ' (Feriado)');
                    } else {
                         turnBaseName = `Franco`;
                         francosDates.push(dateKeyForSave);
                    }
                }
                else {
                    if (isHolidayManual) {
                        turnBaseName = `FERIADO - ${cycleStatus}`;
                        realHours = 8;
                        equivalentHours = HOLIDAY_WORKED_EQUIV_HOURS; // 32 Horas equivalentes
                    } else {
                        const equivalences = getTurnEquivalencies(dayOfWeek, cycleStatus);
                        realHours = equivalences.realHours;
                        equivalentHours = equivalences.equivalentHours;
                        turnBaseName = equivalences.turnBaseName;
                    }
                }
               
                dailyResults.push({
                    date: dateKeyForSave,
                    dateKey: dateKeyForInput, // Clave para el input de Fecha
                    day: dayNames[dayOfWeek],
                    turn: turnBaseName,
                    isHoliday: isHolidayManual,
                    equivHoursBase: equivalentHours,
                });
               
                startOffset = (startOffset + 1) % 24;
                currentDate.setDate(currentDate.getDate() + 1);
                dayCounter++;
            }
           
            let totalEquivalentHours = 0;
            let totalExtraHoursReal = 0;
            let extraDaysCount = 0; // NUEVO: Contador de días con horas extra
            const hourlyRate = parseFloat(valorHora) || 0;

            const date15th = new Date(year, month - 1, 15, 0, 0, 0); // Para dividir por quincena
            let hEqQuincena1 = 0;
            let hEqQuincena2 = 0;
            let extraDaysQ1 = 0;
            let extraDaysQ2 = 0;

            const finalDailyResults = dailyResults.map(day => {
                // Usamos la clave de display (DD/MM/YYYY) para buscar en extraHours
                const dayExtraReal = appState.extraHours[day.date] || 0;
                const dayDate = new Date(day.dateKey + 'T00:00:00');
               
                let dayExtraEquivalent = 0;
               
                if (dayExtraReal > 0) {
                    dayExtraEquivalent = (dayExtraReal * EXTRA_HOUR_MULTIPLIER);
                    totalExtraHoursReal += dayExtraReal;
                    extraDaysCount++;
                    
                    if (dayDate.getTime() <= date15th.getTime()) extraDaysQ1++;
                    else extraDaysQ2++;
                }
               
                const finalEquivHours = day.equivHoursBase + dayExtraEquivalent;
                const finalDailyBruto = finalEquivHours * hourlyRate;

                totalEquivalentHours += finalEquivHours;

                if (dayDate.getTime() <= date15th.getTime()) hEqQuincena1 += finalEquivHours;
                else hEqQuincena2 += finalEquivHours;


                return {
                    ...day,
                    extraReal: dayExtraReal,
                    extraEquiv: dayExtraEquivalent,
                    equivHoursFinal: finalEquivHours,
                    dailyBruto: finalDailyBruto,
                };
            });
           
            // CÁLCULOS FINALES
            const totalViatico = extraDaysCount * viaticoValue;
            const totalBrutoBase = totalEquivalentHours * hourlyRate; // Bruto sin viáticos ni título
            const totalDescuento = totalBrutoBase * discountRate;
            
            // Total Neto: (Bruto Base - Descuento) + Viático + Título
            const totalNeto = totalBrutoBase - totalDescuento + totalViatico + titleValue;
            
            // CÁLCULO DE QUINCENAS NETAS
            const brutoQ1 = hEqQuincena1 * hourlyRate;
            const viaticoQ1 = extraDaysQ1 * viaticoValue;
            const descuentoQ1 = brutoQ1 * discountRate;
            const netoQ1 = brutoQ1 - descuentoQ1 + viaticoQ1;

            const brutoQ2 = hEqQuincena2 * hourlyRate;
            const viaticoQ2 = extraDaysQ2 * viaticoValue;
            const descuentoQ2 = brutoQ2 * discountRate;
            const netoQ2 = brutoQ2 - descuentoQ2 + viaticoQ2 + titleValue; // Título solo en Q2
            
            appState.calculationResult = {
                dailyResults: finalDailyResults,
                francosDates,
                totalEquivalentHours,
                totalExtraHoursReal,
                totalBruto: totalBrutoBase + totalViatico + titleValue, // Bruto para resumen total
                totalDescuento,
                totalNeto,
                discountRate: discountRate * 100,
                
                // NUEVOS RESULTADOS DE ADICIONALES Y QUINCENAS
                totalViatico,
                titleValue,
                extraDaysCount,
                quincena1: { neto: netoQ1, bruto: brutoQ1, viatico: viaticoQ1, descuento: descuentoQ1, hEq: hEqQuincena1 },
                quincena2: { neto: netoQ2, bruto: brutoQ2, viatico: viaticoQ2, descuento: descuentoQ2, hEq: hEqQuincena2, title: titleValue },
            };
            
            // GUARDAR HISTORIAL
            saveHistory(appState.calculationResult);

            if (initialCalculation) setLoading(false);
            updateUIFromState();
            if (initialCalculation) updateStatus('success', `Cálculo generado para ${dailyResults.length} días. ¡Añade tus extras y feriados!`);
        }
       
        // =====================================================================
        // RENDERIZADO DE RESULTADOS
        // =====================================================================
        
        function findNextFrancos(lastFrancoDate, initialTurn) {
            const today = new Date();
            // Asegurar que empezamos DESPUÉS del último franco
            let currentDate = new Date(lastFrancoDate + 'T00:00:00');
            currentDate.setDate(currentDate.getDate() + 1); // Día después del último franco (Día 1 del ciclo de trabajo)

            // Ciclo 6x2 (24 días de rotación)
            const masterCycle = [
                'Mañana', 'Mañana', 'Mañana', 'Mañana', 'Mañana', 'Mañana', 'Franco', 'Franco',
                'Noche', 'Noche', 'Noche', 'Noche', 'Noche', 'Noche', 'Franco', 'Franco',
                'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Franco', 'Franco'
            ];
           
            let baseOffset = 0;
            if (initialTurn === 'Noche') baseOffset = 8;
            else if (initialTurn === 'Tarde') baseOffset = 16;
           
            const lastFrancoDay2 = new Date(lastFrancoDate + 'T00:00:00');
            const dayAfterFranco = new Date(lastFrancoDay2.getTime());
            dayAfterFranco.setDate(dayAfterFranco.getDate() + 1);
            
            // Calcular el desplazamiento inicial basado en la diferencia de días entre *hoy* y el día después del franco
            const diffTime = today.getTime() - dayAfterFranco.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            let startOffset = (baseOffset + diffDays) % 24;
            if (startOffset < 0) startOffset += 24; // Asegurar offset positivo

            let nextFrancos = [];
            let searchDate = new Date(today.getTime());
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];

            // Buscar hasta 50 días en el futuro para encontrar los próximos dos francos
            for (let i = 0; i < 50 && nextFrancos.length < 2; i++) {
                const cycleStatus = masterCycle[startOffset];
                const dayName = dayNames[searchDate.getDay()];

                if (cycleStatus === 'Franco' && searchDate.getTime() >= today.getTime()) {
                    nextFrancos.push({ day: dayName, date: formatDateForDisplay(searchDate) });
                }
                
                startOffset = (startOffset + 1) % 24;
                searchDate.setDate(searchDate.getDate() + 1);
            }
            return nextFrancos;
        }

        function renderPersonalDashboard(isNoCalculation = false, result = null) {
            const config = appState.config;
            const monthName = new Date(config.year, config.month - 1).toLocaleDateString('es-AR', { month: 'long', year: 'numeric' });
            
            let content = '';
            
            if (isNoCalculation || !result) {
                content = `
                    <div class="col-span-4 p-4 text-center rounded-lg">
                        <p class="text-xl font-bold text-indigo-700">Hola, ${config.name}!</p>
                        <p class="text-sm text-gray-600 mt-2">No se ha generado el cálculo para ${monthName}.</p>
                        <p class="text-sm text-gray-600">Presiona "Generar/Actualizar Horario y Calcular Salario" para comenzar.</p>
                    </div>
                `;
            } else {
                const nextFrancos = findNextFrancos(config.lastFrancoDate, config.initialTurn);
                const francosDisplay = nextFrancos.length > 0 ? nextFrancos.map(f => `${f.day.substring(0, 3)}. ${f.date.substring(0, 5)}`).join(' y ') : 'No se encontraron';

                content = `
                    <div class="col-span-4 p-4 text-center bg-gray-50 rounded-lg md:border-b-0">
                        <p class="text-xl font-bold text-indigo-700">Hola, ${config.name}!</p>
                        <p class="text-sm text-gray-600">Calculando: ${monthName}</p>
                    </div>
                    <div class="col-span-2 md:col-span-1 p-3 bg-yellow-50 rounded-lg">
                        <p class="text-gray-500">Próximo/s Francos</p>
                        <p class="text-md text-yellow-800 font-bold">${francosDisplay}</p>
                    </div>
                    <div class="col-span-2 md:col-span-1 p-3 bg-red-50 rounded-lg">
                        <p class="text-gray-500">Ganancia 1ra Quincena</p>
                        <p class="text-md text-red-600 font-bold">${formatCurrency(result.quincena1.neto)}</p>
                    </div>
                    <div class="col-span-2 md:col-span-1 p-3 bg-green-50 rounded-lg">
                        <p class="text-gray-500">Ganancia 2da Quincena</p>
                        <p class="text-md text-green-800 font-bold">${formatCurrency(result.quincena2.neto)}</p>
                    </div>
                     <div class="col-span-2 md:col-span-1 p-3 bg-indigo-50 rounded-lg">
                        <p class="text-gray-500">Neto Total del Mes</p>
                        <p class="text-md text-indigo-700 font-bold">${formatCurrency(result.totalNeto)}</p>
                    </div>
                `;
            }
            personalDashboardEl.innerHTML = content;
        }
        
        function renderHistoryDashboard() {
            const history = appState.history;
            historyButtonsEl.innerHTML = '';
            historyLoadingEl.classList.add('hidden');

            if (history.length === 0) {
                 historyButtonsEl.innerHTML = '<p class="text-xs text-gray-500">Aún no hay meses calculados.</p>';
                 comparisonTableEl.innerHTML = '<p id="comparison-placeholder" class="text-xs text-gray-500">Se requiere cargar el historial para generar el ranking.</p>';
                 return;
            }
           
            // 1. Botones de Meses Calculados
            history.sort((a, b) => new Date(a.year, a.month - 1) - new Date(b.year, b.month - 1)).forEach(item => {
                const monthName = new Date(item.year, item.month - 1).toLocaleDateString('es-AR', { month: 'short' });
                const button = document.createElement('button');
                button.textContent = `${monthName} ${item.year}`;
                
                // Si es el mes activo, resaltarlo.
                const isActiveMonth = item.month === appState.config.month && item.year === appState.config.year;
                
                button.className = `px-3 py-1 text-xs font-semibold rounded-lg transition duration-150 ${
                    isActiveMonth ? 'bg-indigo-700 text-white' : 'bg-indigo-100 text-indigo-700 hover:bg-indigo-200'
                }`;
                // TODO: La funcionalidad de cargar el mes desde la historia
                // button.onclick = () => loadMonthFromHistory(item.month, item.year);
                historyButtonsEl.appendChild(button);
            });
           
            // 2. Tabla de Comparaciones (Ranking)
            const sortedHistory = [...history].sort((a, b) => b.totalNeto - a.totalNeto);
           
            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200 text-xs">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="px-3 py-1 text-left text-gray-500">#</th>
                            <th class="px-3 py-1 text-left text-gray-500">Mes</th>
                            <th class="px-3 py-1 text-right text-gray-500">Neto Total</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            sortedHistory.forEach((item, index) => { 
                const monthName = new Date(item.year, item.month - 1).toLocaleDateString('es-AR', { month: 'long', year: 'numeric' });
                tableHTML += `
                    <tr>
                        <td class="px-3 py-1 font-bold">${index + 1}</td>
                        <td class="px-3 py-1">${monthName}</td>
                        <td class="px-3 py-1 text-right font-bold text-green-700">${formatCurrency(item.totalNeto)}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;
            comparisonTableEl.innerHTML = tableHTML;
        }

        function renderCalculationResults() {
             const result = appState.calculationResult;
            
            // 1. Renderizar el Dashboard Personal (siempre visible, incluye el Hola, Francos, Quincenas y Neto Mes)
            renderPersonalDashboard(!result, result);
            
            if (!result) {
                resultsSectionEl.classList.add('hidden');
                return;
            }

            resultsSectionEl.classList.remove('hidden');

            // 2. Renderizar Totales del Mes y el Detalle de Adicionales
             monthlyTotalsContainerEl.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm font-medium mb-6">
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <p class="text-gray-500">H. Eq. Totales</p>
                        <p class="text-lg text-gray-900 font-extrabold">${formatNumber(result.totalEquivalentHours)}</p>
                    </div>
                    <div class="p-3 bg-red-50 rounded-lg">
                        <p class="text-gray-500">Desc. (${result.discountRate.toFixed(0)}%)</p>
                        <p class="text-lg text-red-600 font-extrabold">${formatCurrency(result.totalDescuento)}</p>
                    </div>
                    <div class="col-span-1 p-3 bg-indigo-50 rounded-lg">
                        <p class="text-gray-500">Bruto Base</p>
                        <p class="text-xl text-indigo-600 font-extrabold">${formatCurrency(result.totalBruto - result.totalViatico - result.titleValue)}</p>
                    </div>
                    <div class="col-span-1 p-3 bg-green-100 rounded-lg shadow-md">
                        <p class="text-green-700 font-semibold">NETO FINAL</p>
                        <p class="text-2xl text-green-800 font-extrabold">${formatCurrency(result.totalNeto)}</p>
                    </div>
                </div>
                <div class="p-3 bg-blue-50 rounded-lg text-sm mb-4">
                    <p class="font-bold text-blue-800">Detalle de Adicionales:</p>
                    <p class="mt-1">Viáticos por ${result.extraDaysCount} días extras: ${formatCurrency(result.totalViatico)}</p>
                    <p class="mt-1">Monto Título (Añadido en 2da Q): ${formatCurrency(result.titleValue)}</p>
                </div>
            `;

            // 3. Renderizar Información de Francos
            francosInfoEl.innerHTML = `
                <p class="font-bold text-yellow-800">Días Francos en el Mes (${result.francosDates.length}):</p>
                <p class="mt-1">${result.francosDates.join(' • ')}</p>
            `;

            // 4. Renderizar Tabla de Detalle Diario
            tbodyEl.innerHTML = result.dailyResults.map(day => {
                // Usamos la clave de display (DD/MM/YYYY) para guardar/cargar datos
                const dateKeyForSave = day.date;
                const dayExtraReal = appState.extraHours[dateKeyForSave] || 0;
                const isFeriadoManual = appState.manualHolidays[dateKeyForSave] === true;
               
                const isFranco = day.turn.includes('Franco');
               
                let rowClasses = 'hover:bg-gray-50';
                if (isFranco && !isFeriadoManual) {
                    rowClasses = 'bg-yellow-50 hover:bg-yellow-100 font-semibold text-yellow-800';
                } else if (isFeriadoManual) {
                    rowClasses = 'bg-red-100 hover:bg-red-200 font-extrabold text-red-700';
                }

                return `
                    <tr class="${rowClasses}">
                        <td class="px-3 py-2 whitespace-nowrap text-gray-900">${day.date} - ${day.day.substring(0, 3)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-gray-700">${day.turn}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-center">
                            <input type="checkbox"
                                class="form-checkbox h-4 w-4 text-red-600 transition duration-150 ease-in-out"
                                ${isFeriadoManual ? 'checked' : ''}
                                onchange="handleHolidayChange('${dateKeyForSave}', this)"
                            >
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-right">${formatNumber(day.equivHoursBase, 2)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-center">
                            <input type="number"
                                value="${dayExtraReal || ''}"
                                class="w-16 text-center border rounded p-1 text-xs"
                                step="0.5" min="0"
                                onchange="handleExtraChange('${dateKeyForSave}', this)"
                            >
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-right font-bold ${isFeriadoManual ? 'text-red-700' : ''}">${formatNumber(day.equivHoursFinal, 2)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-right font-bold">${formatCurrency(day.dailyBruto)}</td>
                    </tr>
                `;
            }).join('');
        }
       
        // Función de generación de PDF
        generatePdfButtonEl.addEventListener('click', generatePDFReport);
        function generatePDFReport() {
            const result = appState.calculationResult;
            if (!result) return updateStatus('error', 'Debe generar el cálculo antes de descargar el reporte.');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
           
            const { month, year, name, viaticoValue, titleValue } = appState.config;
            const monthName = new Date(year, month - 1).toLocaleDateString('es-AR', { month: 'long', year: 'numeric' });
           
            const title = `Reporte Salarial 6x2 - ${monthName}`;
           
            doc.setFontSize(16);
            doc.text(title, 14, 20);
           
            doc.setFontSize(10);
            doc.text(`Generado para: ${name}`, 14, 26);
            doc.text(`Valor Hora Bruta: ${formatCurrency(appState.config.valorHora)}`, 14, 31);
            doc.text(`Desc. Afiliación: ${result.discountRate.toFixed(0)}%`, 14, 36);
            doc.text(`Viático por Día Extra: ${formatCurrency(viaticoValue)}`, 14, 41);

            let tableY = 50;

            // Tabla Resumen Quincenal
            doc.setFontSize(12);
            doc.text('Resumen Quincenal (Neto)', 14, tableY);
            doc.autoTable({
                startY: tableY + 5,
                head: [['Quincena', 'Horas Eq.', 'Bruto Base', 'Desc.', 'Viático', 'Título', 'NETO']],
                body: [[
                    '1ra (1-15)',
                    formatNumber(result.quincena1.hEq, 2),
                    formatCurrency(result.quincena1.bruto),
                    formatCurrency(result.quincena1.descuento),
                    formatCurrency(result.quincena1.viatico),
                    formatCurrency(0),
                    formatCurrency(result.quincena1.neto),
                ],
                [
                    '2da (16-Fin)',
                    formatNumber(result.quincena2.hEq, 2),
                    formatCurrency(result.quincena2.bruto),
                    formatCurrency(result.quincena2.descuento),
                    formatCurrency(result.quincena2.viatico),
                    formatCurrency(result.quincena2.title),
                    formatCurrency(result.quincena2.neto),
                ]],
                theme: 'striped',
                headStyles: { fillColor: [55, 48, 163] },
                columnStyles: {
                    6: { fontStyle: 'bold', fillColor: [187, 247, 208] },
                },
                styles: { fontSize: 8 }
            });
            
            tableY = doc.autoTable.previous.finalY;
            
            // Tabla Totales
            doc.setFontSize(12);
            doc.text('Totales del Mes', 14, tableY + 10);
            doc.autoTable({
                startY: tableY + 15,
                head: [['Total H. Eq.', 'Total H. Extra (R)', 'Bruto Base', 'Total Desc.', 'Total Adicionales', 'NETO FINAL']],
                body: [[
                    formatNumber(result.totalEquivalentHours, 2),
                    formatNumber(result.totalExtraHoursReal, 1),
                    formatCurrency(result.totalBruto - result.totalViatico - result.titleValue),
                    formatCurrency(result.totalDescuento),
                    formatCurrency(result.totalViatico + result.titleValue),
                    formatCurrency(result.totalNeto),
                ]],
                theme: 'striped',
                headStyles: { fillColor: [75, 85, 99] },
                columnStyles: {
                    5: { fontStyle: 'bold', fillColor: [187, 247, 208] },
                },
                styles: { fontSize: 8 }
            });

            const finalY = doc.autoTable.previous.finalY;
            doc.setFontSize(12);
            doc.text('Detalle Diario de Horas y Turnos', 14, finalY + 15);
           
            const tableData = result.dailyResults.map(d => [
                d.date,
                d.day.substring(0, 3),
                d.turn,
                appState.manualHolidays[d.date] === true ? 'Sí' : 'No',
                formatNumber(d.equivHoursBase, 2),
                d.extraReal > 0 ? formatNumber(d.extraReal, 1) : '',
                formatNumber(d.equivHoursFinal, 2),
                formatCurrency(d.dailyBruto)
            ]);
           
            doc.autoTable({
                startY: finalY + 20,
                head: [['Fecha', 'Día', 'Turno', 'Feriado?', 'H. Eq. Base', 'H. Extra (R)', 'H. Eq. Total', 'Monto Bruto']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [75, 85, 99] },
                columnStyles: {
                    4: { halign: 'right' },
                    5: { halign: 'center' },
                    6: { halign: 'right', fontStyle: 'bold' },
                    7: { halign: 'right', fontStyle: 'bold' },
                },
                didParseCell: (data) => {
                    const turn = data.row.raw[2];
                    const isHoliday = data.row.raw[3] === 'Sí';

                    if (turn.includes('Franco') && !isHoliday) {
                        data.cell.styles.fillColor = [255, 251, 235];
                    }
                    if (isHoliday) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.textColor = [185, 28, 28];
                        data.cell.styles.fillColor = [254, 226, 226];
                    }
                },
                styles: { fontSize: 8 }
            });

            doc.save(`Reporte_6x2_${monthName.replace(/\s/g, '_')}.pdf`);
        }
       
        // =====================================================================
        // INICIO DE LA APLICACIÓN
        // =====================================================================
       
        window.onload = () => {
            updateUIFromState();
            initFirebase();
        };

    </script>
</body>
</html>
