<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Salarial 6x2</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuraciones de fuente */
        @import url('https://fonts.fonts.google.com/specimen/Inter');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .input-style {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            width: 100%;
            transition: border-color 0.15s;
        }
        .input-style:focus {
            border-color: #4f46e5;
            outline: none;
            ring: 2px;
            ring-color: #6366f1;
        }
        /* Estilo para la tabla pegajosa */
        .sticky-header th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f9fafb; /* Fondo para que se vea bien */
        }
    </style>

    <!-- CARGA DE LIBRERÍAS JSDPF Y AUTOTABLE -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

</head>
<body class="min-h-screen flex items-start justify-center p-4">

    <!-- Contenedor Principal de la Aplicación -->
    <div id="app-container" class="w-full max-w-5xl bg-white rounded-xl card p-6 md:p-8 mt-4">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-2 mb-4">
            <h1 class="text-2xl font-bold text-indigo-700">
                Calculadora Salarial 6x2
            </h1>
            <div id="auth-controls" class="flex space-x-2 mt-2 md:mt-0 items-center">
                <div id="user-info" class="text-sm text-gray-600">Cargando...</div>
                <button id="google-login-btn" class="flex items-center px-3 py-1 bg-blue-600 text-white text-sm font-semibold rounded-lg shadow hover:bg-blue-700 transition duration-150">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M44.5 20H24v8.5h11.8c-.7 4.3-3.6 7.9-7.9 10.1v7H44c.4-3.4 2.8-6.4 5.9-8.5v-2c-3-2.1-5.4-5.1-5.9-8.5z" fill="#4285F4"/><path d="M24 44.5h20.5v-7h-7c-2.3 2.1-5 3.7-7.7 4.7v2.3c3 0 5.8-.8 8.1-2.2v-2z" fill="#34A853"/><path d="M24 3.5V11H4v7h20v8.5h-11.8c.7 4.3 3.6 7.9 7.9 10.1v7c-8.9-3.2-14.9-12-14.9-22.6C9.1 12 14.1 6.5 24 3.5z" fill="#FBBC05"/><path d="M24 3.5V11h20v-7H24z" fill="#EA4335"/></svg>
                    Google
                </button>
                <button id="logout-btn" class="hidden px-3 py-1 bg-gray-500 text-white text-sm font-semibold rounded-lg shadow hover:bg-gray-600 transition duration-150">
                    Salir
                </button>
            </div>
        </div>
        
        <div id="status-message" class="hidden p-3 rounded-lg mt-4 font-semibold text-sm"></div>

        <!-- Panel de Configuración (El resto del contenido permanece igual) -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
            <div>
                <label class="block text-sm font-medium text-gray-700">Mes</label>
                <select id="input-month" name="month" class="input-style" onchange="handleConfigChange()">
                    <!-- Opciones se llenarán con JS -->
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Año</label>
                <input id="input-year" type="number" name="year" class="input-style" onchange="handleConfigChange()">
            </div>
            <div class="col-span-2 md:col-span-1">
                <label class="block text-sm font-medium text-gray-700">Valor Hora Bruta ($)</label>
                <input id="input-valorHora" type="number" name="valorHora" class="input-style" onchange="handleConfigChange()" step="0.01">
            </div>
            <div class="col-span-2 md:col-span-1">
                <label class="block text-sm font-medium text-gray-700">Desc. Afiliación</label>
                <select id="input-discountRate" name="discountRate" class="input-style" onchange="handleConfigChange()">
                    <option value="0.18">No Afiliado (18%)</option>
                    <option value="0.16">Afiliado (16%)</option>
                </select>
            </div>
            <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700">Fecha del Último Franco (Día 2)</label>
                <input id="input-lastFrancoDate" type="date" name="lastFrancoDate" class="input-style" onchange="handleConfigChange()">
            </div>
            <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700">Turno Post-Franco</label>
                <select id="input-initialTurn" name="initialTurn" class="input-style" onchange="handleConfigChange()">
                    <option value="Mañana">Mañana</option>
                    <option value="Noche">Noche</option>
                    <option value="Tarde">Tarde</option>
                </select>
            </div>
        </div>

        <button id="calculate-schedule-button" class="w-full py-3 mt-2 rounded-lg text-white font-bold transition duration-150 bg-indigo-700 hover:bg-indigo-800">
            Generar/Actualizar Horario y Calcular Salario
        </button>

        <!-- Sección de Resultados (Oculta hasta el cálculo) -->
        <div id="results-section" class="hidden mt-6 border-t pt-6">
            <h2 class="text-xl font-bold text-indigo-700 mb-4">Resumen de Ganancias</h2>
            <div id="summary-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm font-medium mb-6">
                <!-- Cards de resumen aquí -->
            </div>

            <div id="francos-info" class="p-3 bg-yellow-50 rounded-lg text-sm mb-4">
                <!-- Información de francos aquí -->
            </div>

            <button id="generate-pdf-button" class="w-full py-2 mb-6 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold transition duration-150 flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Descargar Reporte PDF
            </button>
            
            <!-- Tabla de Detalle Diario -->
            <h3 class="text-lg font-bold text-gray-800 mb-3 border-t pt-4">Detalle Diario, Feriados y Horas Extra</h3>
            <p class="text-xs text-red-600 mb-3">
                ⚠️ Marca la casilla "Es Feriado" para aplicar la equivalencia de **32 Horas** (si trabajas) o **8 Horas** (si es Franco).
            </p>
            <div id="daily-detail-table-container" class="overflow-x-auto rounded-lg border" style="max-height: 400px; overflow-y: auto;">
                <table id="daily-detail-table" class="min-w-full divide-y divide-gray-200 text-xs">
                    <thead class="bg-gray-100 sticky-header">
                        <tr>
                            <th class="px-3 py-2 text-left text-gray-500">Fecha</th>
                            <th class="px-3 py-2 text-left text-gray-500">Turno</th>
                            <th class="px-3 py-2 text-center text-gray-500">Es Feriado</th>
                            <th class="px-3 py-2 text-right text-gray-500">H. Eq. Base</th>
                            <th class="px-3 py-2 text-center text-gray-500">H. Extra (Reales)</th>
                            <th class="px-3 py-2 text-right text-gray-500">H. Eq. Total</th>
                            <th class="px-3 py-2 text-right text-gray-500">Monto Bruto</th>
                        </tr>
                    </thead>
                    <tbody id="daily-detail-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Filas de detalle diario aquí -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Script de Firebase y Lógica de la Aplicación -->
    <script type="module">
        // =====================================================================
        // CONFIGURACIÓN, CONSTANTES Y ESTADO GLOBAL
        // =====================================================================

        // Constantes de negocio
        const EXTRA_HOUR_MULTIPLIER = 1.5;
        const HOLIDAY_WORKED_EQUIV_HOURS = 32;
        const HOLIDAY_FREE_EQUIV_HOURS = 8;
        
        // Variables de entorno de Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // **IMPORTANTE:** Usar la configuración de Firebase inyectada por el entorno
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        
        // Instancias de Firebase y Estado de Autenticación
        let app;
        let auth;
        let db;
        let userId = null;
        let userName = 'Usuario Temporal';
        let isAuthReady = false;
        let isFirebaseActive = true; 
        
        // Estado Global de la Aplicación (Simulando React state)
        let appState = {
            config: {
                month: new Date().getDate() === 1 ? new Date().getMonth() : new Date().getMonth() + 1,
                year: new Date().getFullYear(),
                valorHora: 3758,
                lastFrancoDate: getYesterdayDate(),
                initialTurn: 'Mañana',
                discountRate: 0.18,
            },
            extraHours: {},
            manualHolidays: {},
            calculationResult: null,
            isLoading: false,
            status: null,
        };

        // Elementos del DOM
        const statusEl = document.getElementById('status-message');
        const summaryCardsEl = document.getElementById('summary-cards');
        const francosInfoEl = document.getElementById('francos-info');
        const tbodyEl = document.getElementById('daily-detail-tbody');
        const resultsSectionEl = document.getElementById('results-section');
        const calculateButtonEl = document.getElementById('calculate-schedule-button');
        const generatePdfButtonEl = document.getElementById('generate-pdf-button');
        const userInfoEl = document.getElementById('user-info');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');

        // =====================================================================
        // UTILIDADES Y AYUDANTES DE UI
        // =====================================================================

        function getYesterdayDate() {
            const date = new Date();
            date.setDate(date.getDate() - 1);
            return formatDateForInput(date);
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDateForDisplay(date) {
            return date.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatCurrency(amount) {
            const number = parseFloat(amount) || 0;
            return number.toLocaleString('es-AR', { style: 'currency', currency: 'ARS' });
        }
        
        function formatNumber(amount, decimals = 2) {
             const number = parseFloat(amount) || 0;
             return number.toLocaleString('es-AR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }

        function getTurnEquivalencies(dayOfWeek, turnType) {
            let realHours = 8;
            let equivalentHours = 8; 
            let turnBaseName = turnType;
            
            if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Lunes a Viernes
                switch (turnType) {
                    case 'Mañana':
                    case 'Tarde': equivalentHours = 8; break;
                    case 'Noche': equivalentHours = 12; break; // Recargo Nocturno
                }
            } else if (dayOfWeek === 6) { // Sábado
                switch (turnType) {
                    case 'Mañana': realHours = 8; equivalentHours = 9; break;
                    case 'Tarde': realHours = 9; equivalentHours = 12; break;
                    case 'Noche': realHours = 8; equivalentHours = 16; break;
                }
            } else if (dayOfWeek === 0) { // Domingo
                turnBaseName = 'Domingo ' + turnType;
                switch (turnType) {
                    case 'Mañana':
                    case 'Tarde': realHours = 8; equivalentHours = 24; break; // Recargo Dominical (Triple)
                    case 'Noche': realHours = 8; equivalentHours = 28; break; // Recargo Dominical + Nocturno
                }
            }
            return { realHours, equivalentHours, turnBaseName };
        }

        function updateStatus(type, message) {
            appState.status = { type, message };
            if (!message) {
                statusEl.classList.add('hidden');
                return;
            }
            
            statusEl.classList.remove('hidden');
            let colorClass = "";
            switch (type) {
                case 'success': colorClass = "bg-green-100 text-green-700"; break;
                case 'error': colorClass = "bg-red-100 text-red-700"; break;
                case 'info': colorClass = "bg-blue-100 text-blue-700"; break;
                default: colorClass = "bg-gray-100 text-gray-700"; break;
            }
            statusEl.className = `p-3 rounded-lg mt-4 font-semibold text-sm ${colorClass}`;
            statusEl.textContent = message;
        }

        function setLoading(loading) {
            appState.isLoading = loading;
            const text = loading ? 'Calculando...' : 'Generar/Actualizar Horario y Calcular Salario';
            calculateButtonEl.textContent = text;
            calculateButtonEl.disabled = loading;

            if (loading) {
                calculateButtonEl.classList.add('bg-indigo-400');
                calculateButtonEl.classList.remove('bg-indigo-700', 'hover:bg-indigo-800');
            } else {
                calculateButtonEl.classList.remove('bg-indigo-400');
                calculateButtonEl.classList.add('bg-indigo-700', 'hover:bg-indigo-800');
            }
        }
        
        function updateAuthUI() {
            // VERIFICACIÓN DE SEGURIDAD CRÍTICA
            if (!isAuthReady) {
                userInfoEl.textContent = 'Cargando Autenticación...';
                googleLoginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                return;
            }
            
            // Si la instancia de auth no existe (porque Firebase falló), solo mostramos el estado local
            if (!auth) {
                userInfoEl.textContent = `Sesión: ${userName} (Local)`;
                googleLoginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                return;
            }

            const user = auth.currentUser;
            
            if (userId && user && !user.isAnonymous) {
                // Usuario autenticado (Google)
                userInfoEl.textContent = `Hola, ${userName} (${userId.substring(0, 4)}...)`;
                googleLoginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                // Usuario anónimo (Canvas token) o no autenticado
                userInfoEl.textContent = `Sesión: ${userName} (${userId ? userId.substring(0, 4) + '...' : 'Local'})`;
                googleLoginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }
        }
        
        function updateUIFromState() {
            // 1. Actualizar Inputs
            const config = appState.config;
            document.getElementById('input-year').value = config.year;
            document.getElementById('input-valorHora').value = config.valorHora;
            document.getElementById('input-lastFrancoDate').value = config.lastFrancoDate;
            document.getElementById('input-initialTurn').value = config.initialTurn;
            document.getElementById('input-discountRate').value = config.discountRate;
            
            // 2. Llenar opciones de meses
            const monthSelect = document.getElementById('input-month');
            
            if (monthSelect.options.length === 0 || monthSelect.options.length !== 12) {
                 monthSelect.innerHTML = ''; 
                Array.from({ length: 12 }, (_, i) => i + 1).forEach(m => {
                    const option = document.createElement('option');
                    option.value = m;
                    // El mes es m-1 porque Date usa 0-11
                    option.textContent = new Date(config.year, m - 1).toLocaleDateString('es-AR', { month: 'long' });
                    monthSelect.appendChild(option);
                });
            } 
            monthSelect.value = config.month;

            // 3. Mostrar Resultados
            renderCalculationResults();

            // 4. Actualizar Status y Loading
            updateStatus(appState.status?.type, appState.status?.message);
            setLoading(appState.isLoading);
            
            // 5. Actualizar UI de Autenticación
            updateAuthUI();
        }

        // =====================================================================
        // INTEGRACIÓN FIREBASE (Autenticación y Persistencia)
        // =====================================================================

        // Importaciones de Firebase (Módulos)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Rutas de Firestore
        function getConfigDocRef() {
            if (!db || !userId) return null;
            // Colección privada: /artifacts/{appId}/users/{userId}/config/salary
            return doc(db, 'artifacts', appId, 'users', userId, 'config', 'salary');
        }
        
        function getDataDocRef(monthDocId) {
            if (!db || !userId) return null;
            // Colección privada: /artifacts/{appId}/users/{userId}/data/{monthDocId}
            return doc(db, 'artifacts', appId, 'users', userId, 'data', monthDocId);
        }

        // 1. Inicialización y Autenticación
        const initFirebase = async () => {
            updateStatus('info', 'Intentando conectar a Firebase para persistencia...');
            
            if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.projectId) {
                 console.error("Firebase Config está vacío o incompleto.");
                 isFirebaseActive = false;
                 // Asegurar que userId se inicializa para modo local
                 userId = crypto.randomUUID(); 
                 isAuthReady = true; 
                 userName = `Local`;
                 updateStatus('error', 'Error: La configuración de Firebase está incompleta. Usando modo local sin persistencia.');
                 calculateSchedule(false);
                 updateUIFromState();
                 return;
            }

            try {
                app = initializeApp(firebaseConfig); 
                auth = getAuth(app);
                db = getFirestore(app);
                
                // setLogLevel('Debug'); // Descomentar para depuración

                // Intentar autenticación con el token del entorno si está presente.
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                     // Si no hay token del entorno, Firebase usará el estado persistente o iniciará como anónimo.
                    console.log("No hay token inicial. El estado será manejado por onAuthStateChanged.");
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userName = user.displayName || user.email || (user.isAnonymous ? 'Temporal (Token)' : 'Usuario');
                        isAuthReady = true;
                        updateStatus('success', `Sesión iniciada. Bienvenido, ${userName}!`);
                        setupDataListeners(); 
                    } else {
                        // Si el usuario cierra sesión (Google Sign-Out), volvemos a anónimo (para mantener la compatibilidad del entorno)
                        signInAnonymously(auth).then(anonUser => {
                            userId = anonUser.user.uid;
                            userName = 'Temporal (Anónimo)';
                            isAuthReady = true; 
                            updateStatus('info', 'Sesión iniciada anónimamente.');
                            setupDataListeners();
                        }).catch(e => {
                            // Fallback total si la autenticación anónima falla
                            console.error("Fallo de autenticación anónima:", e);
                            userId = crypto.randomUUID(); 
                            userName = 'Local';
                            isAuthReady = true;
                            isFirebaseActive = false;
                            updateStatus('error', 'Error de sesión. Usando ID local sin persistencia.');
                            calculateSchedule(false);
                        });
                    }
                    updateUIFromState();
                });

            } catch (error) {
                console.error("Error crítico al inicializar Firebase o al autenticar:", error);
                updateStatus('error', `Error Crítico: ${error.code || error.message}. Usando modo local.`);
                isFirebaseActive = false;
                userId = crypto.randomUUID(); 
                isAuthReady = true; 
                userName = 'Local (Error)';
                calculateSchedule(false);
                updateUIFromState();
            }
        };

        // --- FUNCIONES DE AUTENTICACIÓN CON GOOGLE ---
        
        googleLoginBtn.addEventListener('click', signInWithGoogle);
        logoutBtn.addEventListener('click', signOutUser);

        async function signInWithGoogle() {
            if (!auth) {
                 updateStatus('error', 'Firebase Auth no está inicializado.');
                 return;
            }
            updateStatus('info', 'Iniciando sesión con Google...');
            try {
                const provider = new GoogleAuthProvider();
                // Solicitar que se mantenga la sesión
                await signInWithPopup(auth, provider);
                // onAuthStateChanged se encargará de actualizar el estado y los datos
            } catch (error) {
                // Aquí capturamos el auth/unauthorized-domain si ocurre
                console.error("Error al iniciar sesión con Google:", error);
                if (error.code === 'auth/popup-closed-by-user') {
                    updateStatus('info', 'Ventana de Google cerrada. Intenta de nuevo.');
                } else if (error.code === 'auth/unauthorized-domain') {
                    updateStatus('error', 'Error de dominio no autorizado. Revise la consola de Firebase.');
                } else {
                    updateStatus('error', `Error de Google Auth: ${error.code || error.message}`);
                }
            }
        }
        
        async function signOutUser() {
            if (!auth) return;
            try {
                await signOut(auth);
                // onAuthStateChanged se encargará de re-autenticar anónimamente
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
                updateStatus('error', `Error al cerrar sesión: ${error.message}`);
            }
        }


        // 2. Funciones de Carga y Guardado
        function saveConfig() {
            if (!isFirebaseActive || !isAuthReady || !userId || !db) return;
            
            const configRef = getConfigDocRef();
            if (!configRef) return;

            const dataToSave = { ...appState.config };
            dataToSave.valorHora = Number(dataToSave.valorHora);
            dataToSave.discountRate = Number(dataToSave.discountRate);
            dataToSave.month = Number(dataToSave.month); 
            dataToSave.year = Number(dataToSave.year);

            setDoc(configRef, dataToSave, { merge: true })
                .catch(error => {
                    console.error("Error saving config:", error);
                    updateStatus('error', "Error al guardar configuración.");
                });
        }
        
        function saveData() {
            if (!isFirebaseActive || !isAuthReady || !userId || !db) return;
            
            const config = appState.config;
            const monthDocId = `${config.year}-${String(config.month).padStart(2, '0')}`;
            const dataRef = getDataDocRef(monthDocId);
            if (!dataRef) return;
            
            setDoc(dataRef, { 
                extras: appState.extraHours,
                holidayFlags: appState.manualHolidays
            }, { merge: true })
            .catch(error => {
                console.error("Error saving month data:", error);
                updateStatus('error', "Error al guardar datos de horas/feriados.");
            });
        }
        
        // 3. Listeners de Datos (onSnapshot)
        let unsubscribeConfig = null;
        let unsubscribeData = null;

        function setupDataListeners() {
            if (!isFirebaseActive || !isAuthReady || !userId || !db) {
                // Si no hay Firebase activo o autenticación lista, solo usa los datos locales.
                calculateSchedule(false);
                return;
            }
            
            // 3.1 Listener de Configuración
            if (unsubscribeConfig) unsubscribeConfig();
            const configRef = getConfigDocRef();
            if (configRef) {
                unsubscribeConfig = onSnapshot(configRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        appState.config = { 
                            ...appState.config, ...data,
                            // Asegurarse de que los valores numéricos se mantengan
                            valorHora: Number(data.valorHora) || appState.config.valorHora,
                            discountRate: Number(data.discountRate) || appState.config.discountRate,
                            month: Number(data.month) || appState.config.month,
                            year: Number(data.year) || appState.config.year,
                        };
                        updateUIFromState();
                    } else {
                        saveConfig(); // Guardar por primera vez
                    }
                }, (error) => {
                    console.error("Error fetching config:", error);
                    updateStatus('error', "Error al cargar configuración.");
                });
            }

            // 3.2 Listener de Datos (Horas Extra y Feriados Manuales)
            if (unsubscribeData) unsubscribeData();
            const config = appState.config;
            const monthDocId = `${config.year}-${String(config.month).padStart(2, '0')}`;
            const dataRef = getDataDocRef(monthDocId);
            if (dataRef) {
                unsubscribeData = onSnapshot(dataRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        appState.extraHours = data.extras || {};
                        appState.manualHolidays = data.holidayFlags || {};
                    } else {
                        appState.extraHours = {}; 
                        appState.manualHolidays = {};
                        // No es necesario guardar aquí, ya que el cálculo forzará la persistencia de los nuevos valores
                    }
                    updateUIFromState();
                    // Volver a calcular para reflejar los datos recién cargados (si ya había un cálculo previo)
                    if (appState.calculationResult) calculateSchedule(false); 
                }, (error) => {
                    console.error("Error fetching month data:", error);
                    updateStatus('error', "Error al cargar datos de mes.");
                });
            }
        }

        // =====================================================================
        // MANEJADORES DE EVENTOS DE INTERACCIÓN (INPUTS DE LA TABLA)
        // =====================================================================

        function handleConfigChange() {
            const newConfig = {
                month: parseInt(document.getElementById('input-month').value),
                year: parseInt(document.getElementById('input-year').value),
                valorHora: parseFloat(document.getElementById('input-valorHora').value) || appState.config.valorHora,
                lastFrancoDate: document.getElementById('input-lastFrancoDate').value,
                initialTurn: document.getElementById('input-initialTurn').value,
                discountRate: parseFloat(document.getElementById('input-discountRate').value) || appState.config.discountRate,
            };
            
            const oldDocId = `${appState.config.year}-${String(appState.config.month).padStart(2, '0')}`;
            const newDocId = `${newConfig.year}-${String(newConfig.month).padStart(2, '0')}`;

            appState.config = newConfig;
            saveConfig();
            
            if (oldDocId !== newDocId && isFirebaseActive) {
                // Si el mes/año cambió y estamos activos en Firebase, cambiamos el listener de datos.
                setupDataListeners(); 
            } else {
                updateUIFromState();
                calculateSchedule(false);
            }
        }

        window.handleConfigChange = handleConfigChange;
        
        window.handleExtraChange = function(dateKey, inputElement) {
            const hours = parseFloat(inputElement.value) || 0;
            appState.extraHours[dateKey] = hours;
            saveData(); 
            calculateSchedule(false);
        }

        window.handleHolidayChange = function(dateKey, checkboxElement) {
            if (checkboxElement.checked) {
                appState.manualHolidays[dateKey] = true;
            } else {
                delete appState.manualHolidays[dateKey];
            }
            saveData();
            calculateSchedule(false);
        }

        // =====================================================================
        // LÓGICA DE CÁLCULO (Mis funciones de negocio)
        // =====================================================================
        
        calculateButtonEl.addEventListener('click', () => calculateSchedule(true));

        function calculateSchedule(initialCalculation = true) {
            if (initialCalculation) setLoading(true);

            const { month, year, lastFrancoDate, initialTurn, valorHora, discountRate } = appState.config;
            
            if (!lastFrancoDate || !valorHora || isNaN(valorHora) || valorHora <= 0) {
                 if (initialCalculation) setLoading(false);
                 updateStatus('error', 'Por favor, ingrese un Valor de Hora Bruta y una Fecha de Último Franco válidos.');
                 appState.calculationResult = null;
                 resultsSectionEl.classList.add('hidden');
                 updateUIFromState();
                 return;
            }

            let currentDate = new Date(year, month - 1, 1, 0, 0, 0);
            
            const lastFrancoDay2 = new Date(lastFrancoDate + 'T00:00:00');
            const dayAfterFranco = new Date(lastFrancoDay2.getTime());
            dayAfterFranco.setDate(dayAfterFranco.getDate() + 1); 

            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            let dailyResults = [];
            let francosDates = [];
            
            const masterCycle = [
                'Mañana', 'Mañana', 'Mañana', 'Mañana', 'Mañana', 'Mañana', 'Franco', 'Franco', 
                'Noche', 'Noche', 'Noche', 'Noche', 'Noche', 'Noche', 'Franco', 'Franco', 
                'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Franco', 'Franco'
            ];
            
            let baseOffset = 0;
            if (initialTurn === 'Noche') baseOffset = 8;
            else if (initialTurn === 'Tarde') baseOffset = 16;
            
            const diffTime = currentDate.getTime() - dayAfterFranco.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            let startOffset = (baseOffset + diffDays) % 24; 
            if (startOffset < 0) startOffset += 24; 

            let dayCounter = 0;
            const daysInMonth = new Date(year, month, 0).getDate();

            while (dayCounter < daysInMonth) {
                const dayOfWeek = currentDate.getDay(); 
                // Usamos formato DD/MM/YYYY para la clave de datos (compatible con el input)
                const dateKeyForSave = formatDateForDisplay(currentDate); 
                const dateKeyForInput = formatDateForInput(currentDate);
                
                const isHolidayManual = appState.manualHolidays[dateKeyForSave] === true; 
                
                const cycleStatus = masterCycle[startOffset]; 
                
                let turnBaseName = cycleStatus;
                let realHours = 0;
                let equivalentHours = 0;
                
                if (cycleStatus === 'Franco') {
                    if (isHolidayManual) {
                        turnBaseName = `FERIADO - Franco`;
                        equivalentHours = HOLIDAY_FREE_EQUIV_HOURS; 
                        francosDates.push(dateKeyForSave + ' (Feriado)');
                    } else {
                         turnBaseName = `Franco`;
                         francosDates.push(dateKeyForSave);
                    }
                } 
                else {
                    if (isHolidayManual) {
                        turnBaseName = `FERIADO - ${cycleStatus}`;
                        realHours = 8; 
                        equivalentHours = HOLIDAY_WORKED_EQUIV_HOURS;
                    } else {
                        const equivalences = getTurnEquivalencies(dayOfWeek, cycleStatus);
                        realHours = equivalences.realHours;
                        equivalentHours = equivalences.equivalentHours;
                        turnBaseName = equivalences.turnBaseName;
                    }
                }
                
                dailyResults.push({
                    date: dateKeyForSave,
                    dateKey: dateKeyForInput, // Clave para el input de Fecha
                    day: dayNames[dayOfWeek],
                    turn: turnBaseName,
                    isHoliday: isHolidayManual,
                    realHours: realHours,
                    equivHoursBase: equivalentHours, 
                });
                
                startOffset = (startOffset + 1) % 24;
                currentDate.setDate(currentDate.getDate() + 1);
                dayCounter++;
            }
            
            let totalEquivalentHours = 0;
            let totalExtraHoursReal = 0;
            const hourlyRate = parseFloat(valorHora) || 0;

            const finalDailyResults = dailyResults.map(day => {
                // Usamos la clave de display (DD/MM/YYYY) para buscar en extraHours
                const dayExtraReal = appState.extraHours[day.date] || 0; 
                
                let dayExtraEquivalent = 0;
                
                if (dayExtraReal > 0) {
                    dayExtraEquivalent = (dayExtraReal * EXTRA_HOUR_MULTIPLIER);
                    totalExtraHoursReal += dayExtraReal;
                }
                
                const finalEquivHours = day.equivHoursBase + dayExtraEquivalent;
                const finalDailyBruto = finalEquivHours * hourlyRate;

                totalEquivalentHours += finalEquivHours;

                return {
                    ...day,
                    extraReal: dayExtraReal, 
                    extraEquiv: dayExtraEquivalent, 
                    equivHoursFinal: finalEquivHours, 
                    dailyBruto: finalDailyBruto, 
                };
            });

            const totalBruto = totalEquivalentHours * hourlyRate;
            const totalDescuento = totalBruto * discountRate;
            const totalNeto = totalBruto - totalDescuento;

            appState.calculationResult = {
                dailyResults: finalDailyResults,
                francosDates,
                totalEquivalentHours,
                totalExtraHoursReal,
                totalBruto,
                totalDescuento,
                totalNeto,
                discountRate: discountRate * 100,
            };

            if (initialCalculation) setLoading(false);
            updateUIFromState();
            if (initialCalculation) updateStatus('success', `Cálculo generado para ${dailyResults.length} días. ¡Añade tus extras y feriados!`);
        }
        
        // =====================================================================
        // RENDERIZADO DE RESULTADOS (Se mantiene igual, solo llama a las funciones)
        // =====================================================================

        function renderCalculationResults() {
             const result = appState.calculationResult;
            if (!result) {
                resultsSectionEl.classList.add('hidden');
                return;
            }

            resultsSectionEl.classList.remove('hidden');

            // 1. Renderizar Cards de Resumen
            summaryCardsEl.innerHTML = `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">H. Eq. Totales</p>
                    <p class="text-lg text-gray-900 font-extrabold">${formatNumber(result.totalEquivalentHours)}</p>
                </div>
                <div class="p-3 bg-red-50 rounded-lg">
                    <p class="text-gray-500">Desc. (${result.discountRate.toFixed(0)}%)</p>
                    <p class="text-lg text-red-600 font-extrabold">${formatCurrency(result.totalDescuento)}</p>
                </div>
                <div class="col-span-1 p-3 bg-indigo-50 rounded-lg">
                    <p class="text-gray-500">Bruto Total</p>
                    <p class="text-xl text-indigo-600 font-extrabold">${formatCurrency(result.totalBruto)}</p>
                </div>
                <div class="col-span-1 p-3 bg-green-100 rounded-lg shadow-md">
                    <p class="text-green-700 font-semibold">NETO (EN MANO)</p>
                    <p class="text-2xl text-green-800 font-extrabold">${formatCurrency(result.totalNeto)}</p>
                </div>
            `;

            // 2. Renderizar Información de Francos
            francosInfoEl.innerHTML = `
                <p class="font-bold text-yellow-800">Días Francos en el Mes (${result.francosDates.length}):</p>
                <p class="mt-1">${result.francosDates.join(' • ')}</p>
            `;

            // 3. Renderizar Tabla de Detalle Diario 
            tbodyEl.innerHTML = result.dailyResults.map(day => {
                // Usamos la clave de display (DD/MM/YYYY) para guardar/cargar datos
                const dateKeyForSave = day.date; 
                const dayExtraReal = appState.extraHours[dateKeyForSave] || 0;
                const isFeriadoManual = appState.manualHolidays[dateKeyForSave] === true;
                
                const isFranco = day.turn.includes('Franco');
                
                let rowClasses = 'hover:bg-gray-50';
                if (isFranco && !isFeriadoManual) {
                    rowClasses = 'bg-yellow-50 hover:bg-yellow-100 font-semibold text-yellow-800';
                } else if (isFeriadoManual) {
                    rowClasses = 'bg-red-100 hover:bg-red-200 font-extrabold text-red-700';
                }

                return `
                    <tr class="${rowClasses}">
                        <td class="px-3 py-2 whitespace-nowrap text-gray-900">${day.date} - ${day.day.substring(0, 3)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-gray-700">${day.turn}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-center">
                            <input type="checkbox" 
                                class="form-checkbox h-4 w-4 text-red-600 transition duration-150 ease-in-out"
                                ${isFeriadoManual ? 'checked' : ''}
                                onchange="handleHolidayChange('${dateKeyForSave}', this)"
                            >
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-right">${formatNumber(day.equivHoursBase, 2)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-center">
                            <input type="number" 
                                value="${dayExtraReal || ''}"
                                class="w-16 text-center border rounded p-1 text-xs"
                                step="0.5" min="0"
                                onchange="handleExtraChange('${dateKeyForSave}', this)"
                            >
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-right font-bold ${isFeriadoManual ? 'text-red-700' : ''}">${formatNumber(day.equivHoursFinal, 2)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-right font-bold">${formatCurrency(day.dailyBruto)}</td>
                    </tr>
                `;
            }).join('');
        }
        
        // Función de generación de PDF (Se mantiene igual)
        generatePdfButtonEl.addEventListener('click', generatePDFReport);
        function generatePDFReport() {
            const result = appState.calculationResult;
            if (!result) return updateStatus('error', 'Debe generar el cálculo antes de descargar el reporte.');

            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined') {
                 return updateStatus('error', 'Error al cargar librerías de PDF. Recargue la página.');
            }
            
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF();
            
            const { month, year } = appState.config;
            const monthName = new Date(year, month - 1).toLocaleDateString('es-AR', { month: 'long', year: 'numeric' });
            
            const title = `Reporte Salarial 6x2 - ${monthName}`;
            
            doc.setFontSize(16);
            doc.text(title, 14, 20);
            
            doc.setFontSize(10);
            doc.text(`Valor Hora Bruta: ${formatCurrency(appState.config.valorHora)}`, 14, 26);
            doc.text(`Desc. Afiliación: ${result.discountRate.toFixed(0)}%`, 14, 31);
            doc.text(`Horas Extra Reales: ${formatNumber(result.totalExtraHoursReal)}`, 14, 36);

            doc.autoTable({
                startY: 45,
                head: [['Total Horas Eq.', 'Bruto Total', 'Descuento', 'NETO FINAL']],
                body: [[
                    formatNumber(result.totalEquivalentHours, 2),
                    formatCurrency(result.totalBruto),
                    formatCurrency(result.totalDescuento),
                    formatCurrency(result.totalNeto),
                ]],
                theme: 'striped',
                headStyles: { fillColor: [55, 48, 163] }, 
                columnStyles: {
                    0: { fontStyle: 'bold' },
                    3: { fontStyle: 'bold', fillColor: [187, 247, 208] }, 
                },
                styles: { fontSize: 10 }
            });

            const finalY = doc.autoTable.previous.finalY;
            doc.setFontSize(12);
            doc.text('Detalle Diario de Horas y Turnos', 14, finalY + 15);
            
            const tableData = result.dailyResults.map(d => [
                d.date,
                d.day.substring(0, 3),
                d.turn,
                appState.manualHolidays[d.date] === true ? 'Sí' : 'No', 
                formatNumber(d.equivHoursBase, 2),
                d.extraReal > 0 ? formatNumber(d.extraReal, 1) : '',
                formatNumber(d.equivHoursFinal, 2),
                formatCurrency(d.dailyBruto)
            ]);
            
            doc.autoTable({
                startY: finalY + 20,
                head: [['Fecha', 'Día', 'Turno', 'Feriado?', 'H. Eq. Base', 'H. Extra (R)', 'H. Eq. Total', 'Monto Bruto']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [75, 85, 99] }, 
                columnStyles: {
                    4: { halign: 'right' },
                    5: { halign: 'center' },
                    6: { halign: 'right', fontStyle: 'bold' },
                    7: { halign: 'right', fontStyle: 'bold' },
                },
                didParseCell: (data) => {
                    const turn = data.row.raw[2];
                    const isHoliday = data.row.raw[3] === 'Sí';

                    if (turn.includes('Franco') && !isHoliday) {
                        data.cell.styles.fillColor = [255, 251, 235]; 
                    }
                    if (isHoliday) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.textColor = [185, 28, 28]; 
                        data.cell.styles.fillColor = [254, 226, 226];
                    }
                },
                styles: { fontSize: 8 }
            });

            doc.save(`Reporte_6x2_${monthName.replace(/\s/g, '_')}.pdf`);
        }
        
        // =====================================================================
        // INICIO DE LA APLICACIÓN
        // =====================================================================
        
        window.onload = () => {
            updateUIFromState();
            initFirebase();
        };

    </script>
</body>
</html>
