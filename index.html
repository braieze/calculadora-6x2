<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Salarial 6x2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuraciones de fuente */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .input-style {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            width: 100%;
            transition: border-color 0.15s;
        }
        .input-style:focus {
            border-color: #4f46e5;
            outline: none;
            ring: 2px;
            ring-color: #6366f1;
        }
        /* Estilo para la tabla pegajosa */
        .sticky-header th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

</head>
<body class="min-h-screen flex items-start justify-center p-4">

    <div id="app-container" class="w-full max-w-5xl bg-white rounded-xl card p-6 md:p-8 mt-4">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-2 mb-4">
            <h1 class="text-2xl font-bold text-indigo-700">
                Calculadora Salarial 6x2
            </h1>
            <div id="user-info" class="text-sm text-gray-600 mt-2 md:mt-0"></div>
        </div>
        
        <div id="status-message" class="hidden p-3 rounded-lg mt-4 font-semibold text-sm"></div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
            <div>
                <label class="block text-sm font-medium text-gray-700">Mes</label>
                <select id="input-month" name="month" class="input-style" onchange="handleConfigChange()">
                    </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">Año</label>
                <input id="input-year" type="number" name="year" class="input-style" onchange="handleConfigChange()">
            </div>
            <div class="col-span-2 md:col-span-1">
                <label class="block text-sm font-medium text-gray-700">Valor Hora Bruta ($)</label>
                <input id="input-valorHora" type="number" name="valorHora" class="input-style" onchange="handleConfigChange()" step="0.01">
            </div>
            <div class="col-span-2 md:col-span-1">
                <label class="block text-sm font-medium text-gray-700">Desc. Afiliación</label>
                <select id="input-discountRate" name="discountRate" class="input-style" onchange="handleConfigChange()">
                    <option value="0.18">No Afiliado (18%)</option>
                    <option value="0.16">Afiliado (16%)</option>
                </select>
            </div>
            <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700">Fecha del Último Franco (Día 2)</label>
                <input id="input-lastFrancoDate" type="date" name="lastFrancoDate" class="input-style" onchange="handleConfigChange()">
            </div>
            <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700">Turno Post-Franco</label>
                <select id="input-initialTurn" name="initialTurn" class="input-style" onchange="handleConfigChange()">
                    <option value="Mañana">Mañana</option>
                    <option value="Noche">Noche</option>
                    <option value="Tarde">Tarde</option>
                </select>
            </div>
        </div>

        <button id="calculate-schedule-button" class="w-full py-3 mt-2 rounded-lg text-white font-bold transition duration-150 bg-indigo-700 hover:bg-indigo-800">
            Generar/Actualizar Horario y Calcular Salario
        </button>

        <div id="results-section" class="hidden mt-6 border-t pt-6">
            <h2 class="text-xl font-bold text-indigo-700 mb-4">Resumen de Ganancias</h2>
            <div id="summary-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm font-medium mb-6">
                </div>

            <div id="francos-info" class="p-3 bg-yellow-50 rounded-lg text-sm mb-4">
                </div>

            <button id="generate-pdf-button" class="w-full py-2 mb-6 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold transition duration-150 flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Descargar Reporte PDF
            </button>
            
            <h3 class="text-lg font-bold text-gray-800 mb-3 border-t pt-4">Detalle Diario, Feriados y Horas Extra</h3>
            <p class="text-xs text-red-600 mb-3">
                ⚠️ Marca la casilla "Es Feriado" para aplicar la equivalencia de 32 Horas (si trabajas) o 8 Horas (si es Franco).
            </p>
            <div id="daily-detail-table-container" class="overflow-x-auto rounded-lg border" style="max-height: 400px; overflow-y: auto;">
                <table id="daily-detail-table" class="min-w-full divide-y divide-gray-200 text-xs">
                    <thead class="bg-gray-100 sticky-header">
                        <tr>
                            <th class="px-3 py-2 text-left text-gray-500">Fecha</th>
                            <th class="px-3 py-2 text-left text-gray-500">Turno</th>
                            <th class="px-3 py-2 text-center text-gray-500">Es Feriado</th>
                            <th class="px-3 py-2 text-right text-gray-500">H. Eq. Base</th>
                            <th class="px-3 py-2 text-center text-gray-500">H. Extra (Reales)</th>
                            <th class="px-3 py-2 text-right text-gray-500">H. Eq. Total</th>
                            <th class="px-3 py-2 text-right text-gray-500">Monto Bruto</th>
                        </tr>
                    </thead>
                    <tbody id="daily-detail-tbody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <script type="module">
        // =====================================================================
        // CONFIGURACIÓN, CONSTANTES Y ESTADO GLOBAL
        // =====================================================================

        // Constantes de negocio
        const EXTRA_HOUR_MULTIPLIER = 1.5;
        const HOLIDAY_WORKED_EQUIV_HOURS = 32;
        const HOLIDAY_FREE_EQUIV_HOURS = 8;
        
        // Variables de entorno de Canvas (Simulación para que sea portable)
        // ** NOTA IMPORTANTE: Estas variables deben ser definidas ANTES de que
        // se cargue este script 'module' si se usa en un entorno como Canvas.
        // Aquí se definen valores por defecto para que el código sea ejecutable
        // como un archivo HTML estático.
        const appId = 'calc-6x2-prod'; 
        const firebaseConfig = {
            apiKey: "TU_API_KEY_DE_FIREBASE", // REEMPLAZAR
            authDomain: "TU_AUTH_DOMAIN_DE_FIREBASE", // REEMPLAZAR
            projectId: "TU_PROJECT_ID_DE_FIREBASE", // REEMPLAZAR
            storageBucket: "TU_STORAGE_BUCKET_DE_FIREBASE", // REEMPLAZAR
            messagingSenderId: "TU_MESSAGING_SENDER_ID_DE_FIREBASE", // REEMPLAZAR
            appId: "TU_APP_ID_DE_FIREBASE" // REEMPLAZAR
        };
        const initialAuthToken = null; 
        
        // Instancias de Firebase y Estado de Autenticación
        let app;
        let auth;
        let db;
        let userId = null;
        let isAuthReady = false;

        // Estado Global de la Aplicación (Simulando React state)
        let appState = {
            config: {
                month: new Date().getMonth() + 1,
                year: new Date().getFullYear(),
                valorHora: 3758,
                lastFrancoDate: getYesterdayDate(),
                initialTurn: 'Mañana',
                discountRate: 0.18,
            },
            extraHours: {},      // { "DD/MM/YYYY": 2, ... }
            manualHolidays: {}, // { "DD/MM/YYYY": true, ... }
            calculationResult: null,
            isLoading: false,
            status: null,
        };

        // Elementos del DOM
        const statusEl = document.getElementById('status-message');
        const summaryCardsEl = document.getElementById('summary-cards');
        const francosInfoEl = document.getElementById('francos-info');
        const tbodyEl = document.getElementById('daily-detail-tbody');
        const resultsSectionEl = document.getElementById('results-section');
        const calculateButtonEl = document.getElementById('calculate-schedule-button');
        const generatePdfButtonEl = document.getElementById('generate-pdf-button');

        // =====================================================================
        // UTILIDADES Y AYUDANTES DE UI
        // =====================================================================

        function getYesterdayDate() {
            const date = new Date();
            date.setDate(date.getDate() - 1);
            return formatDateForInput(date);
        }

        function formatDateForInput(date) {
            // Formato YYYY-MM-DD para input[type="date"]
            return date.toISOString().split('T')[0];
        }

        function formatDateForDisplay(date) {
            // Formato DD/MM/YYYY
            return date.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatCurrency(amount) {
            return amount.toLocaleString('es-AR', { style: 'currency', currency: 'ARS' });
        }
        
        function formatNumber(amount, decimals = 2) {
             return amount.toLocaleString('es-AR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }


        // Lógica de equivalencias de horas según el día y turno (6x2)
        function getTurnEquivalencies(dayOfWeek, turnType) {
            let realHours = 8;
            let equivalentHours = 8; 
            let turnBaseName = turnType;
            
            if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Lunes a Viernes
                switch (turnType) {
                    case 'Mañana':
                    case 'Tarde': equivalentHours = 8; break;
                    case 'Noche': equivalentHours = 12; break; // Recargo Nocturno
                }
            } else if (dayOfWeek === 6) { // Sábado
                switch (turnType) {
                    case 'Mañana': realHours = 8; equivalentHours = 9; break;
                    case 'Tarde': realHours = 9; equivalentHours = 12; break;
                    case 'Noche': realHours = 8; equivalentHours = 16; break;
                }
            } else if (dayOfWeek === 0) { // Domingo
                turnBaseName = 'Domingo ' + turnType;
                switch (turnType) {
                    case 'Mañana':
                    case 'Tarde': realHours = 8; equivalentHours = 24; break; // Recargo Dominical (Triple)
                    case 'Noche': realHours = 8; equivalentHours = 28; break; // Recargo Dominical + Nocturno
                }
            }
            return { realHours, equivalentHours, turnBaseName };
        }

        function updateStatus(type, message) {
            appState.status = { type, message };
            if (!message) {
                statusEl.classList.add('hidden');
                return;
            }
            
            statusEl.classList.remove('hidden');
            let colorClass = "";
            switch (type) {
                case 'success': colorClass = "bg-green-100 text-green-700"; break;
                case 'error': colorClass = "bg-red-100 text-red-700"; break;
                case 'info': colorClass = "bg-blue-100 text-blue-700"; break;
                default: colorClass = "bg-gray-100 text-gray-700"; break;
            }
            statusEl.className = `p-3 rounded-lg mt-4 font-semibold text-sm ${colorClass}`;
            statusEl.textContent = message;
        }

        function setLoading(loading) {
            appState.isLoading = loading;
            const text = loading ? 'Calculando...' : 'Generar/Actualizar Horario y Calcular Salario';
            calculateButtonEl.textContent = text;
            calculateButtonEl.disabled = loading;

            if (loading) {
                calculateButtonEl.classList.add('bg-indigo-400');
                calculateButtonEl.classList.remove('bg-indigo-700', 'hover:bg-indigo-800');
            } else {
                calculateButtonEl.classList.remove('bg-indigo-400');
                calculateButtonEl.classList.add('bg-indigo-700', 'hover:bg-indigo-800');
            }
        }
        
        function updateUIFromState() {
            // 1. Actualizar Inputs
            const config = appState.config;
            document.getElementById('input-year').value = config.year;
            document.getElementById('input-valorHora').value = config.valorHora;
            document.getElementById('input-lastFrancoDate').value = config.lastFrancoDate;
            document.getElementById('input-initialTurn').value = config.initialTurn;
            document.getElementById('input-discountRate').value = config.discountRate;
            
            // 2. Llenar opciones de meses
            const monthSelect = document.getElementById('input-month');
            const currentSelectedMonth = monthSelect.value;
            
            // Llenar solo si está vacío para evitar redibujado excesivo
            if (monthSelect.options.length === 0 || monthSelect.options.length === 12) {
                 // Vaciar y rellenar si el año cambió, o si es la primera carga
                monthSelect.innerHTML = ''; 
                Array.from({ length: 12 }, (_, i) => i + 1).forEach(m => {
                    const option = document.createElement('option');
                    option.value = m;
                    // Obtener nombre del mes para el año configurado
                    option.textContent = new Date(config.year, m - 1).toLocaleDateString('es-AR', { month: 'long' });
                    monthSelect.appendChild(option);
                });
                monthSelect.value = config.month;
            } else {
                 monthSelect.value = config.month;
            }

            // 3. Mostrar Resultados (se encarga de renderizar la tabla y el resumen)
            renderCalculationResults();

            // 4. Actualizar Status
            updateStatus(appState.status?.type, appState.status?.message);
            
            setLoading(appState.isLoading);
        }

        // =====================================================================
        // INTEGRACIÓN FIREBASE
        // =====================================================================

        // Importaciones de Firebase (Módulos)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Rutas de Firestore
        function getConfigDocRef() {
            if (!db || !userId) return null;
            // Estructura: artifacts/{appId}/users/{userId}/config/salary
            return doc(db, 'artifacts', appId, 'users', userId, 'config', 'salary');
        }
        
        function getDataDocRef(monthDocId) {
            if (!db || !userId) return null;
            // Estructura: artifacts/{appId}/users/{userId}/data/{YYYY-MM}
            return doc(db, 'artifacts', appId, 'users', userId, 'data', monthDocId);
        }

        // 1. Inicialización y Autenticación
        const initFirebase = async () => {
            // setLogLevel('Debug'); // Descomentar para debug de Firebase
            updateStatus('info', 'Inicializando Firebase...');

            if (Object.keys(firebaseConfig).length === 0 || firebaseConfig.apiKey === "TU_API_KEY_DE_FIREBASE") {
                console.error("Firebase config no está disponible o incompleta.");
                updateStatus('error', "Error de Configuración: Reemplace las credenciales de Firebase.");
                // Establecer autenticación temporal para que la aplicación funcione localmente sin persistencia
                userId = crypto.randomUUID();
                isAuthReady = true;
                document.getElementById('user-info').textContent = `ID Temporal: ${userId.substring(0, 8)}... (Sin Persistencia)`;
                updateUIFromState();
                calculateSchedule(false);
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Intenta autenticar (usando custom token si está disponible, sino anónimo)
                // NOTA: Para implementar Google Sign-In, se debería usar signInWithPopup(auth, provider) aquí.
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth); // Usado para la mayoría de los casos de uso simple/temporal
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-info').textContent = `UID: ${userId.substring(0, 8)}...`;
                        updateStatus('success', 'Conexión a Firebase Establecida. Datos cargados.');
                        // Iniciar listeners de datos
                        setupDataListeners(); 
                    } else {
                        // Fallback si la autenticación falla
                        userId = crypto.randomUUID(); 
                        isAuthReady = true; 
                        document.getElementById('user-info').textContent = `ID Temporal: ${userId.substring(0, 8)}...`;
                        updateStatus('info', 'Sesión anónima iniciada. Los datos NO se conservarán a largo plazo.');
                    }
                    updateUIFromState();
                });

            } catch (error) {
                console.error("Error crítico al inicializar Firebase o al autenticar:", error);
                updateStatus('error', `Error de Autenticación: ${error.message}`);
                updateUIFromState();
            }
        };

        // 2. Funciones de Carga y Guardado
        function saveConfig() {
            if (!isAuthReady || !userId || !db) return;
            
            const configRef = getConfigDocRef();
            if (!configRef) return;

            // Convertir valores numéricos y asegurarse de la limpieza
            const dataToSave = { ...appState.config };
            dataToSave.valorHora = Number(dataToSave.valorHora);
            dataToSave.discountRate = Number(dataToSave.discountRate);

            setDoc(configRef, dataToSave, { merge: true })
                .then(() => console.log("Configuración guardada en Firestore."))
                .catch(error => {
                    console.error("Error saving config:", error);
                    updateStatus('error', "Error al guardar configuración.");
                });
        }
        
        // Guarda tanto las horas extra como los flags de feriado
        function saveData() {
            if (!isAuthReady || !userId || !db) return;
            
            const config = appState.config;
            // ID del documento: YYYY-MM
            const monthDocId = `${config.year}-${String(config.month).padStart(2, '0')}`;
            const dataRef = getDataDocRef(monthDocId);
            if (!dataRef) return;
            
            setDoc(dataRef, { 
                extras: appState.extraHours,
                holidayFlags: appState.manualHolidays
            }, { merge: true })
            .catch(error => {
                console.error("Error saving month data:", error);
                updateStatus('error', "Error al guardar datos de horas/feriados.");
            });
        }
        
        // 3. Listeners de Datos (onSnapshot)
        let unsubscribeConfig = null;
        let unsubscribeData = null;

        function setupDataListeners() {
            if (!isAuthReady || !userId || !db) return;
            
            // 3.1 Listener de Configuración
            if (unsubscribeConfig) unsubscribeConfig();
            const configRef = getConfigDocRef();
            if (configRef) {
                unsubscribeConfig = onSnapshot(configRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        appState.config = { 
                            ...appState.config, ...data,
                            // Asegurar que los valores numéricos se mantengan como Number
                            valorHora: Number(data.valorHora) || appState.config.valorHora,
                            discountRate: Number(data.discountRate) || appState.config.discountRate,
                            month: Number(data.month) || appState.config.month,
                            year: Number(data.year) || appState.config.year,
                        };
                        updateUIFromState();
                    } else {
                        // Si no existe, guarda la config inicial por defecto
                        saveConfig();
                    }
                }, (error) => {
                    console.error("Error fetching config:", error);
                    updateStatus('error', "Error al cargar configuración.");
                });
            }

            // 3.2 Listener de Datos (Horas Extra y Feriados Manuales)
            if (unsubscribeData) unsubscribeData();
            const monthDocId = `${appState.config.year}-${String(appState.config.month).padStart(2, '0')}`;
            const dataRef = getDataDocRef(monthDocId);
            if (dataRef) {
                unsubscribeData = onSnapshot(dataRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        appState.extraHours = data.extras || {};
                        appState.manualHolidays = data.holidayFlags || {};
                    } else {
                        appState.extraHours = {}; 
                        appState.manualHolidays = {};
                    }
                    updateUIFromState();
                    // Recalcular si ya hay resultados para incluir las nuevas extras/feriados
                    if (appState.calculationResult) calculateSchedule(false); 
                }, (error) => {
                    console.error("Error fetching month data:", error);
                    updateStatus('error', "Error al cargar datos de mes.");
                });
            }
        }

        // =====================================================================
        // MANEJADORES DE EVENTOS DE INTERACCIÓN (INPUTS DE LA TABLA)
        // =====================================================================

        function handleConfigChange() {
            const newConfig = {
                month: parseInt(document.getElementById('input-month').value),
                year: parseInt(document.getElementById('input-year').value),
                // Usar parseFloat para valores de hora/descuento
                valorHora: parseFloat(document.getElementById('input-valorHora').value) || appState.config.valorHora,
                lastFrancoDate: document.getElementById('input-lastFrancoDate').value,
                initialTurn: document.getElementById('input-initialTurn').value,
                discountRate: parseFloat(document.getElementById('input-discountRate').value) || appState.config.discountRate,
            };
            
            // Verificar si el cambio de mes/año requiere re-suscribir el listener de datos mensuales
            const oldDocId = `${appState.config.year}-${String(appState.config.month).padStart(2, '0')}`;
            const newDocId = `${newConfig.year}-${String(newConfig.month).padStart(2, '0')}`;

            appState.config = newConfig;
            saveConfig();
            
            if (oldDocId !== newDocId) {
                // Si cambiamos de mes/año, debemos resetear el listener para cargar los datos correctos
                setupDataListeners(); 
            } else {
                 // Si solo cambió la hora/fecha franco/etc, sólo actualizamos la UI y recalculamos
                updateUIFromState();
                calculateSchedule(false);
            }
        }

        // Se registra en el scope global para que los elementos HTML puedan llamarla
        window.handleConfigChange = handleConfigChange;
        
        // Maneja el cambio de horas extra en la tabla
        window.handleExtraChange = function(dateKey, inputElement) {
            const hours = parseFloat(inputElement.value) || 0;
            // Usar DD/MM/YYYY para las keys internas
            appState.extraHours[dateKey] = hours;
            saveData(); 
            // El onSnapshot de datos triggerá el recalculado.
        }

        // Maneja el cambio de checkbox de feriado en la tabla
        window.handleHolidayChange = function(dateKey, checkboxElement) {
            if (checkboxElement.checked) {
                appState.manualHolidays[dateKey] = true;
            } else {
                delete appState.manualHolidays[dateKey];
            }
            saveData();
            // El onSnapshot de datos triggerá el recalculado.
        }

        // =====================================================================
        // LÓGICA DE CÁLCULO
        // =====================================================================
        
        // Inicia el cálculo al hacer clic en el botón
        calculateButtonEl.addEventListener('click', () => calculateSchedule(true));

        function calculateSchedule(initialCalculation = true) {
            if (initialCalculation) setLoading(true);

            const { month, year, lastFrancoDate, initialTurn, valorHora, discountRate } = appState.config;
            
            // Validación básica
            if (!lastFrancoDate || !valorHora || isNaN(valorHora) || valorHora <= 0) {
                 if (initialCalculation) setLoading(false);
                 updateStatus('error', 'Por favor, ingrese un Valor de Hora Bruta y una Fecha de Último Franco válidos.');
                 appState.calculationResult = null;
                 updateUIFromState();
                 return;
            }

            // Establecer el día de inicio (Día 1 del mes a calcular)
            let currentDate = new Date(year, month - 1, 1, 0, 0, 0);
            
            // Obtener el punto de referencia del ciclo
            const lastFrancoDay2 = new Date(lastFrancoDate + 'T00:00:00');
            const dayAfterFranco = new Date(lastFrancoDay2.getTime());
            dayAfterFranco.setDate(dayAfterFranco.getDate() + 1); // Día 1 del ciclo de 6x2

            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];
            let dailyResults = [];
            let francosDates = [];
            
            // El ciclo maestro de 24 días (3 semanas de 8 días: 6 trabajo + 2 franco)
            const masterCycle = [
                'Mañana', 'Mañana', 'Mañana', 'Mañana', 'Mañana', 'Mañana', 'Franco', 'Franco', 
                'Noche', 'Noche', 'Noche', 'Noche', 'Noche', 'Noche', 'Franco', 'Franco', 
                'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Franco', 'Franco'
            ];
            
            // Calcular el offset inicial basado en el Turno Post-Franco configurado
            let baseOffset = 0;
            if (initialTurn === 'Noche') baseOffset = 8;
            else if (initialTurn === 'Tarde') baseOffset = 16;
            
            // Calcular la diferencia en días entre el día de referencia y el inicio del mes a calcular
            const diffTime = currentDate.getTime() - dayAfterFranco.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            // El índice del ciclo donde debe empezar el mes
            let startOffset = (baseOffset + diffDays) % 24; 
            if (startOffset < 0) startOffset += 24; 

            let dayCounter = 0;
            const daysInMonth = new Date(year, month, 0).getDate();

            // Iterar sobre todos los días del mes
            while (dayCounter < daysInMonth) {
                const dayOfWeek = currentDate.getDay(); // 0 (Dom) a 6 (Sáb)
                const dateString = formatDateForDisplay(currentDate); // DD/MM/YYYY (Usado como Key para Extras/Feriados)
                const dateKey = formatDateForInput(currentDate); // YYYY-MM-DD
                
                // --- Determinar si es Feriado (MANUAL) ---
                const isHolidayManual = appState.manualHolidays[dateString] === true; 
                
                const cycleStatus = masterCycle[startOffset]; 
                
                let turnBaseName = cycleStatus;
                let realHours = 0;
                let equivalentHours = 0;
                
                if (isHolidayManual) {
                    turnBaseName = `FERIADO - ${cycleStatus}`;
                    realHours = cycleStatus !== 'Franco' ? 8 : 0; 
                    
                    if (cycleStatus === 'Franco') {
                        // Feriado en Franco: 8 horas equivalentes de compensación
                        equivalentHours = HOLIDAY_FREE_EQUIV_HOURS; 
                        francosDates.push(dateString + ' (Feriado)');
                    } else {
                        // Feriado Trabajado: 32 horas equivalentes
                        equivalentHours = HOLIDAY_WORKED_EQUIV_HOURS;
                    }
                } 
                // Lógica Normal (No es Feriado)
                else {
                    if (cycleStatus === 'Franco') {
                        francosDates.push(dateString);
                    } else {
                        const equivalences = getTurnEquivalencies(dayOfWeek, cycleStatus);
                        realHours = equivalences.realHours;
                        equivalentHours = equivalences.equivalentHours;
                        turnBaseName = equivalences.turnBaseName;
                    }
                }
                
                dailyResults.push({
                    date: dateString,
                    dateKey: dateKey, // YYYY-MM-DD
                    day: dayNames[dayOfWeek],
                    turn: turnBaseName,
                    isHoliday: isHolidayManual,
                    realHours: realHours,
                    equivHoursBase: equivalentHours, 
                });
                
                startOffset = (startOffset + 1) % 24;
                currentDate.setDate(currentDate.getDate() + 1);
                dayCounter++;
            }
            
            // --- Cálculo Final con Horas Extra ---
            let totalEquivalentHours = 0;
            let totalExtraHoursReal = 0;
            const hourlyRate = parseFloat(valorHora) || 0;

            const finalDailyResults = dailyResults.map(day => {
                // Usar dateString (DD/MM/YYYY) para buscar en extraHours
                const dayExtraReal = appState.extraHours[day.date] || 0;
                
                let dayExtraEquivalent = 0;
                
                if (dayExtraReal > 0) {
                    // La hora extra se suma como 1.5 veces el valor.
                    dayExtraEquivalent = (dayExtraReal * EXTRA_HOUR_MULTIPLIER);
                    totalExtraHoursReal += dayExtraReal;
                }
                
                const finalEquivHours = day.equivHoursBase + dayExtraEquivalent;
                const finalDailyBruto = finalEquivHours * hourlyRate;

                totalEquivalentHours += finalEquivHours;

                return {
                    ...day,
                    extraReal: dayExtraReal, 
                    extraEquiv: dayExtraEquivalent, 
                    equivHoursFinal: finalEquivHours, 
                    dailyBruto: finalDailyBruto, 
                };
            });

            const totalBruto = totalEquivalentHours * hourlyRate;
            const totalDescuento = totalBruto * discountRate;
            const totalNeto = totalBruto - totalDescuento;

            appState.calculationResult = {
                dailyResults: finalDailyResults,
                francosDates,
                totalEquivalentHours,
                totalExtraHoursReal,
                totalBruto,
                totalDescuento,
                totalNeto,
                discountRate: discountRate * 100,
            };

            if (initialCalculation) setLoading(false);
            updateUIFromState();
            updateStatus('success', `Cálculo generado para ${dailyResults.length} días. ¡Añade tus extras y feriados!`);
        }
        
        // =====================================================================
        // RENDERIZADO DE RESULTADOS
        // =====================================================================

        function renderCalculationResults() {
            const result = appState.calculationResult;
            if (!result) {
                resultsSectionEl.classList.add('hidden');
                return;
            }

            resultsSectionEl.classList.remove('hidden');

            // 1. Renderizar Cards de Resumen
            summaryCardsEl.innerHTML = `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">H. Eq. Totales</p>
                    <p class="text-lg text-gray-900 font-extrabold">${formatNumber(result.totalEquivalentHours)}</p>
                </div>
                <div class="p-3 bg-red-50 rounded-lg">
                    <p class="text-gray-500">Desc. (${result.discountRate.toFixed(0)}%)</p>
                    <p class="text-lg text-red-600 font-extrabold">${formatCurrency(result.totalDescuento)}</p>
                </div>
                <div class="col-span-1 p-3 bg-indigo-50 rounded-lg">
                    <p class="text-gray-500">Bruto Total</p>
                    <p class="text-xl text-indigo-600 font-extrabold">${formatCurrency(result.totalBruto)}</p>
                </div>
                <div class="col-span-1 p-3 bg-green-100 rounded-lg shadow-md">
                    <p class="text-green-700 font-semibold">NETO (EN MANO)</p>
                    <p class="text-2xl text-green-800 font-extrabold">${formatCurrency(result.totalNeto)}</p>
                </div>
            `;

            // 2. Renderizar Información de Francos
            francosInfoEl.innerHTML = `
                <p class="font-bold text-yellow-800">Días Francos en el Mes (${result.francosDates.length}):</p>
                <p class="mt-1">${result.francosDates.join(' • ')}</p>
            `;

            // 3. Renderizar Tabla de Detalle Diario
            tbodyEl.innerHTML = result.dailyResults.map(day => {
                const isFranco = day.turn.includes('Franco');
                const isFeriado = day.isHoliday;
                
                let rowClasses = 'hover:bg-gray-50';
                if (isFranco) {
                    rowClasses = 'bg-yellow-50 hover:bg-yellow-100 font-semibold';
                } else if (isFeriado) {
                    rowClasses = 'bg-red-50 hover:bg-red-100 font-extrabold text-red-700';
                }

                // Usamos day.date (DD/MM/YYYY) para las keys de Firebase y la UI
                const dateKeyForSave = day.date; 

                return `
                    <tr class="${rowClasses}">
                        <td class="px-3 py-2 whitespace-nowrap text-gray-900">${day.date} - ${day.day.substring(0, 3)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-gray-700">${day.turn}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-center">
                            <input type="checkbox" 
                                class="form-checkbox h-4 w-4 text-red-600 transition duration-150 ease-in-out"
                                ${isFeriado ? 'checked' : ''}
                                onchange="handleHolidayChange('${dateKeyForSave}', this)"
                            >
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-right">${formatNumber(day.equivHoursBase)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-center">
                            <input type="number" 
                                value="${day.extraReal || ''}"
                                class="w-16 text-center border rounded p-1 text-xs"
                                step="0.5" min="0"
                                onchange="handleExtraChange('${dateKeyForSave}', this)"
                            >
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-right font-bold ${isFeriado ? 'text-red-700' : ''}">${formatNumber(day.equivHoursFinal)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-right font-bold">${formatCurrency(day.dailyBruto)}</td>
                    </tr>
                `;
            }).join('');
        }

        // =====================================================================
        // GENERACIÓN DE PDF
        // =====================================================================
        
        generatePdfButtonEl.addEventListener('click', generatePDFReport);

        function generatePDFReport() {
            const result = appState.calculationResult;
            if (!result) return updateStatus('error', 'Debe generar el cálculo antes de descargar el reporte.');

            // @ts-ignore: Desactivar la verificación de tipos para window.jsPDF y autoTable
            const { jsPDF } = window.jspdf; 
            const doc = new jsPDF();
            
            const { month, year } = appState.config;
            const monthName = new Date(year, month - 1).toLocaleDateString('es-AR', { month: 'long', year: 'numeric' });
            
            const title = `Reporte Salarial 6x2 - ${monthName}`;
            
            // Header
            doc.setFontSize(16);
            doc.text(title, 14, 20);
            
            doc.setFontSize(10);
            doc.text(`Valor Hora Bruta: ${formatCurrency(appState.config.valorHora)}`, 14, 26);
            doc.text(`Desc. Afiliación: ${result.discountRate.toFixed(0)}%`, 14, 31);
            doc.text(`Horas Extra Reales: ${result.totalExtraHoursReal}`, 14, 36);

            // Resumen de Ganancias (Tabla de Resumen)
            doc.autoTable({
                startY: 45,
                head: [['Total Horas Eq.', 'Bruto Total', 'Descuento', 'NETO FINAL']],
                body: [[
                    formatNumber(result.totalEquivalentHours),
                    formatCurrency(result.totalBruto),
                    formatCurrency(result.totalDescuento),
                    formatCurrency(result.totalNeto),
                ]],
                theme: 'striped',
                headStyles: { fillColor: [55, 48, 163] }, // Índigo 700
                columnStyles: {
                    0: { fontStyle: 'bold' },
                    3: { fontStyle: 'bold', fillColor: [187, 247, 208] }, // Verde Claro
                },
                styles: { fontSize: 10 }
            });

            // Tabla de Detalle Diario
            const finalY = doc.autoTable.previous.finalY;
            doc.setFontSize(12);
            doc.text('Detalle Diario de Horas y Turnos', 14, finalY + 15);
            
            const tableData = result.dailyResults.map(d => [
                d.date,
                d.day,
                d.turn,
                d.isHoliday ? 'Sí' : 'No',
                formatNumber(d.equivHoursBase, 2),
                d.extraReal > 0 ? formatNumber(d.extraReal, 1) : '',
                formatNumber(d.equivHoursFinal, 2),
                formatCurrency(d.dailyBruto)
            ]);
            
            doc.autoTable({
                startY: finalY + 20,
                head: [['Fecha', 'Día', 'Turno', 'Feriado?', 'H. Eq. Base', 'H. Extra (R)', 'H. Eq. Total', 'Monto Bruto']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [75, 85, 99] }, // Gris Oscuro
                columnStyles: {
                    4: { halign: 'right' },
                    5: { halign: 'center' },
                    6: { halign: 'right', fontStyle: 'bold' },
                    7: { halign: 'right', fontStyle: 'bold' },
                },
                didParseCell: (data) => {
                    // Resaltar días francos en la tabla
                    const turn = data.row.raw[2];
                    if (turn.includes('Franco')) {
                        data.cell.styles.fillColor = [255, 251, 235]; // Amarillo Claro
                    }
                    // Resaltar feriados
                    const isHoliday = data.row.raw[3] === 'Sí';
                     if (isHoliday) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.textColor = [185, 28, 28]; // Rojo
                    }
                },
                styles: { fontSize: 8 }
            });

            // Guardar PDF
            doc.save(`Reporte_6x2_${monthName.replace(/\s/g, '_')}.pdf`);
        }

        // =====================================================================
        // INICIO DE LA APLICACIÓN
        // =====================================================================
        
        // Ejecutar al cargar la página
        window.onload = () => {
             // 1. Inicializar la UI con los valores por defecto/configurados
            updateUIFromState();
            
            // 2. Intentar inicializar Firebase y cargar datos
            initFirebase();
        };

    </script>
</body>
</html>
