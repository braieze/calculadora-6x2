<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Salarial 6x2</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuraciones de fuente */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .input-style {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            width: 100%;
            transition: border-color 0.15s;
        }
        .input-style:focus {
            border-color: #4f46e5;
            outline: none;
            ring: 2px;
            ring-color: #6366f1;
        }
        /* Estilo para la tabla pegajosa */
        .sticky-header th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>

    <!-- CARGA DE LIBRER√çAS JSDPF Y AUTOTABLE -->
    <!-- Estas librer√≠as se usan solo para la descarga del reporte en PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

</head>
<body class="min-h-screen flex items-start justify-center p-4">

    <!-- Contenedor Principal de la Aplicaci√≥n -->
    <div id="app-container" class="w-full max-w-5xl bg-white rounded-xl card p-6 md:p-8 mt-4">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-2 mb-4">
            <h1 class="text-2xl font-bold text-indigo-700">
                Calculadora Salarial 6x2
            </h1>
            <div id="user-info" class="text-sm text-gray-600 mt-2 md:mt-0"></div>
        </div>
        
        <div id="status-message" class="hidden p-3 rounded-lg mt-4 font-semibold text-sm"></div>

        <!-- Panel de Configuraci√≥n -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
            <div>
                <label class="block text-sm font-medium text-gray-700">Mes</label>
                <select id="input-month" name="month" class="input-style" onchange="handleConfigChange()">
                    <!-- Opciones se llenar√°n con JS -->
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700">A√±o</label>
                <input id="input-year" type="number" name="year" class="input-style" onchange="handleConfigChange()">
            </div>
            <div class="col-span-2 md:col-span-1">
                <label class="block text-sm font-medium text-gray-700">Valor Hora Bruta ($)</label>
                <input id="input-valorHora" type="number" name="valorHora" class="input-style" onchange="handleConfigChange()" step="0.01">
            </div>
            <div class="col-span-2 md:col-span-1">
                <label class="block text-sm font-medium text-gray-700">Desc. Afiliaci√≥n</label>
                <select id="input-discountRate" name="discountRate" class="input-style" onchange="handleConfigChange()">
                    <option value="0.18">No Afiliado (18%)</option>
                    <option value="0.16">Afiliado (16%)</option>
                </select>
            </div>
            <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700">Fecha del √öltimo Franco (D√≠a 2)</label>
                <input id="input-lastFrancoDate" type="date" name="lastFrancoDate" class="input-style" onchange="handleConfigChange()">
            </div>
            <div class="col-span-2">
                <label class="block text-sm font-medium text-gray-700">Turno Post-Franco</label>
                <select id="input-initialTurn" name="initialTurn" class="input-style" onchange="handleConfigChange()">
                    <option value="Ma√±ana">Ma√±ana</option>
                    <option value="Noche">Noche</option>
                    <option value="Tarde">Tarde</option>
                </select>
            </div>
        </div>

        <button id="calculate-schedule-button" class="w-full py-3 mt-2 rounded-lg text-white font-bold transition duration-150 bg-indigo-700 hover:bg-indigo-800">
            Generar/Actualizar Horario y Calcular Salario
        </button>

        <!-- Secci√≥n de Resultados (Oculta hasta el c√°lculo) -->
        <div id="results-section" class="hidden mt-6 border-t pt-6">
            <h2 class="text-xl font-bold text-indigo-700 mb-4">Resumen de Ganancias</h2>
            <div id="summary-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm font-medium mb-6">
                <!-- Cards de resumen aqu√≠ -->
            </div>

            <div id="francos-info" class="p-3 bg-yellow-50 rounded-lg text-sm mb-4">
                <!-- Informaci√≥n de francos aqu√≠ -->
            </div>

            <button id="generate-pdf-button" class="w-full py-2 mb-6 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold transition duration-150 flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                Descargar Reporte PDF
            </button>
            
            <!-- Tabla de Detalle Diario -->
            <h3 class="text-lg font-bold text-gray-800 mb-3 border-t pt-4">Detalle Diario, Feriados y Horas Extra</h3>
            <p class="text-xs text-red-600 mb-3">
                ‚ö†Ô∏è Marca la casilla "Es Feriado" para aplicar la equivalencia de 32 Horas (si trabajas) o 8 Horas (si es Franco).
            </p>
            <div id="daily-detail-table-container" class="overflow-x-auto rounded-lg border" style="max-height: 400px; overflow-y: auto;">
                <table id="daily-detail-table" class="min-w-full divide-y divide-gray-200 text-xs">
                    <thead class="bg-gray-100 sticky-header">
                        <tr>
                            <th class="px-3 py-2 text-left text-gray-500">Fecha</th>
                            <th class="px-3 py-2 text-left text-gray-500">Turno</th>
                            <th class="px-3 py-2 text-center text-gray-500">Es Feriado</th>
                            <th class="px-3 py-2 text-right text-gray-500">H. Eq. Base</th>
                            <th class="px-3 py-2 text-center text-gray-500">H. Extra (Reales)</th>
                            <th class="px-3 py-2 text-right text-gray-500">H. Eq. Total</th>
                            <th class="px-3 py-2 text-right text-gray-500">Monto Bruto</th>
                        </tr>
                    </thead>
                    <tbody id="daily-detail-tbody" class="bg-white divide-y divide-gray-200">
                        <!-- Filas de detalle diario aqu√≠ -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Script de Firebase y L√≥gica de la Aplicaci√≥n -->
    <script type="module">
        // =====================================================================
        // CONFIGURACI√ìN, CONSTANTES Y ESTADO GLOBAL
        // =====================================================================

        // Constantes de negocio
        const EXTRA_HOUR_MULTIPLIER = 1.5;
        const HOLIDAY_WORKED_EQUIV_HOURS = 32;
        const HOLIDAY_FREE_EQUIV_HOURS = 8;
        
        // Variables de entorno de Canvas
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        // Instancias de Firebase y Estado de Autenticaci√≥n
        let app;
        let auth;
        let db;
        let userId = null;
        let isAuthReady = false;

        // Estado Global de la Aplicaci√≥n (Simulando React state)
        let appState = {
            config: {
                month: new Date().getMonth() + 1,
                year: new Date().getFullYear(),
                valorHora: 3758,
                lastFrancoDate: getYesterdayDate(),
                initialTurn: 'Ma√±ana',
                discountRate: 0.18,
            },
            extraHours: {},     // { "DD/MM/YYYY": 2, ... }
            manualHolidays: {}, // { "DD/MM/YYYY": true, ... }
            calculationResult: null,
            isLoading: false,
            status: null,
        };

        // Elementos del DOM
        const statusEl = document.getElementById('status-message');
        const summaryCardsEl = document.getElementById('summary-cards');
        const francosInfoEl = document.getElementById('francos-info');
        const tbodyEl = document.getElementById('daily-detail-tbody');
        const resultsSectionEl = document.getElementById('results-section');
        const calculateButtonEl = document.getElementById('calculate-schedule-button');
        const generatePdfButtonEl = document.getElementById('generate-pdf-button');

        // =====================================================================
        // UTILIDADES Y AYUDANTES DE UI
        // =====================================================================

        function getYesterdayDate() {
            const date = new Date();
            date.setDate(date.getDate() - 1);
            return formatDateForInput(date);
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDateForDisplay(date) {
            // Formato DD/MM/YYYY
            return date.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }

        function formatCurrency(amount) {
            return amount.toLocaleString('es-AR', { style: 'currency', currency: 'ARS' });
        }

        // L√≥gica de equivalencias de horas seg√∫n el d√≠a y turno (6x2)
        function getTurnEquivalencies(dayOfWeek, turnType) {
            let realHours = 8;
            let equivalentHours = 8; 
            let turnBaseName = turnType;
            
            if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Lunes a Viernes
                switch (turnType) {
                    case 'Ma√±ana':
                    case 'Tarde': equivalentHours = 8; break;
                    case 'Noche': equivalentHours = 12; break;
                }
            } else if (dayOfWeek === 6) { // S√°bado
                switch (turnType) {
                    case 'Ma√±ana': realHours = 8; equivalentHours = 9; break;
                    case 'Tarde': realHours = 9; equivalentHours = 12; break;
                    case 'Noche': realHours = 8; equivalentHours = 16; break;
                }
            } else if (dayOfWeek === 0) { // Domingo
                turnBaseName = 'Domingo ' + turnType;
                switch (turnType) {
                    case 'Ma√±ana':
                    case 'Tarde': realHours = 8; equivalentHours = 24; break;
                    case 'Noche': realHours = 8; equivalentHours = 28; break;
                }
            }
            return { realHours, equivalentHours, turnBaseName };
        }

        function updateStatus(type, message) {
            appState.status = { type, message };
            if (!message) {
                statusEl.classList.add('hidden');
                return;
            }
            
            statusEl.classList.remove('hidden');
            let colorClass = "";
            switch (type) {
                case 'success': colorClass = "bg-green-100 text-green-700"; break;
                case 'error': colorClass = "bg-red-100 text-red-700"; break;
                case 'info': colorClass = "bg-blue-100 text-blue-700"; break;
                default: colorClass = "bg-gray-100 text-gray-700"; break;
            }
            statusEl.className = `p-3 rounded-lg mt-4 font-semibold text-sm ${colorClass}`;
            statusEl.textContent = message;
        }

        function setLoading(loading) {
            appState.isLoading = loading;
            const text = loading ? 'Calculando...' : 'Generar/Actualizar Horario y Calcular Salario';
            calculateButtonEl.textContent = text;
            calculateButtonEl.disabled = loading;

            if (loading) {
                calculateButtonEl.classList.add('bg-indigo-400');
                calculateButtonEl.classList.remove('bg-indigo-700', 'hover:bg-indigo-800');
            } else {
                calculateButtonEl.classList.remove('bg-indigo-400');
                calculateButtonEl.classList.add('bg-indigo-700', 'hover:bg-indigo-800');
            }
        }
        
        function updateUIFromState() {
            // 1. Actualizar Inputs
            const config = appState.config;
            document.getElementById('input-year').value = config.year;
            document.getElementById('input-valorHora').value = config.valorHora;
            document.getElementById('input-lastFrancoDate').value = config.lastFrancoDate;
            document.getElementById('input-initialTurn').value = config.initialTurn;
            document.getElementById('input-discountRate').value = config.discountRate;
            document.getElementById('input-month').value = config.month;

            // 2. Llenar opciones de meses
            const monthSelect = document.getElementById('input-month');
            if (monthSelect.options.length === 0) {
                Array.from({ length: 12 }, (_, i) => i + 1).forEach(m => {
                    const option = document.createElement('option');
                    option.value = m;
                    option.textContent = new Date(config.year, m - 1).toLocaleDateString('es-AR', { month: 'long' });
                    monthSelect.appendChild(option);
                });
                monthSelect.value = config.month;
            }
            
            // 3. Mostrar Resultados (se encarga de renderizar la tabla y el resumen)
            renderCalculationResults();

            // 4. Actualizar Status
            updateStatus(appState.status?.type, appState.status?.message);
            
            setLoading(appState.isLoading);
        }

        // =====================================================================
        // INTEGRACI√ìN FIREBASE
        // =====================================================================

        // Importaciones de Firebase (M√≥dulos)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Rutas de Firestore
        function getConfigDocRef() {
            if (!db || !userId) return null;
            return doc(db, 'artifacts', appId, 'users', userId, 'config', 'salary');
        }
        
        function getDataDocRef(monthDocId) {
            if (!db || !userId) return null;
            // Documento que guarda tanto horas extra como flags de feriado para un mes espec√≠fico
            return doc(db, 'artifacts', appId, 'users', userId, 'data', monthDocId);
        }

        // 1. Inicializaci√≥n y Autenticaci√≥n
        const initFirebase = async () => {
            setLogLevel('Debug');
            updateStatus('info', 'Inicializando Firebase...');

            if (Object.keys(firebaseConfig).length === 0) {
                console.error("Firebase config no est√° disponible.");
                updateStatus('error', "Error de Configuraci√≥n de Firebase.");
                return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                // Intenta autenticar
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-info').textContent = `UID: ${userId.substring(0, 8)}...`;
                        updateStatus('success', 'Conexi√≥n a Firebase Establecida.');
                        // Iniciar listeners de datos
                        setupDataListeners(); 
                    } else {
                        // Fallback si la autenticaci√≥n falla, aunque se intent√≥ an√≥nimamente
                        userId = crypto.randomUUID(); 
                        isAuthReady = true; 
                        document.getElementById('user-info').textContent = `ID Temporal: ${userId.substring(0, 8)}...`;
                        updateStatus('info', 'Sesi√≥n an√≥nima iniciada. Datos temporales. Guarda tu ID si quieres conservar los datos.');
                    }
                    updateUIFromState();
                });

            } catch (error) {
                console.error("Error cr√≠tico al inicializar Firebase o al autenticar:", error);
                updateStatus('error', `Error de Autenticaci√≥n: ${error.message}`);
                updateUIFromState();
            }
        };

        // 2. Funciones de Carga y Guardado
        function saveConfig() {
            if (!isAuthReady || !userId || !db) return;
            
            const configRef = getConfigDocRef();
            if (!configRef) return;

            // Convertir valores num√©ricos y asegurarse de la limpieza
            const dataToSave = { ...appState.config };
            dataToSave.valorHora = Number(dataToSave.valorHora);
            dataToSave.discountRate = Number(dataToSave.discountRate);

            setDoc(configRef, dataToSave, { merge: true })
                .then(() => console.log("Configuraci√≥n guardada en Firestore."))
                .catch(error => {
                    console.error("Error saving config:", error);
                    updateStatus('error', "Error al guardar configuraci√≥n.");
                });
        }
        
        // Guarda tanto las horas extra como los flags de feriado
        function saveData() {
            if (!isAuthReady || !userId || !db) return;
            
            const config = appState.config;
            // Usamos DD/MM/YYYY para las keys internas del objeto
            const monthDocId = `${config.year}-${String(config.month).padStart(2, '0')}`;
            const dataRef = getDataDocRef(monthDocId);
            if (!dataRef) return;
            
            setDoc(dataRef, { 
                extras: appState.extraHours,
                holidayFlags: appState.manualHolidays
            }, { merge: true })
            .catch(error => {
                console.error("Error saving month data:", error);
                updateStatus('error', "Error al guardar datos de horas/feriados.");
            });
        }
        
        // 3. Listeners de Datos (onSnapshot)
        let unsubscribeConfig = null;
        let unsubscribeData = null;

        function setupDataListeners() {
            if (!isAuthReady || !userId || !db) return;

            // Listener de Configuraci√≥n
            if (unsubscribeConfig) unsubscribeConfig();
            const configRef = getConfigDocRef();
            if (configRef) {
                unsubscribeConfig = onSnapshot(configRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        appState.config = { 
                            ...appState.config, ...data,
                            valorHora: Number(data.valorHora) || appState.config.valorHora,
                            discountRate: Number(data.discountRate) || appState.config.discountRate,
                        };
                        updateUIFromState();
                    } else {
                        // Si no existe, guarda la config inicial por defecto
                        saveConfig();
                    }
                }, (error) => {
                    console.error("Error fetching config:", error);
                    updateStatus('error', "Error al cargar configuraci√≥n.");
                });
            }

            // Listener de Datos (Horas Extra y Feriados Manuales)
            if (unsubscribeData) unsubscribeData();
            const monthDocId = `${appState.config.year}-${String(appState.config.month).padStart(2, '0')}`;
            const dataRef = getDataDocRef(monthDocId);
            if (dataRef) {
                unsubscribeData = onSnapshot(dataRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        appState.extraHours = data.extras || {};
                        appState.manualHolidays = data.holidayFlags || {};
                    } else {
                        appState.extraHours = {}; 
                        appState.manualHolidays = {};
                    }
                    updateUIFromState();
                    // Recalcular si ya hay resultados para incluir las nuevas extras/feriados
                    if (appState.calculationResult) calculateSchedule(false); 
                }, (error) => {
                    console.error("Error fetching month data:", error);
                });
            }
        }

        // =====================================================================
        // MANEJADORES DE EVENTOS DE INTERACCI√ìN (INPUTS DE LA TABLA)
        // =====================================================================

        function handleConfigChange() {
            const newConfig = {
                month: parseInt(document.getElementById('input-month').value),
                year: parseInt(document.getElementById('input-year').value),
                valorHora: parseFloat(document.getElementById('input-valorHora').value) || appState.config.valorHora,
                lastFrancoDate: document.getElementById('input-lastFrancoDate').value,
                initialTurn: document.getElementById('input-initialTurn').value,
                discountRate: parseFloat(document.getElementById('input-discountRate').value) || appState.config.discountRate,
            };
            appState.config = newConfig;
            saveConfig();
            // Esto es crucial: re-setear el listener de datos para el nuevo mes/a√±o
            setupDataListeners(); 
            updateUIFromState();
            calculateSchedule(false); 
        }

        // Maneja el cambio de horas extra en la tabla
        window.handleExtraChange = function(dateKey, inputElement) {
            const hours = parseFloat(inputElement.value) || 0;
            appState.extraHours[dateKey] = hours;
            saveData(); 
            // El onSnapshot de datos trigger√° el recalculado.
        }

        // Maneja el cambio de checkbox de feriado en la tabla
        window.handleHolidayChange = function(dateKey, checkboxElement) {
            if (checkboxElement.checked) {
                appState.manualHolidays[dateKey] = true;
            } else {
                delete appState.manualHolidays[dateKey];
            }
            saveData();
            // El onSnapshot de datos trigger√° el recalculado.
        }

        // =====================================================================
        // L√ìGICA DE C√ÅLCULO
        // =====================================================================

        function calculateSchedule(initialCalculation = true) {
            if (initialCalculation) setLoading(true);

            const { month, year, lastFrancoDate, initialTurn, valorHora, discountRate } = appState.config;
            
            let currentDate = new Date(year, month - 1, 1, 0, 0, 0);
            const lastFrancoDay2 = new Date(lastFrancoDate + 'T00:00:00');
            const dayAfterFranco = new Date(lastFrancoDay2.getTime());
            dayAfterFranco.setDate(dayAfterFranco.getDate() + 1);
            
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            let dailyResults = [];
            let francosDates = [];
            
            const masterCycle = [
                'Ma√±ana', 'Ma√±ana', 'Ma√±ana', 'Ma√±ana', 'Ma√±ana', 'Ma√±ana', 'Franco', 'Franco', 
                'Noche', 'Noche', 'Noche', 'Noche', 'Noche', 'Noche', 'Franco', 'Franco', 
                'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Franco', 'Franco'
            ];
            
            let baseOffset = 0;
            if (initialTurn === 'Noche') baseOffset = 8;
            else if (initialTurn === 'Tarde') baseOffset = 16;
            
            const diffTime = currentDate.getTime() - dayAfterFranco.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            let startOffset = (baseOffset + diffDays) % 24; 
            if (startOffset < 0) startOffset += 24; 

            let dayCounter = 0;
            while (currentDate.getMonth() === month - 1 && dayCounter < 31) {
                const dayOfWeek = currentDate.getDay(); 
                const dateString = formatDateForDisplay(currentDate); // DD/MM/YYYY
                const dateKey = formatDateForInput(currentDate); // YYYY-MM-DD
                
                // --- Determinar si es Feriado (MANUAL) ---
                const isHolidayManual = appState.manualHolidays[dateString] === true; 
                
                const cycleStatus = masterCycle[startOffset]; 
                
                let turnBaseName = cycleStatus;
                let realHours = 0;
                let equivalentHours = 0;
                
                if (isHolidayManual) {
                    turnBaseName = `FERIADO - ${cycleStatus}`;
                    realHours = cycleStatus !== 'Franco' ? 8 : 0; 
                    
                    if (cycleStatus === 'Franco') {
                        // Feriado en Franco: 8 horas equivalentes
                        equivalentHours = HOLIDAY_FREE_EQUIV_HOURS; 
                        francosDates.push(dateString + ' (Feriado)');
                    } else {
                        // Feriado Trabajado: 32 horas equivalentes
                        equivalentHours = HOLIDAY_WORKED_EQUIV_HOURS;
                    }
                } 
                // L√≥gica Normal
                else {
                    if (cycleStatus === 'Franco') {
                        francosDates.push(dateString);
                    } else {
                        const equivalences = getTurnEquivalencies(dayOfWeek, cycleStatus);
                        realHours = equivalences.realHours;
                        equivalentHours = equivalences.equivalentHours;
                        turnBaseName = equivalences.turnBaseName;
                    }
                }
                
                dailyResults.push({
                    date: dateString,
                    dateKey: dateKey, // YYYY-MM-DD
                    day: dayNames[dayOfWeek],
                    turn: turnBaseName,
                    isHoliday: isHolidayManual,
                    realHours: realHours,
                    equivHoursBase: equivalentHours, 
                });
                
                startOffset = (startOffset + 1) % 24;
                currentDate.setDate(currentDate.getDate() + 1);
                dayCounter++;
            }
            
            // --- C√°lculo Final con Horas Extra ---
            let totalEquivalentHours = 0;
            const hourlyRate = parseFloat(valorHora) || 0;

            const finalDailyResults = dailyResults.map(day => {
                // Usar dateString (DD/MM/YYYY) para buscar en extraHours
                const dayExtraReal = appState.extraHours[day.date] || 0;
                
                let dayExtraEquivalent = 0;
                
                if (dayExtraReal > 0) {
                    // La hora extra se suma como 1.5 veces el valor.
                    dayExtraEquivalent = (dayExtraReal * EXTRA_HOUR_MULTIPLIER);
                }
                
                const finalEquivHours = day.equivHoursBase + dayExtraEquivalent;
                const finalDailyBruto = finalEquivHours * hourlyRate;

                totalEquivalentHours += finalEquivHours;

                return {
                    ...day,
                    extraReal: dayExtraReal, 
                    extraEquiv: dayExtraEquivalent, 
                    equivHoursFinal: finalEquivHours, 
                    dailyBruto: finalDailyBruto, 
                };
            });

            const totalBruto = totalEquivalentHours * hourlyRate;
            const totalDescuento = totalBruto * discountRate;
            const totalNeto = totalBruto - totalDescuento;

            appState.calculationResult = {
                dailyResults: finalDailyResults,
                francosDates,
                totalEquivalentHours,
                totalBruto,
                totalDescuento,
                totalNeto,
                discountRate: discountRate * 100,
            };

            if (initialCalculation) setLoading(false);
            updateUIFromState();
            updateStatus('success', `C√°lculo generado para ${dailyResults.length} d√≠as. ¬°A√±ade tus extras y feriados!`);
        }
        
        // =====================================================================
        // RENDERIZADO DE RESULTADOS
        // =====================================================================

        function renderCalculationResults() {
            const result = appState.calculationResult;
            if (!result) {
                resultsSectionEl.classList.add('hidden');
                return;
            }

            resultsSectionEl.classList.remove('hidden');

            // 1. Renderizar Cards de Resumen
            summaryCardsEl.innerHTML = `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">H. Eq. Totales</p>
                    <p class="text-lg text-gray-900 font-extrabold">${result.totalEquivalentHours.toFixed(2)}</p>
                </div>
                <div class="p-3 bg-red-50 rounded-lg">
                    <p class="text-gray-500">Desc. (${result.discountRate.toFixed(0)}%)</p>
                    <p class="text-lg text-red-600 font-extrabold">${formatCurrency(result.totalDescuento)}</p>
                </div>
                <div class="col-span-1 p-3 bg-indigo-50 rounded-lg">
                    <p class="text-gray-500">Bruto Total</p>
                    <p class="text-xl text-indigo-600 font-extrabold">${formatCurrency(result.totalBruto)}</p>
                </div>
                <div class="col-span-1 p-3 bg-green-100 rounded-lg shadow-md">
                    <p class="text-green-700 font-semibold">NETO (EN MANO)</p>
                    <p class="text-2xl text-green-800 font-extrabold">${formatCurrency(result.totalNeto)}</p>
                </div>
            `;

            // 2. Renderizar Francos
            francosInfoEl.innerHTML = `
                <strong class="text-yellow-800">üóìÔ∏è Francos del Mes:</strong>
                <p class="mt-1 text-yellow-700">${result.francosDates.join(', ') || 'No hay francos programados.'}</p>
            `;

            // 3. Renderizar Tabla de Detalle Diario
            tbodyEl.innerHTML = ''; // Limpiar tabla
            result.dailyResults.forEach(day => {
                let rowClass = day.turn.includes('Franco') && !day.isHoliday ? 'bg-yellow-50' : 'hover:bg-gray-50';
                if (day.isHoliday && day.turn.includes('Franco')) {
                    rowClass = 'bg-amber-100 border-l-4 border-amber-500'; // Feriado Libre (8h)
                } else if (day.isHoliday) {
                    rowClass = 'bg-red-100 border-l-4 border-red-500'; // Feriado Trabajado (32h)
                }
                
                const isWorkDay = !day.turn.includes('Franco') || day.isHoliday;
                
                // Input de Horas Extra
                const extraHoursInput = isWorkDay ? `
                    <input 
                        type="number" 
                        class="w-16 p-1 rounded-md border border-gray-300 text-center text-xs focus:ring-indigo-500 focus:border-indigo-500"
                        min="0"
                        step="0.5"
                        placeholder="0"
                        value="${appState.extraHours[day.date] || ''}"
                        onblur="handleExtraChange('${day.date}', this)" 
                    />
                ` : '---';

                // Checkbox de Feriado Manual
                const holidayCheckbox = `
                    <input 
                        type="checkbox"
                        class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500"
                        ${appState.manualHolidays[day.date] ? 'checked' : ''}
                        onchange="handleHolidayChange('${day.date}', this)"
                    />
                `;

                const row = document.createElement('tr');
                row.className = rowClass;
                row.innerHTML = `
                    <td class="px-3 py-2 whitespace-nowrap">${day.date} (${day.day.substring(0, 3)})</td>
                    <td class="px-3 py-2 whitespace-nowrap font-medium text-indigo-600">${day.turn}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-center">${holidayCheckbox}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right font-bold">${day.equivHoursBase.toFixed(2)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-center">${extraHoursInput}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right font-bold">${day.equivHoursFinal.toFixed(2)}</td>
                    <td class="px-3 py-2 whitespace-nowrap text-right font-bold text-green-700">${formatCurrency(day.dailyBruto)}</td>
                `;
                tbodyEl.appendChild(row);
            });
        }

        // =====================================================================
        // GENERACI√ìN DE PDF
        // =====================================================================
        
        function generatePdf() {
            const result = appState.calculationResult;
            if (!result) {
                updateStatus('error', "Por favor, primero genera el c√°lculo del horario.");
                return;
            }

            // FIX: Verificar la disponibilidad de jspdf de forma segura
            if (typeof window.jspdf === 'undefined' || typeof window.jspdf.jsPDF === 'undefined' || typeof doc.autoTable !== 'function') {
                 updateStatus('error', "Error: Las librer√≠as de PDF no est√°n cargadas. Por favor, espera y vuelve a intentarlo.");
                 return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            
            const { totalBruto, totalDescuento, totalNeto, discountRate, dailyResults } = result;
            const config = appState.config;
            const monthName = new Date(config.year, config.month - 1).toLocaleDateString('es-AR', { month: 'long', year: 'numeric' });

            // T√≠tulo y Resumen
            doc.setFontSize(18); doc.text(`REPORTE SALARIAL MENSUAL`, 105, 15, null, null, 'center');
            doc.setFontSize(12); doc.text(`C√°lculo para ${monthName}`, 105, 22, null, null, 'center');
            doc.setFillColor(240, 240, 240); doc.rect(15, 30, 180, 40, 'F'); 
            doc.setFontSize(10); doc.text('RESUMEN', 17, 35);
            doc.setFontSize(12); doc.text('BRUTO TOTAL:', 20, 42); doc.text(formatCurrency(totalBruto), 190, 42, null, null, 'right');
            doc.text(`DESCUENTO (${discountRate.toFixed(0)}%):`, 20, 50);
            doc.setTextColor(217, 48, 37); doc.text(`- ${formatCurrency(totalDescuento)}`, 190, 50, null, null, 'right');
            doc.setTextColor(0, 0, 0); 
            doc.setFontSize(14); doc.setFont('helvetica', 'bold');
            doc.setFillColor(217, 234, 211); doc.rect(15, 58, 180, 10, 'F');
            doc.text('NETO (EN MANO):', 20, 65); doc.text(formatCurrency(totalNeto), 190, 65, null, null, 'right');
            doc.setFont('helvetica', 'normal'); doc.setFontSize(10); 
            if(userId) doc.text(`UID: ${userId}`, 15, 75); 

            // Detalle Diario (Tabla)
            doc.setFontSize(12); doc.text('Detalle Diario (Horas y Equivalencias)', 15, 85);
            
            const tableColumns = ["Fecha", "D√≠a", "Turno Base", "Feriado", "H. Base", "H. Extra", "H. Eq. Total", "Monto Bruto"];
            const tableRows = dailyResults.map(r => [
                r.date, r.day, r.turn, r.isHoliday ? '‚úÖ' : '‚ùå', r.equivHoursBase.toFixed(2), 
                r.extraReal.toFixed(2), r.equivHoursFinal.toFixed(2), formatCurrency(r.dailyBruto),
            ]);

            doc.autoTable({
                startY: 90, head: [tableColumns], body: tableRows, theme: 'grid',
                styles: { fontSize: 8, cellPadding: 2, overflow: 'linebreak' },
                headStyles: { fillColor: [207, 226, 243] }, 
                columnStyles: {
                    0: { cellWidth: 16 }, 3: { cellWidth: 10, halign: 'center' }, 
                    4: { cellWidth: 12, halign: 'center' }, 5: { cellWidth: 12, halign: 'center' }, 
                    6: { cellWidth: 12, halign: 'center' }, 7: { halign: 'right' }, 
                },
                bodyStyles: (data) => {
                    const rowData = dailyResults[data.row.index];
                    if (rowData.isHoliday && rowData.turn.includes('Franco')) return { fillColor: [255, 237, 196] }; 
                    if (rowData.isHoliday) return { fillColor: [254, 202, 202] }; 
                    if (rowData.turn.includes('Franco') && !rowData.isHoliday) return { fillColor: [255, 242, 204] }; 
                    return {};
                }
            });

            doc.setFontSize(8); doc.text("Generado por la Calculadora de Rotaci√≥n 6x2.", 105, doc.internal.pageSize.height - 10, null, null, 'center');
            doc.save(`Reporte_Salarial_${monthName}.pdf`);
            updateStatus('success', "PDF generado con √©xito y descargado.");
        }


        // =====================================================================
        // ASIGNACI√ìN DE EVENT LISTENERS Y ARRANQUE
        // =====================================================================

        window.onload = () => {
            // Asignar listeners a botones de acci√≥n
            calculateButtonEl.addEventListener('click', () => calculateSchedule(true));
            generatePdfButtonEl.addEventListener('click', generatePdf);
            
            // Inicializaci√≥n de la aplicaci√≥n
            initFirebase();
            updateUIFromState(); // Renderizar estado inicial de inputs
        };

    </script>
</body>
</html>
