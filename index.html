<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Salarial 6x2 - App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuraciones de fuente */
        @import url('https://fonts.fonts.google.com/specimen/Inter');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .card {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .input-style {
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            width: 100%;
            transition: border-color 0.15s;
        }
        .input-style:focus {
            border-color: #4f46e5;
            outline: none;
            ring: 2px;
            ring-color: #6366f1;
        }
        /* Estilo para la tabla pegajosa */
        .sticky-header th {
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f9fafb;
        }
        /* Estilos para las pesta帽as de navegaci贸n */
        .nav-tab {
            padding: 10px 15px;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: border-color 0.15s, color 0.15s;
        }
        .nav-tab.active {
            color: #4f46e5;
            border-bottom-color: #4f46e5;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

</head>
<body class="min-h-screen flex items-start justify-center p-4">

    <div id="app-container" class="w-full max-w-5xl bg-white rounded-xl card p-6 md:p-8 mt-4">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center border-b pb-2 mb-4">
            <h1 class="text-2xl font-bold text-indigo-700">
                Calculadora Salarial 6x2
            </h1>
            <div id="auth-controls" class="flex space-x-2 mt-2 md:mt-0 items-center">
                <div id="user-info" class="text-sm text-gray-600">Cargando...</div>
                <button id="google-login-btn" class="flex items-center px-3 py-1 bg-blue-600 text-white text-sm font-semibold rounded-lg shadow hover:bg-blue-700 transition duration-150">
                    <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg"><path d="M44.5 20H24v8.5h11.8c-.7 4.3-3.6 7.9-7.9 10.1v7H44c.4-3.4 2.8-6.4 5.9-8.5v-2c-3-2.1-5.4-5.1-5.9-8.5z" fill="#4285F4"/><path d="M24 44.5h20.5v-7h-7c-2.3 2.1-5 3.7-7.7 4.7v2.3c3 0 5.8-.8 8.1-2.2v-2z" fill="#34A853"/><path d="M24 3.5V11H4v7h20v8.5h-11.8c.7 4.3 3.6 7.9 7.9 10.1v7c-8.9-3.2-14.9-12-14.9-22.6C9.1 12 14.1 6.5 24 3.5z" fill="#FBBC05"/><path d="M24 3.5V11h20v-7H24z" fill="#EA4335"/></svg>
                    Google
                </button>
                <button id="logout-btn" class="hidden px-3 py-1 bg-gray-500 text-white text-sm font-semibold rounded-lg shadow hover:bg-gray-600 transition duration-150">
                    Salir
                </button>
            </div>
        </div>
       
        <div id="status-message" class="hidden p-3 rounded-lg mt-4 font-semibold text-sm"></div>

        <nav class="flex border-b border-gray-200 mb-6 overflow-x-auto">
            <div id="tab-home" class="nav-tab active" data-view="home-view"> Inicio</div>
            <div id="tab-config" class="nav-tab" data-view="config-view">锔 Configuraci贸n</div>
            <div id="tab-dashboard" class="nav-tab" data-view="monthly-history-view"> Dashboard Mensual</div>
            <div id="tab-comparisons" class="nav-tab" data-view="comparisons-view"> Comparaciones</div>
        </nav>

        <div id="view-container">

            <div id="home-view" data-view="home-view">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Resumen y Pr贸ximo Ciclo</h2>
                <div id="home-content" class="space-y-6">
                    <div id="next-events-cards" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-5 bg-indigo-50 rounded-lg shadow">
                            <h3 class="font-semibold text-indigo-700 mb-2">Pr贸ximos Francos</h3>
                            <p id="next-francos-display" class="text-2xl font-extrabold text-indigo-900">Calculando...</p>
                        </div>
                        <div class="p-5 bg-yellow-50 rounded-lg shadow">
                            <h3 class="font-semibold text-yellow-700 mb-2">Estimaci贸n Pr贸xima Quincena</h3>
                            <p id="next-quincena-display" class="text-2xl font-extrabold text-yellow-900">Calculando...</p>
                        </div>
                    </div>
                    
                    <div class="p-5 bg-green-50 rounded-lg shadow">
                        <h3 class="font-semibold text-green-700 mb-2">Resumen Neto Mes Actual (${appState.config.month}/${appState.config.year})</h3>
                        <p id="current-month-net-display" class="text-3xl font-extrabold text-green-900">Genera el c谩lculo para ver el monto</p>
                    </div>
                </div>
            </div>

            <div id="config-view" class="hidden" data-view="config-view">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Ajustes de Perfil y Rotaci贸n</h2>
                <p class="text-sm text-gray-500 mb-4">Estos valores se aplican a todos los c谩lculos y se guardan autom谩ticamente.</p>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Valor Hora Bruta ($)</label>
                        <input id="input-valorHora" type="number" name="valorHora" class="input-style" onchange="handleConfigChange()" step="0.01">
                    </div>
                    <div class="col-span-1 md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Desc. Afiliaci贸n</label>
                        <select id="input-discountRate" name="discountRate" class="input-style" onchange="handleConfigChange()">
                            <option value="0.18">No Afiliado (18%)</option>
                            <option value="0.16">Afiliado (16%)</option>
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Fecha del ltimo Franco (D铆a 2)</label>
                        <input id="input-lastFrancoDate" type="date" name="lastFrancoDate" class="input-style" onchange="handleConfigChange()">
                    </div>
                    <div class="col-span-2">
                        <label class="block text-sm font-medium text-gray-700">Turno Post-Franco</label>
                        <select id="input-initialTurn" name="initialTurn" class="input-style" onchange="handleConfigChange()">
                            <option value="Ma帽ana">Ma帽ana</option>
                            <option value="Noche">Noche</option>
                            <option value="Tarde">Tarde</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="monthly-history-view" class="hidden" data-view="monthly-history-view">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Historial de C谩lculos y Detalle Mensual</h2>
                <p class="text-sm text-gray-500 mb-4">Seleccione un mes para ver o editar sus datos de horas extra y feriados.</p>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 p-4 bg-indigo-50 rounded-lg">
                    <div>
                        <label class="block text-sm font-medium text-indigo-700">Mes a Generar</label>
                        <select id="input-month" name="month" class="input-style bg-white" onchange="handleMonthSelectionChange()">
                            </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-indigo-700">A帽o</label>
                        <input id="input-year" type="number" name="year" class="input-style" onchange="handleMonthSelectionChange()">
                    </div>
                    <div class="col-span-2 flex items-end space-x-4">
                         <button id="calculate-schedule-button" class="flex-1 py-2 rounded-lg text-white font-bold transition duration-150 bg-indigo-700 hover:bg-indigo-800 text-sm">
                            Generar/Actualizar Horario
                        </button>
                        <button id="next-month-button" class="py-2 px-4 rounded-lg text-indigo-700 font-bold transition duration-150 bg-indigo-200 hover:bg-indigo-300 text-sm">
                            Generar Mes Siguiente &rarr;
                        </button>
                    </div>
                </div>

                <div id="monthly-detail-view" class="mt-6 border p-4 rounded-lg bg-white shadow-inner">
                    <h3 class="text-lg font-bold text-gray-700 mb-4">Detalle de Mes: <span id="current-detail-month-year">Cargando...</span></h3>

                    <div id="results-section">
                         <h3 class="text-xl font-bold text-indigo-700 mb-4">Resumen de Ganancias</h3>
                        <div id="summary-cards" class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm font-medium mb-6">
                            </div>

                        <div id="francos-info" class="p-3 bg-yellow-50 rounded-lg text-sm mb-4">
                            </div>

                        <button id="generate-pdf-button" class="w-full py-2 mb-6 rounded-lg bg-red-600 hover:bg-red-700 text-white font-bold transition duration-150 flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                            Descargar Reporte PDF
                        </button>
                    
                        <h4 class="text-lg font-bold text-gray-800 mb-3 border-t pt-4">Detalle Diario, Feriados y Horas Extra</h4>
                        <p class="text-xs text-red-600 mb-3">
                            锔 Marca la casilla "Es Feriado" para aplicar la equivalencia de **32 Horas** (si trabajas) o **8 Horas** (si es Franco).
                        </p>
                        <div id="daily-detail-table-container" class="overflow-x-auto rounded-lg border" style="max-height: 400px; overflow-y: auto;">
                            <table id="daily-detail-table" class="min-w-full divide-y divide-gray-200 text-xs">
                                <thead class="bg-gray-100 sticky-header">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-gray-500">Fecha</th>
                                        <th class="px-3 py-2 text-left text-gray-500">Turno</th>
                                        <th class="px-3 py-2 text-center text-gray-500">Es Feriado</th>
                                        <th class="px-3 py-2 text-right text-gray-500">H. Eq. Base</th>
                                        <th class="px-3 py-2 text-center text-gray-500">H. Extra (Reales)</th>
                                        <th class="px-3 py-2 text-right text-gray-500">H. Eq. Total</th>
                                        <th class="px-3 py-2 text-right text-gray-500">Monto Bruto</th>
                                    </tr>
                                </thead>
                                <tbody id="daily-detail-tbody" class="bg-white divide-y divide-gray-200">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div> <div id="comparisons-view" class="hidden" data-view="comparisons-view">
                 <h2 class="text-xl font-bold text-gray-800 mb-4">An谩lisis de Diferencias Salariales</h2>
                 <p class="text-sm text-gray-500 mb-4">Esta secci贸n analizar谩 los meses hist贸ricos guardados para explicar variaciones en el sueldo neto.</p>

                 <div id="comparisons-list" class="space-y-4">
                    <p class="p-4 bg-yellow-100 text-yellow-800 rounded-lg">
                        锔 **Informaci贸n Hist贸rica Requerida:** Para que esta vista funcione, debes generar y guardar los c谩lculos de varios meses en el Dashboard Mensual.
                    </p>
                    </div>
            </div>

        </div> </div>

    <script type="module">
        // =====================================================================
        // CONFIGURACIN DE FIREBASE (INTEGRADO DIRECTAMENTE)
        // =====================================================================
       
        // ** CONFIGURACIN PROPORCIONADA POR EL USUARIO **
        const HARDCODED_FIREBASE_CONFIG = {
            apiKey: "AIzaSyC_gewonkD_XnzQmwmUnQuhfzOf5zdm9lw",
            authDomain: "calculadora-6x2.firebaseapp.com",
            projectId: "calculadora-6x2",
            storageBucket: "calculadora-6x2.firebasestorage.app",
            messagingSenderId: "238926197886",
            appId: "1:238926197886:web:d05857b007dcb305e9d42f"
        };
       
        // =====================================================================
        // CONFIGURACIN, CONSTANTES Y ESTADO GLOBAL
        // =====================================================================

        // Constantes de negocio
        const EXTRA_HOUR_MULTIPLIER = 1.5;
        const HOLIDAY_WORKED_EQUIV_HOURS = 32;
        const HOLIDAY_FREE_EQUIV_HOURS = 8;
       
        // Variables de entorno de Canvas (se usan para identificaci贸n del entorno)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
       
        // Instancias de Firebase y Estado de Autenticaci贸n
        let app;
        let auth;
        let db;
        let userId = null;
        let userName = 'Usuario Temporal';
        let isAuthReady = false;
        let isFirebaseActive = true;
       
        // Estado Global de la Aplicaci贸n (Simulando React state)
        let appState = {
            config: { // Configuraci贸n Global
                month: new Date().getMonth() + 1,
                year: new Date().getFullYear(),
                valorHora: 3758,
                lastFrancoDate: getYesterdayDate(),
                initialTurn: 'Ma帽ana',
                discountRate: 0.18,
            },
            monthlyData: {}, // Datos cargados del mes actual (extraHours, manualHolidays)
            extraHours: {},
            manualHolidays: {},
            calculationResult: null, // Resultado del c谩lculo del mes actual (temporal)
            historicalResults: {}, // { 'YYYY-MM': { net: 123, equivHours: 456, ... } }
            isLoading: false,
            status: null,
            currentView: 'home-view',
        };

        // Elementos del DOM
        const statusEl = document.getElementById('status-message');
        const summaryCardsEl = document.getElementById('summary-cards');
        const francosInfoEl = document.getElementById('francos-info');
        const tbodyEl = document.getElementById('daily-detail-tbody');
        const resultsSectionEl = document.getElementById('results-section');
        const calculateButtonEl = document.getElementById('calculate-schedule-button');
        const generatePdfButtonEl = document.getElementById('generate-pdf-button');
        const userInfoEl = document.getElementById('user-info');
        const googleLoginBtn = document.getElementById('google-login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const nextMonthButtonEl = document.getElementById('next-month-button');
        const currentDetailMonthYearEl = document.getElementById('current-detail-month-year');
        
        // Elementos de la nueva vista HOME
        const nextFrancosDisplayEl = document.getElementById('next-francos-display');
        const nextQuincenaDisplayEl = document.getElementById('next-quincena-display');
        const currentMonthNetDisplayEl = document.getElementById('current-month-net-display');
        const comparisonsListEl = document.getElementById('comparisons-list');


        // =====================================================================
        // UTILIDADES Y AYUDANTES DE UI
        // =====================================================================

        function getYesterdayDate() {
            const date = new Date();
            date.setDate(date.getDate() - 1);
            return formatDateForInput(date);
        }

        function formatDateForInput(date) {
            return date.toISOString().split('T')[0];
        }

        function formatDateForDisplay(date) {
            return date.toLocaleDateString('es-AR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        }
        
        function formatMonthYear(month, year) {
             const monthName = new Date(year, month - 1).toLocaleDateString('es-AR', { month: 'long' });
             return `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${year}`;
        }

        function formatCurrency(amount) {
            const number = parseFloat(amount) || 0;
            return number.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 });
        }
       
        function formatNumber(amount, decimals = 2) {
             const number = parseFloat(amount) || 0;
             return number.toLocaleString('es-AR', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
        }

        function getTurnEquivalencies(dayOfWeek, turnType) {
            let realHours = 8;
            let equivalentHours = 8;
            let turnBaseName = turnType;
           
            if (dayOfWeek >= 1 && dayOfWeek <= 5) { // Lunes a Viernes
                switch (turnType) {
                    case 'Ma帽ana':
                    case 'Tarde': equivalentHours = 8; break;
                    case 'Noche': equivalentHours = 12; break; // Recargo Nocturno
                }
            } else if (dayOfWeek === 6) { // S谩bado
                switch (turnType) {
                    case 'Ma帽ana': realHours = 8; equivalentHours = 9; break;
                    case 'Tarde': realHours = 9; equivalentHours = 12; break;
                    case 'Noche': realHours = 8; equivalentHours = 16; break;
                }
            } else if (dayOfWeek === 0) { // Domingo
                turnBaseName = 'Domingo ' + turnType;
                switch (turnType) {
                    case 'Ma帽ana':
                    case 'Tarde': realHours = 8; equivalentHours = 24; break; // Recargo Dominical (Triple)
                    case 'Noche': realHours = 8; equivalentHours = 28; break; // Recargo Dominical + Nocturno
                }
            }
            return { realHours, equivalentHours, turnBaseName };
        }

        function updateStatus(type, message) {
            // L贸gica existente para mostrar mensajes de estado
            appState.status = { type, message };
            if (!message) {
                statusEl.classList.add('hidden');
                return;
            }
           
            statusEl.classList.remove('hidden');
            let colorClass = "";
            switch (type) {
                case 'success': colorClass = "bg-green-100 text-green-700"; break;
                case 'error': colorClass = "bg-red-100 text-red-700"; break;
                case 'info': colorClass = "bg-blue-100 text-blue-700"; break;
                default: colorClass = "bg-gray-100 text-gray-700"; break;
            }
            statusEl.className = `p-3 rounded-lg mt-4 font-semibold text-sm ${colorClass}`;
            statusEl.textContent = message;
        }

        function setLoading(loading) {
            // L贸gica existente para mostrar estado de carga
            appState.isLoading = loading;
            const text = loading ? 'Calculando...' : 'Generar/Actualizar Horario';
            calculateButtonEl.textContent = text;
            calculateButtonEl.disabled = loading;
            nextMonthButtonEl.disabled = loading;

            if (loading) {
                calculateButtonEl.classList.add('bg-indigo-400');
                calculateButtonEl.classList.remove('bg-indigo-700', 'hover:bg-indigo-800');
            } else {
                calculateButtonEl.classList.remove('bg-indigo-400');
                calculateButtonEl.classList.add('bg-indigo-700', 'hover:bg-indigo-800');
            }
        }
       
        function updateAuthUI() {
            // L贸gica existente para actualizar UI de autenticaci贸n
            if (!isAuthReady) {
                userInfoEl.textContent = 'Cargando Autenticaci贸n...';
                googleLoginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
                return;
            }
           
            const user = auth?.currentUser;
           
            if (userId && user && !user.isAnonymous) {
                userInfoEl.textContent = `Hola, ${userName} (${userId.substring(0, 4)}...)`;
                googleLoginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
            } else {
                userInfoEl.textContent = `Sesi贸n: ${userName} (${userId ? userId.substring(0, 4) + '...' : 'Local'})`;
                googleLoginBtn.classList.remove('hidden');
                logoutBtn.classList.add('hidden');
            }
        }
       
        /** FUNCIN DE NAVEGACIN (Actualizada para 4 vistas) **/
        function navigateTo(viewId) {
            appState.currentView = viewId;

            document.querySelectorAll('#view-container > div').forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');

            document.querySelectorAll('.nav-tab').forEach(tab => {
                if (tab.getAttribute('data-view') === viewId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            // Acciones espec铆ficas al navegar
            if (viewId === 'home-view') {
                 renderHomeView();
            } else if (viewId === 'monthly-history-view') {
                 // Cuando navegamos al dashboard, refrescamos el hist贸rico
                 fetchAllMonthResults();
            } else if (viewId === 'comparisons-view') {
                 renderComparisonsView();
            }
        }
        window.navigateTo = navigateTo;

        function updateUIFromState() {
            // 1. Actualizar Inputs de Configuraci贸n
            const config = appState.config;
            document.getElementById('input-year').value = config.year;
            document.getElementById('input-valorHora').value = config.valorHora;
            document.getElementById('input-lastFrancoDate').value = config.lastFrancoDate;
            document.getElementById('input-initialTurn').value = config.initialTurn;
            document.getElementById('input-discountRate').value = config.discountRate;
           
            // 2. Llenar opciones de meses
            const monthSelect = document.getElementById('input-month');
            if (monthSelect.options.length === 0 || monthSelect.options.length !== 12) {
                 monthSelect.innerHTML = '';
                Array.from({ length: 12 }, (_, i) => i + 1).forEach(m => {
                    const option = document.createElement('option');
                    option.value = m;
                    option.textContent = formatMonthYear(m, config.year);
                    monthSelect.appendChild(option);
                });
            }
            monthSelect.value = config.month;
            currentDetailMonthYearEl.textContent = formatMonthYear(config.month, config.year);


            // 3. Mostrar Resultados
            renderCalculationResults();

            // 4. Actualizar Status y Loading
            updateStatus(appState.status?.type, appState.status?.message);
            setLoading(appState.isLoading);
           
            // 5. Actualizar UI de Autenticaci贸n
            updateAuthUI();

            // 6. Configurar la vista actual (si es la primera carga)
            navigateTo(appState.currentView);
        }
        
        // =====================================================================
        // INTEGRACIN FIREBASE (Autenticaci贸n y Persistencia)
        // =====================================================================

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel, doc, setDoc, onSnapshot, collection, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Rutas de Firestore
        function getConfigDocRef() {
            if (!db || !userId) return null;
            return doc(db, 'artifacts', appId, 'users', userId, 'config', 'salary');
        }
       
        function getDataDocRef(monthDocId) {
            if (!db || !userId) return null;
            return doc(db, 'artifacts', appId, 'users', userId, 'data', monthDocId);
        }
        
        function getDataCollectionRef() {
             if (!db || !userId) return null;
             return collection(db, 'artifacts', appId, 'users', userId, 'data');
        }

        // --- Funciones de Firebase (Autenticaci贸n/SignIn/SignOut) (sin cambios) ---
        // (La l贸gica se mantiene dentro del script)
        // ... (initFirebase, signInWithGoogle, signOutUser, etc.) ...
        const initFirebase = async () => {
             // ... [Misma L贸gica de Inicializaci贸n y Autenticaci贸n de Firebase] ...
             updateStatus('info', 'Conectando a Firebase para autenticaci贸n y persistencia de datos...');

            try {
                app = initializeApp(HARDCODED_FIREBASE_CONFIG);
                auth = getAuth(app);
                db = getFirestore(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        userName = user.displayName || user.email || (user.isAnonymous ? 'Temporal' : 'Usuario');
                        isAuthReady = true;
                        updateStatus('success', `Sesi贸n iniciada. Bienvenido, ${userName}!`);
                        setupDataListeners();
                        fetchAllMonthResults(); // Cargar todos los resultados al iniciar
                    } else {
                        signInAnonymously(auth).then(anonUser => {
                            userId = anonUser.user.uid;
                            userName = 'Temporal (An贸nimo)';
                            isAuthReady = true;
                            updateStatus('info', 'Sesi贸n iniciada an贸nimamente.');
                            setupDataListeners();
                            fetchAllMonthResults(); // Cargar todos los resultados al iniciar
                        }).catch(e => {
                            console.error("Fallo de autenticaci贸n an贸nima:", e);
                            userId = crypto.randomUUID();
                            userName = 'Local (Error)';
                            isAuthReady = true;
                            isFirebaseActive = false;
                            updateStatus('error', 'Error de sesi贸n. Usando ID local sin persistencia.');
                            calculateSchedule(false);
                        });
                    }
                    updateUIFromState();
                });

            } catch (error) {
                console.error("Error cr铆tico al inicializar Firebase o al autenticar:", error);
                updateStatus('error', `Error Cr铆tico: ${error.code || error.message}. La aplicaci贸n no tendr谩 persistencia.`);
                isFirebaseActive = false;
                userId = crypto.randomUUID();
                isAuthReady = true;
                userName = 'Local (Error)';
                calculateSchedule(false);
                updateUIFromState();
            }
        };

        googleLoginBtn.addEventListener('click', signInWithGoogle);
        logoutBtn.addEventListener('click', signOutUser);

        async function signInWithGoogle() {
            if (!auth) { updateStatus('error', 'Firebase Auth no est谩 inicializado.'); return; }
            updateStatus('info', 'Iniciando sesi贸n con Google...');
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("Error al iniciar sesi贸n con Google:", error);
                updateStatus('error', `Error de Google Auth: ${error.code || error.message}`);
            }
        }
       
        async function signOutUser() {
            if (!auth) return;
            try { await signOut(auth); } catch (error) { console.error("Error al cerrar sesi贸n:", error); updateStatus('error', `Error al cerrar sesi贸n: ${error.message}`); }
        }


        // 2. Funciones de Carga y Guardado
        function saveConfig() {
            if (!isFirebaseActive || !isAuthReady || !userId || !db) return;
            const configRef = getConfigDocRef();
            if (!configRef) return;

            const dataToSave = { ...appState.config };
            dataToSave.valorHora = Number(dataToSave.valorHora);
            dataToSave.discountRate = Number(dataToSave.discountRate);
            dataToSave.month = Number(dataToSave.month);
            dataToSave.year = Number(dataToSave.year);

            setDoc(configRef, dataToSave, { merge: true })
                .catch(error => { console.error("Error saving config:", error); updateStatus('error', "Error al guardar configuraci贸n."); });
        }
       
        function saveData() {
            if (!isFirebaseActive || !isAuthReady || !userId || !db || !appState.calculationResult) return;
           
            const config = appState.config;
            const monthDocId = `${config.year}-${String(config.month).padStart(2, '0')}`;
            const dataRef = getDataDocRef(monthDocId);
            if (!dataRef) return;
           
            // GUARDAR DATOS INTERACTIVOS + RESULTADO COMPLETO DEL CLCULO
            setDoc(dataRef, {
                extras: appState.extraHours,
                holidayFlags: appState.manualHolidays,
                results: {
                    neto: appState.calculationResult.totalNeto,
                    bruto: appState.calculationResult.totalBruto,
                    equivHours: appState.calculationResult.totalEquivalentHours,
                    // Se pueden guardar m谩s campos para comparaci贸n
                    configSnapshot: {
                         valorHora: config.valorHora,
                         discountRate: config.discountRate
                    }
                }
            }, { merge: true })
            .then(() => fetchAllMonthResults()) // Actualizar hist贸rico despu茅s de guardar
            .catch(error => { console.error("Error saving month data:", error); updateStatus('error', "Error al guardar datos de horas/feriados."); });
        }
       
        /** NUEVA FUNCIN: Obtener todos los meses hist贸ricos (para Home y Comparaciones) **/
        async function fetchAllMonthResults() {
             if (!isFirebaseActive || !isAuthReady || !userId || !db) return;
             const dataCollectionRef = getDataCollectionRef();
             if (!dataCollectionRef) return;
             
             try {
                const snapshot = await getDocs(dataCollectionRef);
                const historicalResults = {};
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.results) {
                        historicalResults[doc.id] = data.results;
                    }
                });
                appState.historicalResults = historicalResults;
                // Si estamos en la vista de comparaciones, renderizarla.
                if (appState.currentView === 'comparisons-view') renderComparisonsView();
                // Tambi茅n actualiza la vista de Inicio para las quincenas.
                if (appState.currentView === 'home-view') renderHomeView();

             } catch (error) {
                 console.error("Error fetching all month data:", error);
                 updateStatus('error', 'Error al cargar historial de meses.');
             }
        }


        // 3. Listeners de Datos (onSnapshot)
        let unsubscribeConfig = null;
        let unsubscribeData = null;

        function setupDataListeners() {
            if (!isFirebaseActive || !isAuthReady || !userId || !db) {
                calculateSchedule(false);
                return;
            }
           
            // 3.1 Listener de Configuraci贸n (Global) - Sin cambios
            if (unsubscribeConfig) unsubscribeConfig();
            const configRef = getConfigDocRef();
            if (configRef) {
                unsubscribeConfig = onSnapshot(configRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        appState.config = {
                            ...appState.config, ...data,
                            valorHora: Number(data.valorHora) || appState.config.valorHora,
                            discountRate: Number(data.discountRate) || appState.config.discountRate,
                            month: Number(data.month) || appState.config.month,
                            year: Number(data.year) || appState.config.year,
                        };
                        updateUIFromState();
                        // Al cargar la config, forzamos la recarga de los datos del mes
                        setupMonthDataListener();
                    } else {
                        saveConfig();
                    }
                }, (error) => { console.error("Error fetching config:", error); updateStatus('error', "Error al cargar configuraci贸n."); });
            }
        }
        
        // 3.2 Listener de Datos Mensuales (Extra Hours / Holidays) - L贸gica Separada
        function setupMonthDataListener() {
            if (!isFirebaseActive || !isAuthReady || !userId || !db) return;
            
            if (unsubscribeData) unsubscribeData();
            const config = appState.config;
            const monthDocId = `${config.year}-${String(config.month).padStart(2, '0')}`;
            const dataRef = getDataDocRef(monthDocId);

            if (dataRef) {
                unsubscribeData = onSnapshot(dataRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        appState.extraHours = data.extras || {};
                        appState.manualHolidays = data.holidayFlags || {};
                        // Opcional: Cargar resultado previo del c谩lculo si existe
                        appState.calculationResult = data.results?.neto ? { ...data.results } : null; 
                    } else {
                        appState.extraHours = {};
                        appState.manualHolidays = {};
                        appState.calculationResult = null;
                    }
                    updateUIFromState();
                    // Recalcular solo si estamos en el dashboard o si ya hab铆a un resultado
                    if (appState.currentView === 'monthly-history-view' || appState.calculationResult) {
                         calculateSchedule(false);
                    }
                }, (error) => { console.error("Error fetching month data:", error); updateStatus('error', "Error al cargar datos de mes."); });
            }
        }


        // =====================================================================
        // MANEJADORES DE EVENTOS
        // =====================================================================

        function handleConfigChange() {
            // L贸gica existente para guardar la configuraci贸n (Valor Hora, Franco, etc.)
            const newConfig = {
                month: parseInt(document.getElementById('input-month').value),
                year: parseInt(document.getElementById('input-year').value),
                valorHora: parseFloat(document.getElementById('input-valorHora').value) || appState.config.valorHora,
                lastFrancoDate: document.getElementById('input-lastFrancoDate').value,
                initialTurn: document.getElementById('input-initialTurn').value,
                discountRate: parseFloat(document.getElementById('input-discountRate').value) || appState.config.discountRate,
            };
           
            appState.config = newConfig;
            saveConfig();
            // Esto llamar谩 a setupDataListeners, que llamar谩 a setupMonthDataListener, que forzar谩 el c谩lculo.
        }
        window.handleConfigChange = handleConfigChange;
        
        /** NUEVO: Maneja el cambio de mes/a帽o en la vista Dashboard/Historial **/
        function handleMonthSelectionChange() {
             const newMonth = parseInt(document.getElementById('input-month').value);
             const newYear = parseInt(document.getElementById('input-year').value);
             
             if (newMonth === appState.config.month && newYear === appState.config.year) return;
             
             // Actualizar la configuraci贸n para cargar el nuevo mes
             appState.config.month = newMonth;
             appState.config.year = newYear;
             saveConfig(); // Guardar la selecci贸n del 煤ltimo mes activo
             setupMonthDataListener(); // Forzar la carga de datos del nuevo mes
        }
        
        window.handleExtraChange = function(dateKey, inputElement) {
            const hours = parseFloat(inputElement.value) || 0;
            appState.extraHours[dateKey] = hours;
            // No se llama saveData() aqu铆, solo se llama despu茅s de un c谩lculo completo
            calculateSchedule(false);
        }

        window.handleHolidayChange = function(dateKey, checkboxElement) {
            if (checkboxElement.checked) {
                appState.manualHolidays[dateKey] = true;
            } else {
                delete appState.manualHolidays[dateKey];
            }
            // No se llama saveData() aqu铆, solo se llama despu茅s de un c谩lculo completo
            calculateSchedule(false);
        }

        /** LGICA DE CLCULO AL HACER CLICK **/
        calculateButtonEl.addEventListener('click', () => {
             // 1. Ejecutar el c谩lculo completo
             calculateSchedule(true);
             // 2. Guardar el resultado del c谩lculo y los datos de entrada
             saveData();
        });

        /** FUNCIN PARA AVANZAR AL MES SIGUIENTE **/
        function handleNextMonth() {
            setLoading(true);
            
            let newMonth = appState.config.month + 1;
            let newYear = appState.config.year;

            if (newMonth > 12) {
                newMonth = 1;
                newYear += 1;
            }

            // 1. Actualizar la configuraci贸n del mes/a帽o en el estado
            appState.config.month = newMonth;
            appState.config.year = newYear;

            // 2. Guardar la configuraci贸n (esto activar谩 el listener de Firebase)
            saveConfig(); 
            
            // 3. Forzar el cambio del listener de datos para cargar los datos del nuevo mes
            setupMonthDataListener();
            
            updateStatus('info', `Cargando datos para el nuevo mes: ${newMonth}/${newYear}...`);
            // Cambiar a la vista de Dashboard
            navigateTo('monthly-history-view');
        }
        nextMonthButtonEl.addEventListener('click', handleNextMonth);
        
        // Configuraci贸n de los listeners de navegaci贸n
        document.getElementById('tab-home').addEventListener('click', () => navigateTo('home-view'));
        document.getElementById('tab-config').addEventListener('click', () => navigateTo('config-view'));
        document.getElementById('tab-dashboard').addEventListener('click', () => navigateTo('monthly-history-view'));
        document.getElementById('tab-comparisons').addEventListener('click', () => navigateTo('comparisons-view'));

        // =====================================================================
        // LGICA DE CLCULO (Se mantiene igual, solo se mueve al final)
        // =====================================================================
       
        function calculateSchedule(initialCalculation = true) {
            // ... [Misma L贸gica de C谩lculo Salarial 6x2] ...
            if (initialCalculation) setLoading(true);

            const { month, year, lastFrancoDate, initialTurn, valorHora, discountRate } = appState.config;
           
            if (!lastFrancoDate || !valorHora || isNaN(valorHora) || valorHora <= 0) {
                 if (initialCalculation) setLoading(false);
                 updateStatus('error', 'Por favor, ingrese un Valor de Hora Bruta y una Fecha de ltimo Franco v谩lidos. (Ver Configuraci贸n)');
                 appState.calculationResult = null;
                 resultsSectionEl.classList.add('hidden');
                 updateUIFromState();
                 return;
            }

            let currentDate = new Date(year, month - 1, 1, 0, 0, 0);
            
            // Ajustar la fecha inicial para el c谩lculo de rotaci贸n
            const lastFrancoDay2 = new Date(lastFrancoDate + 'T00:00:00');
            const dayAfterFranco = new Date(lastFrancoDay2.getTime());
            dayAfterFranco.setDate(dayAfterFranco.getDate() + 1);

            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi茅rcoles', 'Jueves', 'Viernes', 'S谩bado'];
            let dailyResults = [];
            let francosDates = [];
           
            // Ciclo 6x2 (24 d铆as de rotaci贸n)
            const masterCycle = [
                'Ma帽ana', 'Ma帽ana', 'Ma帽ana', 'Ma帽ana', 'Ma帽ana', 'Ma帽ana', 'Franco', 'Franco',
                'Noche', 'Noche', 'Noche', 'Noche', 'Noche', 'Noche', 'Franco', 'Franco',
                'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Franco', 'Franco'
            ];
           
            let baseOffset = 0;
            if (initialTurn === 'Noche') baseOffset = 8;
            else if (initialTurn === 'Tarde') baseOffset = 16;
           
            const diffTime = currentDate.getTime() - dayAfterFranco.getTime();
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
           
            let startOffset = (baseOffset + diffDays) % 24;
            if (startOffset < 0) startOffset += 24;

            let dayCounter = 0;
            const daysInMonth = new Date(year, month, 0).getDate();

            while (dayCounter < daysInMonth) {
                const dayOfWeek = currentDate.getDay();
                const dateKeyForSave = formatDateForDisplay(currentDate);
                const dateKeyForInput = formatDateForInput(currentDate);
               
                const isHolidayManual = appState.manualHolidays[dateKeyForSave] === true;
               
                const cycleStatus = masterCycle[startOffset];
               
                let turnBaseName = cycleStatus;
                let realHours = 0;
                let equivalentHours = 0;
               
                if (cycleStatus === 'Franco') {
                    if (isHolidayManual) {
                        turnBaseName = `FERIADO - Franco`;
                        equivalentHours = HOLIDAY_FREE_EQUIV_HOURS;
                        francosDates.push(dateKeyForSave + ' (Feriado)');
                    } else {
                         turnBaseName = `Franco`;
                         francosDates.push(dateKeyForSave);
                    }
                }
                else {
                    if (isHolidayManual) {
                        turnBaseName = `FERIADO - ${cycleStatus}`;
                        realHours = 8;
                        equivalentHours = HOLIDAY_WORKED_EQUIV_HOURS;
                    } else {
                        const equivalences = getTurnEquivalencies(dayOfWeek, cycleStatus);
                        realHours = equivalences.realHours;
                        equivalentHours = equivalences.equivalentHours;
                        turnBaseName = equivalences.turnBaseName;
                    }
                }
               
                dailyResults.push({
                    date: dateKeyForSave,
                    dateKey: dateKeyForInput,
                    day: dayNames[dayOfWeek],
                    turn: turnBaseName,
                    isHoliday: isHolidayManual,
                    realHours: realHours,
                    equivHoursBase: equivalentHours,
                });
               
                startOffset = (startOffset + 1) % 24;
                currentDate.setDate(currentDate.getDate() + 1);
                dayCounter++;
            }
           
            let totalEquivalentHours = 0;
            let totalExtraHoursReal = 0;
            const hourlyRate = parseFloat(valorHora) || 0;

            const finalDailyResults = dailyResults.map(day => {
                const dayExtraReal = appState.extraHours[day.date] || 0;
               
                let dayExtraEquivalent = 0;
               
                if (dayExtraReal > 0) {
                    dayExtraEquivalent = (dayExtraReal * EXTRA_HOUR_MULTIPLIER);
                    totalExtraHoursReal += dayExtraReal;
                }
               
                const finalEquivHours = day.equivHoursBase + dayExtraEquivalent;
                const finalDailyBruto = finalEquivHours * hourlyRate;

                totalEquivalentHours += finalEquivHours;

                return {
                    ...day,
                    extraReal: dayExtraReal,
                    extraEquiv: dayExtraEquivalent,
                    equivHoursFinal: finalEquivHours,
                    dailyBruto: finalDailyBruto,
                };
            });

            const totalBruto = totalEquivalentHours * hourlyRate;
            const totalDescuento = totalBruto * discountRate;
            const totalNeto = totalBruto - totalDescuento;

            appState.calculationResult = {
                dailyResults: finalDailyResults,
                francosDates,
                totalEquivalentHours,
                totalExtraHoursReal,
                totalBruto,
                totalDescuento,
                totalNeto,
                discountRate: discountRate * 100,
            };

            if (initialCalculation) setLoading(false);
            updateUIFromState();
            // Mostrar mensaje solo si es c谩lculo inicial
            if (initialCalculation) updateStatus('success', `C谩lculo generado para ${formatMonthYear(month, year)}. Los datos han sido guardados.`);
        }
       
        // =====================================================================
        // RENDERIZADO DE VISTAS ESPECFICAS
        // =====================================================================
        
        /** RENDERIZADO DE VISTA INICIO **/
        function renderHomeView() {
            // --- 1. Calcular Pr贸ximos Francos ---
            const today = new Date();
            const lastFrancoDay2 = new Date(appState.config.lastFrancoDate + 'T00:00:00');
            const dayAfterFranco = new Date(lastFrancoDay2.getTime());
            dayAfterFranco.setDate(dayAfterFranco.getDate() + 1);
            
            const dayNamesFull = ['Domingo', 'Lunes', 'Martes', 'Mi茅rcoles', 'Jueves', 'Viernes', 'S谩bado'];
            const masterCycle = [
                'Ma帽ana', 'Ma帽ana', 'Ma帽ana', 'Ma帽ana', 'Ma帽ana', 'Ma帽ana', 'Franco', 'Franco',
                'Noche', 'Noche', 'Noche', 'Noche', 'Noche', 'Noche', 'Franco', 'Franco',
                'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Tarde', 'Franco', 'Franco'
            ];
            let baseOffset = (appState.config.initialTurn === 'Noche' ? 8 : (appState.config.initialTurn === 'Tarde' ? 16 : 0));

            let nextFrancos = [];
            let checkDate = new Date(today.getTime());
            let safetyCounter = 0;
            
            while (nextFrancos.length < 2 && safetyCounter < 60) {
                const diffTime = checkDate.getTime() - dayAfterFranco.getTime();
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                let offset = (baseOffset + diffDays) % 24;
                if (offset < 0) offset += 24;

                if (masterCycle[offset] === 'Franco') {
                    // Solo agregamos si la fecha es hoy o posterior
                    if (checkDate.getTime() >= today.getTime() - 86400000) { // Un d铆a atr谩s para incluir el franco de hoy si aplica
                        nextFrancos.push({ 
                            day: dayNamesFull[checkDate.getDay()],
                            date: formatDateForDisplay(checkDate) 
                        });
                    }
                }
                
                checkDate.setDate(checkDate.getDate() + 1);
                safetyCounter++;
            }
            
            if (nextFrancos.length > 0) {
                 nextFrancosDisplayEl.innerHTML = nextFrancos.slice(0, 2).map(f => 
                    `<p class="text-xl">${f.day.toUpperCase()} (${f.date})</p>`).join('');
            } else {
                 nextFrancosDisplayEl.textContent = 'No se encontraron pr贸ximos francos.';
            }

            // --- 2. Estimaci贸n de Quincenas ---
            const currentMonthKey = `${appState.config.year}-${String(appState.config.month).padStart(2, '0')}`;
            
            // Pr贸xima Quincena (Basada en el mes actual calculado)
            const currentNet = appState.calculationResult ? appState.calculationResult.totalNeto : 0;
            const nextQuincena = currentNet / 2;
            nextQuincenaDisplayEl.textContent = formatCurrency(nextQuincena);
            
            currentMonthNetDisplayEl.textContent = currentNet > 0 
                ? formatCurrency(currentNet) 
                : 'Generar c谩lculo para ver el monto total del mes.';

            // ltima Quincena (Basada en el mes anterior guardado en historicalResults)
            const prevMonthDate = new Date(appState.config.year, appState.config.month - 2, 1);
            const prevMonthKey = `${prevMonthDate.getFullYear()}-${String(prevMonthDate.getMonth() + 1).padStart(2, '0')}`;
            
            const lastMonthNet = appState.historicalResults[prevMonthKey]?.neto || 0;
            const lastQuincena = lastMonthNet / 2;
            
            // Usaremos el mismo display de quincena para ambos (por simplicidad, mostrando la pr贸xima)
            // Si quisiera mostrar la 煤ltima, a帽adir铆a un card m谩s. Por ahora, solo muestro el total del mes y la pr贸xima.
        }

        /** RENDERIZADO DE VISTA COMPARACIONES **/
        function renderComparisonsView() {
            const keys = Object.keys(appState.historicalResults).sort().reverse();
            comparisonsListEl.innerHTML = ''; // Limpiar

            if (keys.length < 2) {
                 comparisonsListEl.innerHTML = `<p class="p-4 bg-yellow-100 text-yellow-800 rounded-lg">
                    锔 **Informaci贸n Hist贸rica Requerida:** Necesitas al menos dos meses con c谩lculos guardados para realizar comparaciones.
                 </p>`;
                 return;
            }

            // Renderizar comparaci贸n del mes m谩s reciente con el anterior
            const currentKey = keys[0];
            const previousKey = keys[1];
            
            const current = appState.historicalResults[currentKey];
            const previous = appState.historicalResults[previousKey];
            
            const [currentYear, currentMonth] = currentKey.split('-');
            const [prevYear, prevMonth] = previousKey.split('-');

            const currentMonthName = formatMonthYear(parseInt(currentMonth), parseInt(currentYear));
            const prevMonthName = formatMonthYear(parseInt(prevMonth), parseInt(prevYear));

            const netDiff = current.neto - previous.neto;
            const hoursDiff = current.equivHours - previous.equivHours;

            let explanation = '';
            let color = 'bg-green-100 text-green-800';
            
            if (netDiff > 0) {
                explanation += `Se gan贸 **${formatCurrency(netDiff)}** m谩s en ${currentMonthName} que en ${prevMonthName}. Esto se debe principalmente a:`;
                explanation += `<ul>
                    <li>**Horas Equivalentes:** ${hoursDiff > 0 ? `Se generaron **${formatNumber(hoursDiff)} H.Eq.** m谩s.` : `A pesar de generar **${formatNumber(Math.abs(hoursDiff))} H.Eq.** menos, el neto subi贸.`}</li>
                    <li>**Recargos (Dominical/Nocturno/Feriado):** El aumento en las horas equivalentes base sugiere que hubo una **mayor cantidad de turnos con recargo** (Domingos y Noches) o **m谩s d铆as feriados trabajados** en ${currentMonthName} debido a la rotaci贸n.</li>
                    <li>**Horas Extra:** El total de horas equivalentes incluye horas extra (si fueron a帽adidas).</li>
                </ul>`;
                color = 'bg-green-100 text-green-800';
            } else if (netDiff < 0) {
                 explanation += `Se gan贸 **${formatCurrency(Math.abs(netDiff))}** menos en ${currentMonthName} que en ${prevMonthName}. Esto se debe principalmente a:`;
                 explanation += `<ul>
                    <li>**Horas Equivalentes:** ${hoursDiff < 0 ? `Se generaron **${formatNumber(Math.abs(hoursDiff))} H.Eq.** menos.` : `A pesar de generar **${formatNumber(hoursDiff)} H.Eq.** m谩s, el neto baj贸.`}</li>
                    <li>**Rotaci贸n Desfavorable:** La disminuci贸n en horas equivalentes base sugiere que la rotaci贸n en ${currentMonthName} tuvo **menos turnos con recargo** (Domingos y Noches) o m谩s Francos que el mes anterior.</li>
                 </ul>`;
                 color = 'bg-red-100 text-red-800';
            } else {
                 explanation = `Los ingresos netos fueron casi id茅nticos en ambos meses.`;
                 color = 'bg-blue-100 text-blue-800';
            }

            comparisonsListEl.innerHTML = `
                 <div class="p-4 rounded-lg ${color}">
                     <h3 class="font-bold text-lg mb-2">An谩lisis Detallado: ${currentMonthName} vs ${prevMonthName}</h3>
                     <p>${explanation}</p>
                 </div>
            `;
        }


        // =====================================================================
        // RENDERIZADO DE RESULTADOS (Se mantiene igual)
        // =====================================================================

        function renderCalculationResults() {
             const result = appState.calculationResult;
            if (!result) {
                resultsSectionEl.classList.add('hidden');
                return;
            }

            resultsSectionEl.classList.remove('hidden');

            // 1. Renderizar Cards de Resumen
            summaryCardsEl.innerHTML = `
                <div class="p-3 bg-gray-50 rounded-lg">
                    <p class="text-gray-500">H. Eq. Totales</p>
                    <p class="text-lg text-gray-900 font-extrabold">${formatNumber(result.totalEquivalentHours)}</p>
                </div>
                <div class="p-3 bg-red-50 rounded-lg">
                    <p class="text-gray-500">Desc. (${result.discountRate.toFixed(0)}%)</p>
                    <p class="text-lg text-red-600 font-extrabold">${formatCurrency(result.totalDescuento)}</p>
                </div>
                <div class="col-span-1 p-3 bg-indigo-50 rounded-lg">
                    <p class="text-gray-500">Bruto Total</p>
                    <p class="text-xl text-indigo-600 font-extrabold">${formatCurrency(result.totalBruto)}</p>
                </div>
                <div class="col-span-1 p-3 bg-green-100 rounded-lg shadow-md">
                    <p class="text-green-700 font-semibold">NETO (EN MANO)</p>
                    <p class="text-2xl text-green-800 font-extrabold">${formatCurrency(result.totalNeto)}</p>
                </div>
            `;
            
            // ... [Resto del renderizado de francos y tabla] ...
             francosInfoEl.innerHTML = `
                <p class="font-bold text-yellow-800">D铆as Francos en el Mes (${result.francosDates.length}):</p>
                <p class="mt-1">${result.francosDates.join('  ')}</p>
            `;

            tbodyEl.innerHTML = result.dailyResults.map(day => {
                const dateKeyForSave = day.date;
                const dayExtraReal = appState.extraHours[dateKeyForSave] || 0;
                const isFeriadoManual = appState.manualHolidays[dateKeyForSave] === true;
               
                const isFranco = day.turn.includes('Franco');
               
                let rowClasses = 'hover:bg-gray-50';
                if (isFranco && !isFeriadoManual) {
                    rowClasses = 'bg-yellow-50 hover:bg-yellow-100 font-semibold text-yellow-800';
                } else if (isFeriadoManual) {
                    rowClasses = 'bg-red-100 hover:bg-red-200 font-extrabold text-red-700';
                }

                return `
                    <tr class="${rowClasses}">
                        <td class="px-3 py-2 whitespace-nowrap text-gray-900">${day.date} - ${day.day.substring(0, 3)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-gray-700">${day.turn}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-center">
                            <input type="checkbox"
                                class="form-checkbox h-4 w-4 text-red-600 transition duration-150 ease-in-out"
                                ${isFeriadoManual ? 'checked' : ''}
                                onchange="handleHolidayChange('${dateKeyForSave}', this)"
                            >
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-right">${formatNumber(day.equivHoursBase, 2)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-center">
                            <input type="number"
                                value="${dayExtraReal || ''}"
                                class="w-16 text-center border rounded p-1 text-xs"
                                step="0.5" min="0"
                                onchange="handleExtraChange('${dateKeyForSave}', this)"
                            >
                        </td>
                        <td class="px-3 py-2 whitespace-nowrap text-right font-bold ${isFeriadoManual ? 'text-red-700' : ''}">${formatNumber(day.equivHoursFinal, 2)}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-right font-bold">${formatCurrency(day.dailyBruto)}</td>
                    </tr>
                `;
            }).join('');

            // Aseguramos que se actualice la vista de Inicio con el neto actual
            if (appState.currentView === 'home-view') renderHomeView();
        }

        // Funci贸n de generaci贸n de PDF
        generatePdfButtonEl.addEventListener('click', generatePDFReport);
        function generatePDFReport() {
             // ... [Misma L贸gica de Generaci贸n de PDF] ...
            const result = appState.calculationResult;
            if (!result) return updateStatus('error', 'Debe generar el c谩lculo antes de descargar el reporte.');

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
           
            const { month, year } = appState.config;
            const monthName = new Date(year, month - 1).toLocaleDateString('es-AR', { month: 'long', year: 'numeric' });
           
            const title = `Reporte Salarial 6x2 - ${monthName}`;
           
            doc.setFontSize(16);
            doc.text(title, 14, 20);
           
            doc.setFontSize(10);
            doc.text(`Valor Hora Bruta: ${formatCurrency(appState.config.valorHora)}`, 14, 26);
            doc.text(`Desc. Afiliaci贸n: ${result.discountRate.toFixed(0)}%`, 14, 31);
            doc.text(`Horas Extra Reales: ${formatNumber(result.totalExtraHoursReal)}`, 14, 36);

            doc.autoTable({
                startY: 45,
                head: [['Total Horas Eq.', 'Bruto Total', 'Descuento', 'NETO FINAL']],
                body: [[
                    formatNumber(result.totalEquivalentHours, 2),
                    formatCurrency(result.totalBruto),
                    formatCurrency(result.totalDescuento),
                    formatCurrency(result.totalNeto),
                ]],
                theme: 'striped',
                headStyles: { fillColor: [55, 48, 163] },
                columnStyles: {
                    0: { fontStyle: 'bold' },
                    3: { fontStyle: 'bold', fillColor: [187, 247, 208] },
                },
                styles: { fontSize: 10 }
            });

            const finalY = doc.autoTable.previous.finalY;
            doc.setFontSize(12);
            doc.text('Detalle Diario de Horas y Turnos', 14, finalY + 15);
           
            const tableData = result.dailyResults.map(d => [
                d.date,
                d.day.substring(0, 3),
                d.turn,
                appState.manualHolidays[d.date] === true ? 'S铆' : 'No',
                formatNumber(d.equivHoursBase, 2),
                d.extraReal > 0 ? formatNumber(d.extraReal, 1) : '',
                formatNumber(d.equivHoursFinal, 2),
                formatCurrency(d.dailyBruto)
            ]);
           
            doc.autoTable({
                startY: finalY + 20,
                head: [['Fecha', 'D铆a', 'Turno', 'Feriado?', 'H. Eq. Base', 'H. Extra (R)', 'H. Eq. Total', 'Monto Bruto']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [75, 85, 99] },
                columnStyles: {
                    4: { halign: 'right' },
                    5: { halign: 'center' },
                    6: { halign: 'right', fontStyle: 'bold' },
                    7: { halign: 'right', fontStyle: 'bold' },
                },
                didParseCell: (data) => {
                    const turn = data.row.raw[2];
                    const isHoliday = data.row.raw[3] === 'S铆';

                    if (turn.includes('Franco') && !isHoliday) {
                        data.cell.styles.fillColor = [255, 251, 235];
                    }
                    if (isHoliday) {
                        data.cell.styles.fontStyle = 'bold';
                        data.cell.styles.textColor = [185, 28, 28];
                        data.cell.styles.fillColor = [254, 226, 226];
                    }
                },
                styles: { fontSize: 8 }
            });

            doc.save(`Reporte_6x2_${monthName.replace(/\s/g, '_')}.pdf`);
        }
       
        // =====================================================================
        // INICIO DE LA APLICACIN
        // =====================================================================
       
        window.onload = () => {
            updateUIFromState();
            initFirebase();
        };

    </script>
</body>
</html>
